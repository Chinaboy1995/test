define("func/hjcx",["leaflet","func/base","control/panel","plugins/mcscroll","data/ajax","func/userLogin"],function(e){e.Class.HJCXBase=e.Class.extend({initialize:function(){this.util=e.ict.app.util,this.ictmap=e.ict.app.ictmap,this.ajax=new e.ICT.Ajax,this.config=Project_ParamConfig.hjcxConfig,this._hjcxLayerGroup=null,this._hjcxlayerarr={}},addHjLayerGroup:function(t){this._hjcxLayerGroup=e.featureGroup().addTo(this.ictmap.map);var n=t.msg.shipList;for(var r=0,i=n.length;r<i;r++){var s=n[r],o=s.num,u=s.posList,a=[],f=[],l=null,c=null,h=null;for(var p=0,d=u.length;p<d;p++){var v=this.convertShipObj(u[p]);v.mmsi=o;var m=e.latLng(v.lat,v.lon);f.push(m);var g=this.createHjPoint(v);a.push(g);if(p===0){var y=this.convertShipObj(u[0]),b=e.latLng(y.lat,y.lon);if(d>=2){var w=this.convertShipObj(u[1]),E=e.latLng(w.lat,w.lon);h=this.createCloseMarker(b,E,o)}else h=this.createCloseMarker(b,null,o)}p===d-1&&(c=this.createShipMarker(v))}f.length>=2&&(l=this.createHjLine(f),a.unshift(l)),c&&a.push(c),h&&a.push(h);if(a.length>0){this._hjcxlayerarr[o]=a;for(var S=0,x=a.length;S<x;S++)this._hjcxLayerGroup.addLayer(a[S]);r===0&&c&&this.ictmap.map.panTo(c.getLatLng())}}},convertShipObj:function(e){var t={};return t.dir=e.co/10,t.heading=e.he,t.lat=parseFloat(e.la/6e5),t.lon=parseFloat(e.lo/6e5),t.speed=e.sp/10,t.time=e.ti,t},removeLayerGroup:function(){this._hjcxLayerGroup&&(this._hjcxLayerGroup.clearLayers(),this._hjcxLayerGroup=null)},createHjPoint:function(t){var n=e.latLng(t.lat,t.lon),r={radius:4,stroke:!1,fill:!0,fillColor:"#f00",opacity:1,fillOpacity:1,renderer:e.svg(),data:t},i=e.circleMarker(n,r),s=this.getTiptitle(t),o=this.getTipOptions();return i.bindTooltip(s,o).openTooltip(),i},getTiptitle:function(t){var n=$.i18n.prop("common_ship_speed_unit"),r=$.i18n.prop("common_ship_lng"),i=$.i18n.prop("common_ship_lat"),s=$.i18n.prop("common_time_info1"),o=$.i18n.prop("common_ship_dir"),u=$.i18n.prop("common_ship_speed"),a=$.i18n.prop("common_ship_heading"),f=this.util.dateTime.getTimeStrFromUnix(t.time),l=this.util.tool.latlngTodfmStr(t.lat,"lat"),c=this.util.tool.latlngTodfmStr(t.lon,"lng"),h=e.latLng(t.lat,t.lon),p=t.dir,d=t.heading,v=t.speed,m="";return m+="MMSI:"+t.mmsi+"<br>",m+=r+c+"<br>",m+=i+l+"<br>",m+=s+f+"<br>",m+=o+p+"°<br>",m+=a+d+"°<br>",m+=u+v+" "+n,m},getTipOptions:function(){return{offset:[0,0],direction:"top",permanent:!1,opacity:.8,className:"realtarget-label-target"}},createShipMarker:function(t){var n=e.latLng(t.lat,t.lon),r={icon:e.ICT.ShipIcon.ship7,rotationAngle:t.dir,data:t},i=e.marker(n,r),s=this.getTiptitle(t),o=this.getTipOptions();return i.bindTooltip(s,o).openTooltip(),i},getPopupContent:function(e){var t=$.i18n.prop("common_ship_country"),n=$.i18n.prop("common_ship_speed_unit"),r=$.i18n.prop("common_ship_lng"),i=$.i18n.prop("common_ship_lat"),s=$.i18n.prop("common_time_info1"),o=$.i18n.prop("common_ship_heading"),u=$.i18n.prop("common_ship_speed"),a=this.util.tool.latlngTodfmStr(e.lat,"lat"),f=this.util.tool.latlngTodfmStr(e.lon,"lng"),l=this.util.dateTime.getTimeStrFromUnix(e.time),c=[];return c.push('<div class="displayctr_div" style="padding:5px;">'),c.push("<table>"),c.push("<tr><td>"+t+"</td><td>"+e.country+"</td></tr>"),c.push("<tr><td>"+o+"</td><td>"+e.heading+"°"+"</td></tr>"),c.push("<tr><td>"+r+"</td><td>"+f+"</td></tr>"),c.push("<tr><td>"+i+"</td><td>"+a+"</td></tr>"),c.push("<tr><td>"+u+"</td><td>"+e.speed+n+"</td></tr>"),c.push("<tr><td>"+s+"</td><td>"+l+"</td></tr>"),c.push("</table>"),c.push("</div>"),c.join("")},createHjLine:function(t){var n={opacity:1,fillOpacity:1},r=e.polyline(t,n);return r},createCloseMarker:function(t,n,r){var i=e.icon({iconUrl:"themes/images/shipIcons/hjxs_close.png",iconSize:[18,18],iconAnchor:[28,14]});n&&n.lng<t.lng&&(i=e.icon({iconUrl:"themes/images/shipIcons/hjxs_close.png",iconSize:[18,18],iconAnchor:[-9,14]}));var s={icon:i,id:r,opacity:1},o=e.marker(t,s);return o.on("click",this._markerCloseClickEvt,this),o},_markerCloseClickEvt:function(t){var n=t.target,r=n.options.id;this.removeLayerGroup(),this.ictmap.realtarget.showRealTargetLayer(),this.ictmap.OperateState.hjcx=!1,e.ict.app.menu.mainmenu.enableMenu(),this.config.hjcxList=[]},removeLayerById:function(e){var t=this._hjcxlayerarr[e];for(var n=0,r=t.length;n<r;n++)this._hjcxLayerGroup.removeLayer(t[n]);delete this._hjcxlayerarr[e]}}),e.ICT.Func.add("HJCXMoreShip",{Class:e.Class.HJCXBase.extend({initialize:function(){this.dateUtil=e.ict.app.util.dateTime,this.menu=e.ict.app.menu,this.menuid="ict_menu_main_hjcx",this._popPanel=null,e.Class.HJCXBase.prototype.initialize.apply(this,arguments)},start:function(){this.menu.mainmenu.deactiveMenuExceptOne(this.menuid);if(!e.ICT.Func.UserLogin.getInstance().isLogin()){e.ICT.Func.UserLogin.getInstance().alertLoginDialog(),this.menu.mainmenu.deactiveMenu(this.menuid);return}if(this._popPanel)return;this._initUI(),this._initEvts()},stop:function(){this.menu.mainmenu.deactiveMenu(this.menuid),this._popPanel&&this._popPanel.remove(!1),this.ictmap.OperateState.hjcx&&(this.ictmap.OperateState.hjcx=!1,this.ictmap.realtarget.showRealTargetLayer()),this.removeLayerGroup(),this.config.hjcxList=[],this._popPanel=null},_initUI:function(){var t={title:$.i18n.prop("func_hjcx_title"),width:400,height:470,top:100,left:200,contentHTML:this.getContentHTML()},n=this._popPanel=new e.ICT.PopPanel(t);this._popPanel.on("popPanelRemove",function(){this._popPanel=null,this.stop()},this),n.show(),this.updateList()},_initEvts:function(){var t=this._popPanel.getContainer().find(".hjcx_more_Container"),n=t.find(".msg1"),r=t.find(".msg2"),i=this;t.find(".func_tshf_zdmb_ship").html($.i18n.prop("func_tshf_zdmb_ship")),t.find(".func_tshf_zdmb_search_placeholder").attr("placeholder",$.i18n.prop("func_tshf_zdmb_search_placeholder")),t.find(".func_tshf_zdmb_addbtn").html($.i18n.prop("func_tshf_zdmb_addbtn")),t.find(".func_tshf_zdmb_cblb").html($.i18n.prop("func_tshf_zdmb_cblb")),t.find(".func_tshf_zdmb_allchk").html($.i18n.prop("func_tshf_zdmb_allchk")),t.find(".func_tshf_zdmb_delete").html($.i18n.prop("func_tshf_zdmb_delete")),t.find(".func_tshf_zdmb_shipname").html($.i18n.prop("func_tshf_zdmb_shipname")),t.find(".common_time_info1").html($.i18n.prop("common_time_info1")),t.find(".common_time_info2").html($.i18n.prop("common_time_info2")),t.find(".func_hjcx_okbtn").html($.i18n.prop("func_hjcx_okbtn")),t.find(".Wdate").on("focus",function(){var e={readOnly:!0,dateFmt:"yyyy-MM-dd HH",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0,lang:window.localStorage.getItem("language")==="en"?"en":"zh-cn",maxDate:"%y-%M-%d %H:%m:%s"};WdatePicker(e)});var s=this.dateUtil.getNewDateTimeBeforHour(24);s=this.dateUtil.formatDateH(s);var o=this.dateUtil.formatDateH(new Date);t.find(".Wdate.startTime").val(s),t.find(".Wdate.endTime").val(o),t.find(".addBtn").on("click",function(e){var r=t.find(".shipIMO").val().trim();n.text("");if(r==""){n.text($.i18n.prop("func_hjcx_mmsi"));return}var s=i.config.getShipByMMSIUrl,o={msi:r};i.ajax.post(s,o,!0,this,function(e){if(e.state!==1)console.error(e.msg.error),n.text($.i18n.prop("func_tshf_zdmb_error_search1"));else{var r=i.ictmap.realtarget.convertshipInfoObj(e.msg.searchShip);i.addTarget(r),i.updateList(),t.find(".shipIMO").val("")}})}),t.find(".deleteBtn").on("click",function(e){var n=t.find(".listContent input:checked");n.each(function(){var e=$(this).parent().parent().data("key");i.deleteTarget(e)}),i.updateList()}),t.find("input.allchk").on("click",function(e){var n=t.find(".listContent input[type=checkbox]");this.checked==1?n.each(function(){this.checked=!0}):n.each(function(){this.checked=!1})}),t.find(".hjcxBtn").on("click",function(n){r.text("");var s=t.find(".listContent input:checked"),o=[];s.each(function(){var e=$(this).parent().parent().data("key"),t=i.getTargetById(e);t&&o.push(t)});if(o.length<=0){r.text($.i18n.prop("func_hjcx_target"));return}var u=t.find(".startTime").val(),a=t.find(".endTime").val(),f=i.dateUtil.checkStrartEndTime(u+":00:00",a+":00:00",i.config.timerange);if(!f.result){r.text(f.msg);return}u=i.dateUtil.getCusUnixTime(u+":00:00"),a=i.dateUtil.getCusUnixTime(a+":00:00");var l=i.config.hjcxMoreUrl,c={},h=[];for(var p=0;p<o.length;p++)h.push(o[p].id);c.shipIdArr=h.join("~"),c.startTime=u,c.endTime=a,i.ajax.post(l,c,!0,i,function(t){i.config.hjcxList=[];if(t.state!=1)console.error(t.msg.error),r.text($.i18n.prop("func_hjcx_error"));else{if(!i._popPanel)return;i._popPanel.close(),i.ictmap.realtarget.hideRealTargetLayer(),i.ictmap.OperateState.hjcx=!0,e.ict.app.menu.mainmenu.disableMenu(),i.removeLayerGroup(),i.addHjLayerGroup(t)}},function(e){})})},_markerCloseClickEvt:function(t){e.Class.HJCXBase.prototype._markerCloseClickEvt.call(this,t),this.stop()},addTarget:function(e){if(this.config.hjcxList.length==0)this.config.hjcxList.push(e);else{isadd=!0;for(var t=0,n=this.config.hjcxList.length;t<n;t++)if(this.config.hjcxList[t].id==e.id){isadd=!1;break}isadd&&this.config.hjcxList.push(e)}},deleteTarget:function(e){var t=this.config.hjcxList,n=null;for(var r=0,i=t.length;r<i;r++)if(t[r].id==e){n=r;break}n!==null&&t.splice(n,1)},getTargetById:function(e){var t=this.config.hjcxList,n=null;for(var r=0,i=t.length;r<i;r++)if(t[r].id==e){n=t[r];break}return n},updateList:function(){var e=this._popPanel.getContainer().find(".hjcx_more_Container"),t=e.find(".listContent"),n=this.config.hjcxList,r=[];r.push('<div class="mscroll"><table>');for(var i=0,s=n.length;i<s;i++){var o=n[i].id,u=n[i].mmsi,a=n[i].shipname;r.push("<tr>"),r.push('<td class="mmsi" data-key="'+o+'"><label><input type="checkbox" checked>'+"&nbsp&nbsp"+u+"</label></td><td>"+a+"</td>"),r.push("</tr>")}r.push("</table></div>"),r=r.join(""),t.html(r),t.find(".mscroll").mCustomScrollbar({theme:"minimal-dark"})},getContentHTML:function(){var e=[];return e.push('<div class="hjcx_more_Container">'),e.push('  <div class="cbphDiv">'),e.push('    <label class="func_tshf_zdmb_ship">船舶:</label>'),e.push('    <input type="text" class="shipIMO func_tshf_zdmb_search_placeholder">'),e.push('    <button class="btn addBtn func_tshf_zdmb_addbtn">添加</button>'),e.push("  </div>"),e.push('  <p class="msg msg1"></p>'),e.push('  <p class="cblb_txt func_tshf_zdmb_cblb">船舶列表:</p>'),e.push('  <div class="phlbDiv">'),e.push('    <input type="checkbox" class="allchk" checked><label class="func_tshf_zdmb_allchk">全选</label>'),e.push('    <button class="btn deleteBtn func_tshf_zdmb_delete">删除</button>'),e.push("  </div>"),e.push('  <div class="shiplist">'),e.push('    <div><table><tr><td>MMSI</td><td class="func_tshf_zdmb_shipname">船舶名</td></tr></table></div>'),e.push("    <hr>"),e.push('    <div class="listContent"></div>'),e.push("  </div>"),e.push('  <p class="msg msg2"></p>'),e.push("  <hr>  "),e.push('  <div class="timeDiv"><label class="common_time_info1">时间:</label> <input type="text" class="Wdate startTime"> &nbsp<label class="common_time_info2">至</label>&nbsp<input type="text" class="Wdate endTime"></div>'),e.push('  <div class="btnDiv"><button type="button" class="hjcxBtn func_hjcx_okbtn">查询</button></div>'),e.push("</div>"),e.join("")}})}),e.ICT.Func.add("HJCXOneShip",{Class:e.Class.HJCXBase.extend({initialize:function(){this.config=Project_ParamConfig.hjcxConfig,this.dateUtil=e.ict.app.util.dateTime,this._popPanel=null,e.Class.HJCXBase.prototype.initialize.apply(this,arguments)},start:function(){this._popPanel&&this._popPanel.remove(),this._initUi(),this._initEvts()},stop:function(){this._popPanel&&this._popPanel.remove(),this.removeLayerGroup(),this.ictmap.OperateState.hjcx=!1},_initUi:function(){var t={title:$.i18n.prop("func_hjcx_title"),width:400,height:160,contentHTML:this.getContentHtml()},n=this._popPanel=new e.ICT.PopPanel(t);n.show()},getContentHtml:function(){var e=[];return e.push('<div class="hjcx_oneship_container">'),e.push('<div class="timeDiv">'),e.push('<label class="common_time_info1">时间：</label>'),e.push('<input type="text" class="Wdate startTime">'),e.push('&nbsp<label class="common_time_info2"> 至</label> &nbsp'),e.push('<input type="text" class="Wdate endTime">'),e.push("</div>"),e.push('<p class="msg"></p>'),e.push('<div class="btnDiv">'),e.push('<button type="button" class="confirm common_btn_ok">确定</button>'),e.push('<button type="button" class="cancel common_btn_cancel">取消</button>'),e.push("</div>"),e.push("</div>"),e.join("")},_initEvts:function(){var t=this._popPanel.getContainer().find(".hjcx_oneship_container"),n=t.find(".msg"),r=this;t.find(".common_time_info1").html($.i18n.prop("common_time_info1")),t.find(".common_time_info2").html($.i18n.prop("common_time_info2")),t.find(".common_btn_ok").html($.i18n.prop("common_btn_ok")),t.find(".common_btn_cancel").html($.i18n.prop("common_btn_cancel")),this._popPanel.on("popPanelRemove",function(){this._popPanel=null},this),t.find(".Wdate").on("focus",function(){var e={readOnly:!0,dateFmt:"yyyy-MM-dd HH",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0,lang:window.localStorage.getItem("language")==="en"?"en":"zh-cn",maxDate:"%y-%M-%d %H:%m:%s"};WdatePicker(e)});var i=this.dateUtil.getNewDateTimeBeforHour(24);i=this.dateUtil.formatDateH(i);var s=this.dateUtil.formatDateH(new Date);t.find(".Wdate.startTime").val(i),t.find(".Wdate.endTime").val(s),t.find(".confirm").on("click",function(){n.text("");var i=t.find(".startTime").val(),s=t.find(".endTime").val(),o=r.dateUtil.checkStrartEndTime(i+":00:00",s+":00:00",r.config.timerange);if(!o.result){n.text(o.msg);return}i=r.dateUtil.getCusUnixTime(i+":00:00"),s=r.dateUtil.getCusUnixTime(s+":00:00");var u=r.config.hjcxMoreUrl,a=r.ictmap.realtarget.currentTarget.options.data.id,f={shipIdArr:a,startTime:i,endTime:s};r.ajax.post(u,f,!0,r,function(t){if(t.state!==1)console.error(t.msg.error),n.text($.i18n.prop("func_hjcx_error"));else{if(!r._popPanel)return;r._popPanel.remove(),r.ictmap.OperateState.hjcx=!0,e.ict.app.menu.mainmenu.disableMenu(),r.ictmap.realtarget.hideRealTargetLayer(),r.removeLayerGroup(),r.addHjLayerGroup(t)}},function(e){})}),t.find(".cancel").on("click",function(){r.stop()})}})})});