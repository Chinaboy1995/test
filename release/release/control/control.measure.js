define("control/measure",["leaflet","leaflet/draw","core/namespace"],function(e){e.ICT=e.ICT||{},e.ICT.Measure=e.ICT.Measure||{},e.ICT.Measure.Length=e.Draw.Polyline.extend({options:{repeatMode:!1,icon:new e.DivIcon({iconSize:new e.Point(8,8),className:"ict_measure_vetixicon"}),touchIcon:new e.DivIcon({iconSize:new e.Point(8,8),className:"ict_measure_vetixicon"}),shapeOptions:{stroke:!0,color:"#116cc1",weight:2,opacity:1,fill:!1,clickable:!0},metric:!1,feet:!1,nautic:!0,showLength:!0,closeIcon:e.icon({iconUrl:"themes/images/shipIcons/hjxs_close.png",iconSize:[18,18],iconAnchor:[-9,14],className:"ict_measure_closeicon"})},initialize:function(t,n){e.Draw.Polyline.prototype.initialize.call(this,t,n)},addHooks:function(){e.Draw.Polyline.prototype.addHooks.call(this),this._map&&(this._infomarkerGroup=new e.LayerGroup,this._map.addLayer(this._infomarkerGroup),this._measurelens=[],this._closemarker=null)},removeHooks:function(){e.Draw.Feature.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._cleanUpShape(),this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseout",this._onMouseOut,this).off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this).off("zoomlevelschange",this._onZoomEnd,this).off("zoomend",this._onZoomEnd,this).off("touchstart",this._onTouch,this).off("click",this._onTouch,this)},_endPoint:function(t,n,r){if(this._mouseDownOrigin){var i=e.point(t,n).distanceTo(this._mouseDownOrigin),s=this._calculateFinishDistance(r.latlng),o=this._calculateFinishDistance2(r.latlng);s!==Infinity&&o!==Infinity&&this._measurelens.push(o),s<10&&e.Browser.touch?(this._finishShape(),this._createCloseICon(r)):Math.abs(i)<9*(window.devicePixelRatio||1)&&(this.addVertex(r.latlng),this._createInfoICon(r)),this._enableNewMarkers()}this._mouseDownOrigin=null},_createMarker:function(t){var n=e.ict.app.util.tool.latlngTodfmStr(t.lat,"lat"),r=e.ict.app.util.tool.latlngTodfmStr(t.lng,"lng"),i="经度："+r+"，"+"纬度："+n,s=new e.Marker(t,{icon:this.options.icon,title:i,zIndexOffset:this.options.zIndexOffset*2});return this._markerGroup.addLayer(s),s},_calculateFinishDistance2:function(t){var n;if(this._markers.length>0){var r;if(this.type===e.Draw.Polyline.TYPE)r=this._markers[this._markers.length-1];else{if(this.type!==e.Draw.Polygon.TYPE)return Infinity;r=this._markers[0]}var i=r.getLatLng(),s=new e.Marker(t,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset*2}),o=s.getLatLng();n=i.distanceTo(o),n=e.GeometryUtil.readableDistance(n,this.options.metric,this.options.feet,this.options.nautic)}else n=Infinity;return n},clear:function(){this._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this._map.removeLayer(this._poly),delete this._poly,this._map.removeLayer(this._infomarkerGroup),delete this._infomarkerGroup,this._map.removeLayer(this._closemarker),delete this._closemarker,delete this._measurelens},_createInfoICon:function(t){if(this._markers&&this._markers.length<=1)return;var n=t.latlng,r=e.divIcon({iconAnchor:[-2,-2],className:"ict_measure_infoIcon",html:this._getSum()+"nm"}),i=e.marker(n,{icon:r});this._infomarkerGroup.addLayer(i)},_createCloseICon:function(t){var n=t.latlng,r=this._closemarker=e.marker(n,{icon:this.options.closeIcon});this._map.addLayer(r),r.on("click",function(){this.clear()},this)},_getSum:function(){var e=0;for(var t=0,n=this._measurelens.length;t<n;t++)e+=parseFloat(this._measurelens[t]);return e.toFixed(2)}})});