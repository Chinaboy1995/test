define("func/keysearch",["leaflet","func/base","data/ajax","plugins/mcscroll","control/paging","control/panel","func/userLogin"],function(e){e.ICT.Func.add("KeySearch",{Class:e.Class.extend({initialize:function(){this.dialog=e.ict.app.util.dialog,this.ajax=new e.ICT.Ajax,this.config=Project_ParamConfig.SearchConfig,this.ictmap=e.ict.app.ictmap,this.perPageCount=9,this._respopPanel=null,this._container=null},start:function(t){if(!e.ICT.Func.UserLogin.getInstance().isLogin()){e.ICT.Func.UserLogin.getInstance().alertLoginDialog();return}this.stop(),this.param=t;if(this.param.searchText==""){this.param.searchType==="1"?this.dialog.warn($.i18n.prop("dialog_alert_title"),$.i18n.prop("func_keysearch_ship_error1")):this.param.searchType==="2"&&this.dialog.warn($.i18n.prop("dialog_alert_title"),$.i18n.prop("func_keysearch_port_error1"));return}var n=this.param.searchType;if(n==="1"){var r=4;this.shipSearch(r)}else n==="2"&&this.portSearch()},stop:function(){this._respopPanel&&this._respopPanel.remove(!1),this._respopPanel=this._container=null,this.ictmap.realtarget.clearLocatLyr()},shipSearch:function(e){this.curPage=1,this.ajaxCount=0,this.data={type:e,num:this.param.searchText,pageid:this.curPage,pagecount:this.perPageCount},this.searchAjax(this.data)},searchAjax:function(e){var t=this.config.shipSearchUrl;this.ajax.post(t,e,!0,this,function(e){this.ajaxCount++,e.state!==1?(console.error(e.msg.error),this.dialog.warn($.i18n.prop("dialog_alert_title"),$.i18n.prop("func_keysearch_ship_error2"))):this.showSearchResult(e)},function(e){this.ajaxCount++})},showSearchResult:function(e){var t=this,n=this.getTableHtml(e);this.ajaxCount==1?(this._initRespopPanel(e),this._initResEvts(e)):(this._container.find(".searchTableContainer").html(n),this._container.find(".searchTableContainer").find(".mscrollbar").mCustomScrollbar({theme:"minimal-dark",axis:"yx"}),this._container.find(".searchTableContainer").find("table tr").on("click",function(e){t._clickRowEvt(e)}))},_initRespopPanel:function(t){var n={title:$.i18n.prop("func_keysearch_res_title",t.msg.total),width:290,height:280,left:345,top:60,isDrag:!1};n.contentHTML=this._container=$(this.getResContentHtml(t)),this._respopPanel=(new e.ICT.PopPanel(n)).show(),this._respopPanel.on("popPanelRemove",function(){this._container=null,this._respopPanel=null,this.stop()},this)},_initResEvts:function(t){var n=this,r={total:t.msg.max_page,count:5,present:this.curPage};r.pageChange=function(e){n.curPage=e,n.data.pageid=n.curPage,n.searchAjax(n.data)};var i=new e.ICT.Control.Paging(r);i.addTo(this._container.find(".pageContainer")[0]),this._container.find("table tr").on("click",function(e){n._clickRowEvt(e)}),this._container.find(".mscrollbar").mCustomScrollbar({theme:"minimal-dark",axis:"yx"})},getTableHtml:function(e){var t=[],n=e.msg.shipList;t.push('<div class="mscrollbar"><table>');for(var r=0,i=n.length;r<i;r++){var s=this.convertOneTargetFromObj(n[r]),o=s.id,u=$.i18n.prop("common_ship_shipname");t.push('<tr data-id="'+o+'">'),t.push("<td>MMSI:"+s.mmsi+"</td>"),t.push("<td>"+u+s.sn+"</td>"),t.push("<td>IMO:"+s.imo+"</td>"),t.push("</tr>")}return t.push("</table></div>"),t.join("")},getResContentHtml:function(e){var t=[],n=e.msg.shipList;return t.push('<div class="searchResContainer">'),t.push('<div class="searchTableContainer" >'),t.push(this.getTableHtml(e)),t.push("</div>"),t.push('<div class="pageContainer"></div>'),t.push("</div>"),t.join("")},convertOneTargetFromObj:function(e){var t={};return t.mmsi=e.mmsi,t.imo=e.imo,t.sn=e.sn.replace(/@/g,""),t.id=e.mmsi,t.mode=e.mode,t},_clickRowEvt:function(e){$(e.currentTarget).addClass("active").siblings().removeClass("active");var t=$(e.currentTarget).data("id"),n={};n.shipid=t,this.ictmap.realtarget.locateShip(n)},portSearch:function(){var e=this.config.portSearchUrl,t={portname:this.param.searchText};this.ajax.post(e,t,!0,this,function(e){e.state!==1?(console.error(e.msg),this.dialog.error($.i18n.prop("dialog_alert_title"),$.i18n.prop("func_keysearch_port_error2"))):this.showPortSearchRes(e)},function(e){})},showPortSearchRes:function(t){var n={title:$.i18n.prop("func_keysearch_res_title",t.msg.limit),width:290,height:280,left:345,top:60,isDrag:!1};n.contentHTML=this._container=$(this.getPortResContentHtml(t)),this._respopPanel=(new e.ICT.PopPanel(n)).show(),this._respopPanel.on("popPanelRemove",function(){this._container=null,this._respopPanel=null},this);var r=this;this._container.find(".mscrollbar").mCustomScrollbar({theme:"minimal-dark"}),this._container.find("table tr").on("click",function(e){$(e.currentTarget).addClass("active").siblings().removeClass("active");var t=$(e.currentTarget).data("id");r.ictmap.portlayer.locateByPortId(t)})},getPortResContentHtml:function(e){var t=[],n=e.msg.portNames;t.push('<div class="searchResContainer">'),t.push('<div class="searchTableContainer" >'),t.push('<div class="mscrollbar"><table>');for(var r=0,i=n.length;r<i;r++){var s=n[r],o=s.id,u=s.pn,a=$.i18n.prop("port_info_name"),f=a+u;t.push('<tr data-id="'+o+'"><td>'+f+"</td></tr>")}return t.push("</table></div>"),t.push("</div>"),t.push("</div>"),t.join("")}})})});