define("func/tshf",["leaflet","func/base","control/panel","control/draw","control/playback","control/loading","plugins/mcscroll","data/ajax","func/userLogin"],function(e){e.ICT.Func.add("TSHF",{Class:e.Class.extend({initialize:function(){this.menu=e.ict.app.menu,this.menuid="ict_menu_main_tshf",this.config=Project_ParamConfig.tshfConfig,this.ictmap=e.ict.app.ictmap,this.dateUtil=e.ict.app.util.dateTime,this.ajax=new e.ICT.Ajax,this._areaPanel=null,this._targetPanel=null,this._drawPopPanel=null,this._layer=null,this._playback=null},start:function(){this.menu.mainmenu.deactiveMenuExceptOne(this.menuid),this.menu.submenu.has(this.menuid)||this.menu.submenu.add(this.menuid,this.getSubMenuHTML()),this.menu.submenu.show(this.menuid),this._initSubMenuEvts()},stop:function(){this._areaPanel&&this._areaPanel.remove(!1),this._targetPanel&&this._targetPanel.remove(!1),this._drawPopPanel&&this._drawPopPanel.remove(!1),this._layer&&this._layer.remove(),this._areaPanel=null,this._targetPanel=null,this._drawPopPanel=null,this._layer=null,this.ictmap.deactivate(),this.menu.submenu.destory(this.menuid),this.menu.mainmenu.deactiveMenu(this.menuid)},getSubMenuHTML:function(){var e=[];return e.push('<ul class="submenu_tshf">'),e.push('<li class="menu_item zdqy"><img src="themes/images/frame/menu_tshf_zdqy.png">&nbsp<label class="func_tshf_zdqy">指定区域</label></li>'),e.push('<li class="menu_item zdmb"><img src="themes/images/frame/menu_tshf_zdmb.png">&nbsp<label class="func_tshf_zdmb">指定目标</label></li>'),e.push("</ul>"),e.join("")},_initSubMenuEvts:function(){var t=this,n=this.menu.getContainer();n.find(".func_tshf_zdqy").html($.i18n.prop("func_tshf_zdqy")),n.find(".func_tshf_zdmb").html($.i18n.prop("func_tshf_zdmb")),n.find(".submenu_tshf .menu_item").on("click",function(n){n.stopPropagation();if(!e.ICT.Func.UserLogin.getInstance().isLogin()){e.ICT.Func.UserLogin.getInstance().alertLoginDialog(),t.menu.mainmenu.deactiveMenu(t.menuid);return}var r=$(this);r.hasClass("zdqy")?(t._areaPanel&&(t._areaPanel.remove(!1),t._areaPanel=null),t.areaPlayback(),t.menu.submenu.hide()):r.hasClass("zdmb")&&(t._targetPanel&&(t._targetPanel.remove(!1),t._targetPanel=null),t.targetPlayback(),t.menu.submenu.hide())})},areaPlayback:function(){var t={title:$.i18n.prop("func_tshf_zdqy"),width:400,height:270,top:100,left:200,contentHTML:this.getAreaHtml()},n=this._areaPanel=new e.ICT.PopPanel(t);this._areaPanel.on("popPanelRemove",function(){this._areaPanel=null,this.stop()},this),n.show(),this._initAreaEvts(),this.ictmap.activate(e.ICT.MapMouseState.CIRCLE,this._drawCallback,null,this)},_initAreaEvts:function(){var t=this._areaPanel.getContainer().find(".areaPlaybackContainer"),n=t.find(".msg"),r=this;t.find(".common_draw_title").html($.i18n.prop("common_draw_title")),t.find(".common_draw_circle").html($.i18n.prop("common_draw_circle")),t.find(".common_draw_rect").html($.i18n.prop("common_draw_rect")),t.find(".common_time_info1").html($.i18n.prop("common_time_info1")),t.find(".common_time_info2").html($.i18n.prop("common_time_info2")),t.find(".func_tshf_okbtn").html($.i18n.prop("func_tshf_okbtn")),this._loading=(new e.ICT.Control.Loading).addTo(this._areaPanel.getContainer().find(".container-content")),t.find("input[type=radio]").on("click",function(t){r._layer&&(r._layer.remove(),r._layer=null),r._drawPopPanel&&(r._drawPopPanel.remove(),r._drawPopPanel=null);var n=$(this).val();n=="circle"?r.ictmap.activate(e.ICT.MapMouseState.CIRCLE,r._drawCallback,null,r):n=="rect"&&r.ictmap.activate(e.ICT.MapMouseState.RECTANGLE,r._drawCallback,null,r)}),t.find("input[type=text]").on("focus",function(){var e={readOnly:!0,dateFmt:"yyyy-MM-dd HH",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0,maxDate:"%y-%M-%d %H:%m:%s",lang:window.localStorage.getItem("language")==="en"?"en":"zh-cn"};WdatePicker(e)});var i=this.dateUtil.getNewDateTimeBeforHour(24);i=this.dateUtil.formatDateH(i);var s=this.dateUtil.formatDateH(new Date);t.find(".Wdate.startTime").val(i),t.find(".Wdate.endTime").val(s),t.find(".playbackbtn").on("click",function(e){n.text("");if(!r.ictmap.map.hasLayer(r._layer)){n.text($.i18n.prop("common_draw_error1"));return}var i=t.find(".startTime").val(),s=t.find(".endTime").val(),o=r.dateUtil.checkStrartEndTime(i+":00:00",s+":00:00",r.config.timerange);if(!o.result){n.text(o.msg);return}i=r.dateUtil.getCusUnixTime(i+":00:00"),s=r.dateUtil.getCusUnixTime(s+":00:00");var u={},a=r._layer.getBounds();u.ldlon=a.getSouthWest().lng,u.ldlat=a.getSouthWest().lat,u.rulon=a.getNorthEast().lng,u.rulat=a.getNorthEast().lat,u.limit=r.config.limit,u.startTime=i,u.endTime=s;var f=r.config.areaUrl;r._loading.show(),r.ajax.post(f,u,!0,r,function(e){this._loading.hide(),e.state!==1?(console.error(e.msg.error),n.text($.i18n.prop("func_tshf_error"))):this.playBack(e)},function(e){this._loading.hide()})})},_drawCallback:function(t){var n=this._layer=t.layer,r=t.layerType;this._drawPopPanel&&this._drawPopPanel.remove(),this._drawPopPanel=new e.ICT.DrawPopPanel(n,r),this._drawPopPanel.on("popPanelRemove",function(){this._drawPopPanel=null},this),this._drawPopPanel.show(),this.ictmap.map.addLayer(n),this._layer=n,n.editing&&(n.editing.enable(),n.on("edit",function(e){this._drawPopPanel.updateContent()},this))},targetPlayback:function(){var t={title:$.i18n.prop("func_tshf_zdmb"),width:400,height:470,top:100,left:200,contentHTML:this.getTargetHtml()},n=this._targetPanel=new e.ICT.PopPanel(t);this._targetPanel.on("popPanelRemove",function(){this._targetPanel=null,this.config.playbackList=[],this.stop()},this),n.show(),this.updateList(),this._initTargetEvts()},_initTargetEvts:function(){var e=this._targetPanel.getContainer().find(".playbackTargetContainer"),t=e.find(".msg1"),n=e.find(".msg2"),r=this;e.find(".func_tshf_zdmb_ship").html($.i18n.prop("func_tshf_zdmb_ship")),e.find(".func_tshf_zdmb_search_placeholder").attr("placeholder",$.i18n.prop("func_tshf_zdmb_search_placeholder")),e.find(".func_tshf_zdmb_addbtn").html($.i18n.prop("func_tshf_zdmb_addbtn")),e.find(".func_tshf_zdmb_cblb").html($.i18n.prop("func_tshf_zdmb_cblb")),e.find(".func_tshf_zdmb_allchk").html($.i18n.prop("func_tshf_zdmb_allchk")),e.find(".func_tshf_zdmb_delete").html($.i18n.prop("func_tshf_zdmb_delete")),e.find(".func_tshf_zdmb_shipname").html($.i18n.prop("func_tshf_zdmb_shipname")),e.find(".common_time_info1").html($.i18n.prop("common_time_info1")),e.find(".common_time_info2").html($.i18n.prop("common_time_info2")),e.find(".func_tshf_okbtn").html($.i18n.prop("func_tshf_okbtn")),e.find(".Wdate").on("focus",function(){var e={readOnly:!0,dateFmt:"yyyy-MM-dd HH",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0,maxDate:"%y-%M-%d %H:%m:%s",lang:window.localStorage.getItem("language")==="en"?"en":"zh-cn"};WdatePicker(e)});var i=this.dateUtil.getNewDateTimeBeforHour(24);i=this.dateUtil.formatDateH(i);var s=this.dateUtil.formatDateH(new Date);e.find(".Wdate.startTime").val(i),e.find(".Wdate.endTime").val(s),e.find(".addBtn").on("click",function(n){var i=e.find(".shipIMO").val();t.text("");if(i==""){t.text($.i18n.prop("func_tshf_zdmb_search_placeholder"));return}var s=r.config.getShipByMMSIUrl,o={msi:i};r.ajax.post(s,o,!0,this,function(e){if(e.state!==1)console.error(e.msg.error),t.text($.i18n.prop("func_tshf_zdmb_error_search1"));else{var n=r.ictmap.realtarget.convertshipInfoObj(e.msg.searchShip);r.addTarget(n),r.updateList()}})}),e.find(".deleteBtn").on("click",function(t){var n=e.find(".listContent input:checked");n.each(function(){var e=$(this).parent().parent().data("key");r.deleteTarget(e)}),r.updateList()}),e.find("input.allchk").on("click",function(t){var n=e.find(".listContent input[type=checkbox]");this.checked==1?n.each(function(){this.checked=!0}):n.each(function(){this.checked=!1})}),e.find(".playbackBtn").on("click",function(t){n.text("");var i=e.find(".listContent input:checked"),s=[];i.each(function(){var e=$(this).parent().parent().data("key"),t=r.getTargetById(e);s.push(t)});if(s.length<=0){n.text($.i18n.prop("func_tshf_zdmb_error_target"));return}var o=e.find(".startTime").val(),u=e.find(".endTime").val(),a=r.dateUtil.checkStrartEndTime(o+":00:00",u+":00:00",r.config.timerange);if(!a.result){n.text(a.msg);return}o=r.dateUtil.getCusUnixTime(o+":00:00"),u=r.dateUtil.getCusUnixTime(u+":00:00");var f=r.config.moreshipUrl,l={},c=[];for(var h=0;h<s.length;h++)c.push(s[h].id);l.shipIdArr=c.join("~"),l.startTime=o,l.endTime=u,r.ajax.post(f,l,!0,r,function(e){e.state!=1?(console.error(e.msg.error),n.text($.i18n.prop("func_tshf_error"))):this.playBack(e)},function(e){})})},addTarget:function(e){if(this.config.playbackList.length===0)this.config.playbackList.push(e);else{isadd=!0;for(var t=0,n=this.config.playbackList.length;t<n;t++)if(this.config.playbackList[t].id===e.id){isadd=!1;break}isadd&&this.config.playbackList.push(e)}},deleteTarget:function(e){var t=this.config.playbackList,n=null;for(var r=0,i=t.length;r<i;r++)if(t[r].id==e){n=r;break}n!==null&&t.splice(n,1)},getTargetById:function(e){var t=this.config.playbackList,n=null;for(var r=0,i=t.length;r<i;r++)if(t[r].id==e){n=t[r];break}return n},updateList:function(){var e=this._targetPanel.getContainer().find(".playbackTargetContainer"),t=e.find(".listContent"),n=this.config.playbackList,r=[];r.push('<div class="mscroll"><table>');for(var i=0,s=n.length;i<s;i++){var o=n[i].id,u=n[i].mmsi,a=n[i].shipname;r.push("<tr>"),r.push('<td class="mmsi" data-key="'+o+'"><label><input type="checkbox" checked>'+"&nbsp&nbsp"+u+"</label></td><td>"+a+"</td>"),r.push("</tr>")}r.push("</table></div>"),r=r.join(""),t.html(r),t.find(".mscroll").mCustomScrollbar({theme:"minimal-dark"})},playBack:function(t){this._targetPanel&&this._targetPanel.close(),this._areaPanel&&this._areaPanel.close(),this.ictmap.realtarget.hideRealTargetLayer(),this.config.playbackList=[],this._playback&&(this._playback.close(),this._playback=null),this.ictmap.OperateState.tshf=!0,this.menu.mainmenu.disableMenu();var n=this.ictmap.map.getZoom(),r=this.ictmap.map.getCenter();t=t.msg.shipList;var i=this;this._playback=(new e.ICT.Control.PlayBack(t,null,function(){i._playback=null,i.stop(),i.ictmap.map.setView(r,n),i.ictmap.OperateState.tshf=!1,i.menu.mainmenu.enableMenu(),i.ictmap.realtarget.addRealTargetLayer()},null)).show(this.ictmap.map)},getAreaHtml:function(){var e=[];return e.push('<div class="areaPlaybackContainer">'),e.push('<fieldset class="drawDiv">'),e.push('<legend class="common_draw_title">绘制区域：</legend> '),e.push('<form class="form-inline">'),e.push('<div class="form-group">'),e.push('<div class="radio"><input type="radio" name="drawRadio" value="circle" checked ><img src="themes/images/frame/ico_circle.png"><label class="common_draw_circle">圆形</label></div>'),e.push('<div class="radio"><input type="radio" name="drawRadio" value="rect"><img src="themes/images/frame/ico_rect.png"><label class="common_draw_rect">矩形</label></div>'),e.push("</div>"),e.push("</form>"),e.push("</fieldset>"),e.push('<div class="timeDiv">'),e.push('<label class="common_time_info1">时间:</label> <input type="text" class="Wdate startTime">&nbsp<label class="common_time_info2">至</label>&nbsp<input type="text" class="Wdate endTime"> '),e.push("</div>"),e.push('<p class="msg"></p>'),e.push('<div class="btnDiv"><button type="button" class="btn playbackbtn func_tshf_okbtn">回放</button></div>'),e.push("</div>"),e.join("")},getTargetHtml:function(){var e=[];return e.push('<div class="playbackTargetContainer">'),e.push('  <div class="cbphDiv">'),e.push('    <label class="func_tshf_zdmb_ship">船舶:</label>'),e.push('    <input type="text" class="shipIMO func_tshf_zdmb_search_placeholder">'),e.push('    <button class="btn addBtn func_tshf_zdmb_addbtn">添加</button>'),e.push("  </div>"),e.push('  <p class="msg msg1"></p>'),e.push('  <p class="cblb_txt func_tshf_zdmb_cblb">船舶列表:</p>'),e.push('  <div class="phlbDiv">'),e.push('    <input type="checkbox" class="allchk" checked><label class="func_tshf_zdmb_allchk">全选</label>'),e.push('    <button class="btn deleteBtn func_tshf_zdmb_delete">删除</button>'),e.push("  </div>"),e.push('  <div class="shiplist">'),e.push('    <div><table><tr><td>MMSI</td><td class="func_tshf_zdmb_shipname">船舶名</td></tr></table></div>'),e.push("    <hr>"),e.push('    <div class="listContent"></div>'),e.push("  </div>"),e.push('  <p class="msg msg2"></p>'),e.push("  <hr>  "),e.push('  <div class="timeDiv"><label class="common_time_info1">时间:</label> <input type="text" class="Wdate startTime"> &nbsp<label class="common_time_info2">至</label> &nbsp<input type="text" class="Wdate endTime"></div>'),e.push('  <div class="btnDiv"><button type="button" class="btn playbackBtn func_tshf_okbtn">回放</button></div>'),e.push("</div>"),e.join("")}})}),e.ICT.Func.add("TSHFOneShip",{Class:e.Class.extend({initialize:function(){this.config=Project_ParamConfig.tshfConfig,this.ictmap=e.ict.app.ictmap,this.dateUtil=e.ict.app.util.dateTime,this.ajax=new e.ICT.Ajax,this.menu=e.ict.app.menu,this._popPanel=null,this._playback=null},start:function(){this._popPanel&&this._popPanel.remove(),this._initUi(),this._initEvts()},stop:function(){this._popPanel&&this._popPanel.remove(),this._playback&&this._playback.close()},_initUi:function(){var t={title:$.i18n.prop("func_tshf_title"),width:400,height:160,contentHTML:this.getContentHtml()},n=this._popPanel=new e.ICT.PopPanel(t);this._popPanel.on("popPanelRemove",function(){this._popPanel=null},this),n.show()},getContentHtml:function(){var e=[];return e.push('<div class="tshf_oneship_container">'),e.push('<div class="timeDiv">'),e.push('<label class="common_time_info1">时间：</label>'),e.push('<input type="text" class="Wdate startTime">'),e.push('&nbsp<label class="common_time_info2">至 </label>&nbsp'),e.push('<input type="text" class="Wdate endTime">'),e.push("</div>"),e.push('<p class="msg"></p>'),e.push('<div class="btnDiv">'),e.push('<button type="button" class="confirm common_btn_ok">确定</button>'),e.push('<button type="button" class="cancel common_btn_cancel">取消</button>'),e.push("</div>"),e.push("</div>"),e.join("")},_initEvts:function(){var e=this._popPanel.getContainer().find(".tshf_oneship_container"),t=e.find(".msg"),n=this;e.find(".common_time_info1").html($.i18n.prop("common_time_info1")),e.find(".common_time_info2").html($.i18n.prop("common_time_info2")),e.find(".common_btn_ok").html($.i18n.prop("common_btn_ok")),e.find(".common_btn_cancel").html($.i18n.prop("common_btn_cancel")),e.find(".Wdate").on("focus",function(){var e={readOnly:!0,dateFmt:"yyyy-MM-dd HH",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0,maxDate:"%y-%M-%d %H:%m:%s",lang:window.localStorage.getItem("language")==="en"?"en":"zh-cn"};WdatePicker(e)});var r=this.dateUtil.getNewDateTimeBeforHour(24);r=this.dateUtil.formatDateH(r);var i=this.dateUtil.formatDateH(new Date);e.find(".Wdate.startTime").val(r),e.find(".Wdate.endTime").val(i),e.find(".confirm").on("click",function(){t.text("");var r=e.find(".startTime").val(),i=e.find(".endTime").val(),s=n.dateUtil.checkStrartEndTime(r+":00:00",i+":00:00",n.config.timerange);if(!s.result){t.text(s.msg);return}r=n.dateUtil.getCusUnixTime(r+":00:00"),i=n.dateUtil.getCusUnixTime(i+":00:00");var o=n.config.moreshipUrl,u=n.ictmap.realtarget.currentTarget.options.data.id,a={shipIdArr:u,startTime:r,endTime:i};n.ajax.post(o,a,!0,n,function(e){e.state!==1?(console.error(e.msg.error),t.text($.i18n.prop("func_tshf_error"))):n.playBack(e)},function(e){})}),e.find(".cancel").on("click",function(){n.stop()})},playBack:function(t){this._popPanel.remove(),this.ictmap.realtarget.hideRealTargetLayer(),this._playback&&(this._playback.close(),this._playback=null),this.ictmap.OperateState.tshf=!0,this.menu.mainmenu.disableMenu(),t=t.msg.shipList;var n=this.ictmap.map.getZoom(),r=this.ictmap.map.getCenter(),i=this;this._playback=(new e.ICT.Control.PlayBack(t,null,function(){i._playback=null,i.ictmap.OperateState.tshf=!1,i.ictmap.map.setView(r,n),i.menu.mainmenu.enableMenu(),i.ictmap.realtarget.addRealTargetLayer()},null)).show(this.ictmap.map)}})})});