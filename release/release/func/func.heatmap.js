define("func/heatmap",["leaflet","esri/leaflet","func/base","func/userLogin"],function(e){e.ICT.Func.add("HeatMap",{Class:e.Class.extend({initialize:function(){this.menu=e.ict.app.menu,this.menuid="ict_menu_main_rlt",this.ictmap=e.ict.app.ictmap,this.OverlayConfig=Project_ParamConfig.LayersConfig.OverlayDensity,this.ShipConfig=Project_ParamConfig.LayersConfig.ShipDensity,this.TrafficConfig=Project_ParamConfig.LayersConfig.TrafficDensity,this._layer=null},start:function(){this.menu.mainmenu.deactiveMenuExceptOne(this.menuid);if(!e.ICT.Func.UserLogin.getInstance().isLogin()){e.ICT.Func.UserLogin.getInstance().alertLoginDialog(),this.menu.mainmenu.deactiveMenu(this.menuid);return}this.ictmap.OperateState.heatmap=!0,this.ictmap.realtarget.hideRealTargetLayer(),this.menu.submenu.has(this.menuid)&&this.menu.submenu.destory(this.menuid),this.menu.submenu.add(this.menuid,this.getSubMenuHTML()),this.menu.submenu.show(this.menuid),this._initSubMenuEvts()},stop:function(){this.menu.submenu.destory(this.menuid),this.menu.mainmenu.deactiveMenu(this.menuid),this.removeLayer(),this.ictmap.OperateState.heatmap=!1,this.ictmap.realtarget.addRealTargetLayer()},getSubMenuHTML:function(){var e=[];e.push('<ul class="submenu_heatmap">'),e.push('<li class="submenu_heatmap_li">'),e.push('<img src="themes/images/frame/menu_glxs_cblx.png">&nbsp&nbsp<label class="func_heatmap_overlay">覆盖密度</label>'),e.push('<ul class="time_ul" style="display:none;">'),e.push("<li>"),e.push('<label class="func_heatmap_timeselect">时间选择:</label>'),e.push('<select name="heatmap_overlay_time">');for(var t=0,n=this.OverlayConfig.length;t<n;t++){var r=this.OverlayConfig[t];e.push('<option value="'+t+'">'+r.time+"</option>")}e.push("</select>"),e.push("</li>"),e.push("</ul>"),e.push("</li>"),e.push('<li class="submenu_heatmap_li">'),e.push('<img src="themes/images/frame/menu_glxs_cblx.png">&nbsp&nbsp<label class="func_heatmap_ship">船舶密度</label>'),e.push('<ul class="time_ul" style="display:none;">'),e.push("<li>"),e.push('<label class="func_heatmap_timeselect">时间选择:</label>'),e.push('<select name="heatmap_ship_time">');for(var t=0,n=this.ShipConfig.length;t<n;t++){var r=this.ShipConfig[t];e.push('<option value="'+t+'">'+r.time+"</option>")}e.push("</select>"),e.push("</li>"),e.push("</ul>"),e.push("</li>"),e.push('<li class="submenu_heatmap_li">'),e.push('<img src="themes/images/frame/menu_glxs_cblx.png">&nbsp&nbsp<label class="func_heatmap_traffic">交通密度</label>'),e.push('<ul class="time_ul" style="display:none;">'),e.push("<li>"),e.push('<label class="func_heatmap_timeselect">时间选择:</label>'),e.push('<select name="heatmap_traffic_time">');for(var t=0,n=this.TrafficConfig.length;t<n;t++){var r=this.TrafficConfig[t];e.push('<option value="'+t+'">'+r.time+"</option>")}return e.push("</select>"),e.push("</li>"),e.push("</ul>"),e.push("</li>"),e.push("</ul>"),e.join("")},_initSubMenuEvts:function(){var e=this.menu.getContainer(),t=this;e.find(".func_heatmap_timeselect").html($.i18n.prop("func_heatmap_timeselect")),e.find(".func_heatmap_overlay").html($.i18n.prop("func_heatmap_overlay")),e.find(".func_heatmap_ship").html($.i18n.prop("func_heatmap_ship")),e.find(".func_heatmap_traffic").html($.i18n.prop("func_heatmap_traffic")),e.find(".submenu_heatmap > .submenu_heatmap_li").on("click",function(){var e=$(this);e.hasClass("active")?(e.find(".time_ul").css("display","none"),e.removeClass("active"),t.removeLayer()):(e.find(".time_ul").css("display","block"),e.addClass("active").siblings().removeClass("active"),e.siblings().find(".time_ul").css("display","none"),e.find("select").change())}),e.find(".submenu_heatmap > .submenu_heatmap_li > ul").on("click",function(e){e.stopPropagation()}),e.find(".submenu_heatmap > .submenu_heatmap_li >ul >li >select").on("change",function(){var e=$(this),n=e.attr("name"),r=parseInt(e.val()),i=null;n==="heatmap_overlay_time"?i=t.OverlayConfig[r].url:n==="heatmap_ship_time"?i=t.ShipConfig[r].url:i=t.TrafficConfig[r].url,t.updateLayer(i)})},createLayer:function(t){return e.esri.dynamicMapLayer({url:t})},updateLayer:function(e){this.removeLayer(),this._layer=this.createLayer(e),this._layer.addTo(this.ictmap.map)},removeLayer:function(){this._layer&&(this._layer.remove(),this._layer=null)}})})});