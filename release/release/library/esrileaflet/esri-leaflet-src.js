/* esri-leaflet - v2.0.7 - Tue Jan 10 2017 09:03:47 GMT-0800 (PST)
 * Copyright (c) 2017 Environmental Systems Research Institute, Inc.
 * Apache-2.0 */

/*
	 * Copyright 2015 Esri
	 *
	 * Licensed under the Apache License, Version 2.0 (the "License");
	 * you may not use this file except in compliance with the License.
	 * You may obtain a copy of the License at
	 *
	 *     http://www.apache.org/licenses/LICENSE-2.0
	 *
	 * Unless required by applicable law or agreed to in writing, software
	 * distributed under the License is distributed on an "AS IS" BASIS,
	 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	 * See the License for the specific language governing permissions and
	 * limitations under the Liscense.
	 */

// add copyright text listed in service metadata

(function(e,t){typeof exports=="object"&&typeof module!="undefined"?t(exports,require("leaflet")):typeof define=="function"&&define.amd?define(["exports","leaflet"],t):t((e.L=e.L||{},e.L.esri=e.L.esri||{}),e.L)})(this,function(e,t){function n(e){var t="";e.f=e.f||"json";for(var n in e)if(e.hasOwnProperty(n)){var r=e[n],i=Object.prototype.toString.call(r),s;t.length&&(t+="&"),i==="[object Array]"?s=Object.prototype.toString.call(r[0])==="[object Object]"?JSON.stringify(r):r.join(","):i==="[object Object]"?s=JSON.stringify(r):i==="[object Date]"?s=r.valueOf():s=r,t+=encodeURIComponent(n)+"="+encodeURIComponent(s)}return t}function r(e,n){var r=new window.XMLHttpRequest;return r.onerror=function(i){r.onreadystatechange=t.Util.falseFn,e.call(n,{error:{code:500,message:"XMLHttpRequest error"}},null)},r.onreadystatechange=function(){var i,s;if(r.readyState===4){try{i=JSON.parse(r.responseText)}catch(o){i=null,s={code:500,message:"Could not parse response as JSON. This could also be caused by a CORS or XMLHttpRequest error."}}!s&&i.error&&(s=i.error,i=null),r.onerror=t.Util.falseFn,e.call(n,s,i)}},r.ontimeout=function(){this.onerror()},r}function i(e,t,i,s){var o=r(i,s);return o.open("POST",e),typeof s!="undefined"&&s!==null&&typeof s.options!="undefined"&&(o.timeout=s.options.timeout),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send(n(t)),o}function s(e,t,i,s){var o=r(i,s);return o.open("GET",e+"?"+n(t),!0),typeof s!="undefined"&&s!==null&&typeof s.options!="undefined"&&(o.timeout=s.options.timeout),o.send(null),o}function o(e,t,i,s){var o=n(t),a=r(i,s),f=(e+"?"+o).length;f<=2e3&&et.cors?a.open("GET",e+"?"+o):f>2e3&&et.cors&&(a.open("POST",e),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded")),typeof s!="undefined"&&s!==null&&typeof s.options!="undefined"&&(a.timeout=s.options.timeout);if(f<=2e3&&et.cors)a.send(null);else{if(!(f>2e3&&et.cors)){if(f<=2e3&&!et.cors)return u(e,t,i,s);O("a request to "+e+" was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html");return}a.send(o)}return a}function u(e,r,i,s){window._EsriLeafletCallbacks=window._EsriLeafletCallbacks||{};var o="c"+nt;r.callback="window._EsriLeafletCallbacks."+o,window._EsriLeafletCallbacks[o]=function(e){if(window._EsriLeafletCallbacks[o]!==!0){var t,n=Object.prototype.toString.call(e);n!=="[object Object]"&&n!=="[object Array]"&&(t={error:{code:500,message:"Expected array or object as JSONP response"}},e=null),!t&&e.error&&(t=e,e=null),i.call(s,t,e),window._EsriLeafletCallbacks[o]=!0}};var u=t.DomUtil.create("script",null,document.body);return u.type="text/javascript",u.src=e+"?"+n(r),u.id=o,nt++,{id:o,url:u.src,abort:function(){window._EsriLeafletCallbacks._callback[o]({code:0,message:"Request aborted."})}}}function a(e,t){for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function f(e){return a(e[0],e[e.length-1])||e.push(e[0]),e}function l(e){var t=0,n=0,r=e.length,i=e[n],s;for(n;n<r-1;n++)s=e[n+1],t+=(s[0]-i[0])*(s[1]+i[1]),i=s;return t>=0}function c(e,t,n,r){var i=(r[0]-n[0])*(e[1]-n[1])-(r[1]-n[1])*(e[0]-n[0]),s=(t[0]-e[0])*(e[1]-n[1])-(t[1]-e[1])*(e[0]-n[0]),o=(r[1]-n[1])*(t[0]-e[0])-(r[0]-n[0])*(t[1]-e[1]);if(o!==0){var u=i/o,a=s/o;if(u>=0&&u<=1&&a>=0&&a<=1)return!0}return!1}function h(e,t){for(var n=0;n<e.length-1;n++)for(var r=0;r<t.length-1;r++)if(c(e[n],e[n+1],t[r],t[r+1]))return!0;return!1}function p(e,t){var n=!1;for(var r=-1,i=e.length,s=i-1;++r<i;s=r)(e[r][1]<=t[1]&&t[1]<e[s][1]||e[s][1]<=t[1]&&t[1]<e[r][1])&&t[0]<(e[s][0]-e[r][0])*(t[1]-e[r][1])/(e[s][1]-e[r][1])+e[r][0]&&(n=!n);return n}function d(e,t){var n=h(e,t),r=p(e,t[0]);return!n&&r?!0:!1}function v(e){var t=[],n=[],r,i,s;for(var o=0;o<e.length;o++){var u=f(e[o].slice(0));if(u.length<4)continue;if(l(u)){var a=[u];t.push(a)}else n.push(u)}var c=[];while(n.length){s=n.pop();var p=!1;for(r=t.length-1;r>=0;r--){i=t[r][0];if(d(i,s)){t[r].push(s),p=!0;break}}p||c.push(s)}while(c.length){s=c.pop();var v=!1;for(r=t.length-1;r>=0;r--){i=t[r][0];if(h(i,s)){t[r].push(s),v=!0;break}}v||t.push([s.reverse()])}return t.length===1?{type:"Polygon",coordinates:t[0]}:{type:"MultiPolygon",coordinates:t}}function m(e){var t=[],n=e.slice(0),r=f(n.shift().slice(0));if(r.length>=4){l(r)||r.reverse(),t.push(r);for(var i=0;i<n.length;i++){var s=f(n[i].slice(0));s.length>=4&&(l(s)&&s.reverse(),t.push(s))}}return t}function g(e){var t=[];for(var n=0;n<e.length;n++){var r=m(e[n]);for(var i=r.length-1;i>=0;i--){var s=r[i].slice(0);t.push(s)}}return t}function y(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function b(e,t){var n={};typeof e.x=="number"&&typeof e.y=="number"&&(n.type="Point",n.coordinates=[e.x,e.y]),e.points&&(n.type="MultiPoint",n.coordinates=e.points.slice(0)),e.paths&&(e.paths.length===1?(n.type="LineString",n.coordinates=e.paths[0].slice(0)):(n.type="MultiLineString",n.coordinates=e.paths.slice(0))),e.rings&&(n=v(e.rings.slice(0)));if(e.geometry||e.attributes)n.type="Feature",n.geometry=e.geometry?b(e.geometry):null,n.properties=e.attributes?y(e.attributes):null,e.attributes&&(n.id=e.attributes[t]||e.attributes.OBJECTID||e.attributes.FID);return n}function w(e,t){t=t||"OBJECTID";var n={wkid:4326},r={},i;switch(e.type){case"Point":r.x=e.coordinates[0],r.y=e.coordinates[1],r.spatialReference=n;break;case"MultiPoint":r.points=e.coordinates.slice(0),r.spatialReference=n;break;case"LineString":r.paths=[e.coordinates.slice(0)],r.spatialReference=n;break;case"MultiLineString":r.paths=e.coordinates.slice(0),r.spatialReference=n;break;case"Polygon":r.rings=m(e.coordinates.slice(0)),r.spatialReference=n;break;case"MultiPolygon":r.rings=g(e.coordinates.slice(0)),r.spatialReference=n;break;case"Feature":e.geometry&&(r.geometry=w(e.geometry,t)),r.attributes=e.properties?y(e.properties):{},e.id&&(r.attributes[t]=e.id);break;case"FeatureCollection":r=[];for(i=0;i<e.features.length;i++)r.push(w(e.features[i],t));break;case"GeometryCollection":r=[];for(i=0;i<e.geometries.length;i++)r.push(w(e.geometries[i],t))}return r}function E(e,t){return w(e,t)}function S(e,t){return b(e,t)}function x(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function T(e){if(e.xmin!=="NaN"&&e.ymin!=="NaN"&&e.xmax!=="NaN"&&e.ymax!=="NaN"){var n=t.latLng(e.ymin,e.xmin),r=t.latLng(e.ymax,e.xmax);return t.latLngBounds(n,r)}return null}function N(e){return e=t.latLngBounds(e),{xmin:e.getSouthWest().lng,ymin:e.getSouthWest().lat,xmax:e.getNorthEast().lng,ymax:e.getNorthEast().lat,spatialReference:{wkid:4326}}}function C(e,t){var n,r=e.features||e.results,i=r.length;if(t)n=t;else if(e.objectIdFieldName)n=e.objectIdFieldName;else if(e.fields){for(var s=0;s<=e.fields.length-1;s++)if(e.fields[s].type==="esriFieldTypeOID"){n=e.fields[s].name;break}}else if(i)for(var o in r[0].attributes)if(o.match(/^(OBJECTID|FID|OID|ID)$/i)){n=o;break}var u={type:"FeatureCollection",features:[]};if(i)for(var a=r.length-1;a>=0;a--){var f=S(r[a],n);u.features.push(f)}return u}function k(e){return e=t.Util.trim(e),e[e.length-1]!=="/"&&(e+="/"),e}function L(e){return/^(?!.*utility\.arcgis\.com).*\.arcgis\.com.*FeatureServer/i.test(e)}function A(e){var t;switch(e){case"Point":t="esriGeometryPoint";break;case"MultiPoint":t="esriGeometryMultipoint";break;case"LineString":t="esriGeometryPolyline";break;case"MultiLineString":t="esriGeometryPolyline";break;case"Polygon":t="esriGeometryPolygon";break;case"MultiPolygon":t="esriGeometryPolygon"}return t}function O(){console&&console.warn&&console.warn.apply(console,arguments)}function M(e){return e.getSize().x-tt.attributionWidthOffset+"px"}function _(e){if(e.attributionControl&&!e.attributionControl._esriAttributionAdded){e.attributionControl.setPrefix('<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> | Powered by <a href="https://www.esri.com">Esri</a>');var n=document.createElement("style");n.type="text/css",n.innerHTML=".esri-truncated-attribution:hover {white-space: normal;}",document.getElementsByTagName("head")[0].appendChild(n),t.DomUtil.addClass(e.attributionControl._container,"esri-truncated-attribution:hover");var r=document.createElement("style");r.type="text/css",r.innerHTML=".esri-truncated-attribution {vertical-align: -3px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: inline-block;transition: 0s white-space;transition-delay: 1s;max-width: "+M(e)+";"+"}",document.getElementsByTagName("head")[0].appendChild(r),t.DomUtil.addClass(e.attributionControl._container,"esri-truncated-attribution"),e.on("resize",function(t){e.attributionControl._container.style.maxWidth=M(t.target)}),e.attributionControl._esriAttributionAdded=!0}}function D(e,n){u(e,{},t.Util.bind(function(e,r){if(e)return;n._esriAttributions=[];for(var i=0;i<r.contributors.length;i++){var s=r.contributors[i];for(var o=0;o<s.coverageAreas.length;o++){var u=s.coverageAreas[o],a=t.latLng(u.bbox[0],u.bbox[1]),f=t.latLng(u.bbox[2],u.bbox[3]);n._esriAttributions.push({attribution:s.attribution,score:u.score,bounds:t.latLngBounds(a,f),minZoom:u.zoomMin,maxZoom:u.zoomMax})}}n._esriAttributions.sort(function(e,t){return t.score-e.score});var l={target:n};P(l)},this))}function P(e){var n=e.target,r=n._esriAttributions;if(n&&n.attributionControl&&r){var i="",s=n.getBounds(),o=t.latLngBounds(s.getSouthWest().wrap(),s.getNorthEast().wrap()),u=n.getZoom();for(var a=0;a<r.length;a++){var f=r[a],l=f.attribution;!i.match(l)&&f.bounds.intersects(o)&&u>=f.minZoom&&u<=f.maxZoom&&(i+=", "+l)}i=i.substr(2);var c=n.attributionControl._container.querySelector(".esri-dynamic-attribution");c.innerHTML=i,c.style.maxWidth=M(n),n.fire("attributionupdated",{attribution:i})}}function H(e){return new ot(e)}function B(e){return new ut(e)}function j(e){return new at(e)}function F(e){return new ft(e)}function I(e){return new lt(e)}function q(e){return new ct(e)}function R(e){return new ht(e)}function U(e){return new pt(e)}function z(e){return new dt(e)}function W(e){return new vt(e)}function X(e,t){return new gt(e,t)}function V(e,t){return new yt(e,t)}function $(e,t){return new Et(e,t)}function J(e,t){return new St(e,t)}function K(e){this.values=[].concat(e||[])}function Q(e){return new Nt(e)}t=window.L||{},t.esri=t.esri||{},e=t.esri,t="default"in t?t["default"]:t;var G="2.0.7",Y=window.XMLHttpRequest&&"withCredentials"in new window.XMLHttpRequest,Z=document.documentElement.style.pointerEvents==="",et={cors:Y,pointerEvents:Z},tt={attributionWidthOffset:55},nt=0,rt=et.cors?s:u;rt.CORS=s,rt.JSONP=u;var it={request:o,get:rt,post:i},st={shallowClone:x,warn:O,cleanUrl:k,isArcgisOnline:L,geojsonTypeToArcGIS:A,responseToFeatureCollection:C,geojsonToArcGIS:E,arcgisToGeoJSON:S,boundsToExtent:N,extentToBounds:T,calcAttributionWidth:M,setEsriAttribution:_,_getAttributionData:D,_updateMapAttribution:P},ot=t.Class.extend({options:{proxy:!1,useCors:Y},generateSetter:function(e,n){return t.Util.bind(function(t){return this.params[e]=t,this},n)},initialize:function(e){e.request&&e.options?(this._service=e,t.Util.setOptions(this,e.options)):(t.Util.setOptions(this,e),this.options.url=k(e.url)),this.params=t.Util.extend({},this.params||{});if(this.setters)for(var n in this.setters){var r=this.setters[n];this[n]=this.generateSetter(r,this)}},token:function(e){return this._service?this._service.authenticate(e):this.params.token=e,this},request:function(e,t){return this._service?this._service.request(this.path,this.params,e,t):this._request("request",this.path,this.params,e,t)},_request:function(e,t,n,r,i){var s=this.options.proxy?this.options.proxy+"?"+this.options.url+t:this.options.url+t;return e!=="get"&&e!=="request"||!!this.options.useCors?it[e](s,n,r,i):it.get.JSONP(s,n,r,i)}}),ut=ot.extend({setters:{offset:"resultOffset",limit:"resultRecordCount",fields:"outFields",precision:"geometryPrecision",featureIds:"objectIds",returnGeometry:"returnGeometry",token:"token"},path:"query",params:{returnGeometry:!0,where:"1=1",outSr:4326,outFields:"*"},within:function(e){return this._setGeometry(e),this.params.spatialRel="esriSpatialRelContains",this},intersects:function(e){return this._setGeometry(e),this.params.spatialRel="esriSpatialRelIntersects",this},contains:function(e){return this._setGeometry(e),this.params.spatialRel="esriSpatialRelWithin",this},crosses:function(e){return this._setGeometry(e),this.params.spatialRel="esriSpatialRelCrosses",this},touches:function(e){return this._setGeometry(e),this.params.spatialRel="esriSpatialRelTouches",this},overlaps:function(e){return this._setGeometry(e),this.params.spatialRel="esriSpatialRelOverlaps",this},nearby:function(e,n){return e=t.latLng(e),this.params.geometry=[e.lng,e.lat],this.params.geometryType="esriGeometryPoint",this.params.spatialRel="esriSpatialRelIntersects",this.params.units="esriSRUnit_Meter",this.params.distance=n,this.params.inSr=4326,this},where:function(e){return this.params.where=e,this},between:function(e,t){return this.params.time=[e.valueOf(),t.valueOf()],this},simplify:function(e,t){var n=Math.abs(e.getBounds().getWest()-e.getBounds().getEast());return this.params.maxAllowableOffset=n/e.getSize().y*t,this},orderBy:function(e,t){return t=t||"ASC",this.params.orderByFields=this.params.orderByFields?this.params.orderByFields+",":"",this.params.orderByFields+=[e,t].join(" "),this},run:function(e,t){return this._cleanParams(),this.options.isModern||st.isArcgisOnline(this.options.url)?(this.params.f="geojson",this.request(function(n,r){this._trapSQLerrors(n),e.call(t,n,r,r)},this)):this.request(function(n,r){this._trapSQLerrors(n),e.call(t,n,r&&st.responseToFeatureCollection(r),r)},this)},count:function(e,t){return this._cleanParams(),this.params.returnCountOnly=!0,this.request(function(t,n){e.call(this,t,n&&n.count,n)},t)},ids:function(e,t){return this._cleanParams(),this.params.returnIdsOnly=!0,this.request(function(t,n){e.call(this,t,n&&n.objectIds,n)},t)},bounds:function(e,t){return this._cleanParams(),this.params.returnExtentOnly=!0,this.request(function(n,r){r&&r.extent&&st.extentToBounds(r.extent)?e.call(t,n,st.extentToBounds(r.extent),r):(n={message:"Invalid Bounds"},e.call(t,n,null,r))},t)},pixelSize:function(e){return e=t.point(e),this.params.pixelSize=[e.x,e.y],this},layer:function(e){return this.path=e+"/query",this},_trapSQLerrors:function(e){e&&e.code==="400"&&st.warn("one common syntax error in query requests is encasing string values in double quotes instead of single quotes")},_cleanParams:function(){delete this.params.returnIdsOnly,delete this.params.returnExtentOnly,delete this.params.returnCountOnly},_setGeometry:function(e){this.params.inSr=4326;if(e instanceof t.LatLngBounds){this.params.geometry=st.boundsToExtent(e),this.params.geometryType="esriGeometryEnvelope";return}e.getLatLng&&(e=e.getLatLng()),e instanceof t.LatLng&&(e={type:"Point",coordinates:[e.lng,e.lat]}),e instanceof t.GeoJSON&&(e=e.getLayers()[0].feature.geometry,this.params.geometry=st.geojsonToArcGIS(e),this.params.geometryType=st.geojsonTypeToArcGIS(e.type)),e.toGeoJSON&&(e=e.toGeoJSON()),e.type==="Feature"&&(e=e.geometry);if(e.type==="Point"||e.type==="LineString"||e.type==="Polygon"||e.type==="MultiPolygon"){this.params.geometry=st.geojsonToArcGIS(e),this.params.geometryType=st.geojsonTypeToArcGIS(e.type);return}st.warn("invalid geometry passed to spatial query. Should be L.LatLng, L.LatLngBounds, L.Marker or a GeoJSON Point, Line, Polygon or MultiPolygon object");return}}),at=ot.extend({setters:{contains:"contains",text:"searchText",fields:"searchFields",spatialReference:"sr",sr:"sr",layers:"layers",returnGeometry:"returnGeometry",maxAllowableOffset:"maxAllowableOffset",precision:"geometryPrecision",dynamicLayers:"dynamicLayers",returnZ:"returnZ",returnM:"returnM",gdbVersion:"gdbVersion",token:"token"},path:"find",params:{sr:4326,contains:!0,returnGeometry:!0,returnZ:!0,returnM:!1},layerDefs:function(e,t){return this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"",this.params.layerDefs+=[e,t].join(":"),this},simplify:function(e,t){var n=Math.abs(e.getBounds().getWest()-e.getBounds().getEast());return this.params.maxAllowableOffset=n/e.getSize().y*t,this},run:function(e,t){return this.request(function(n,r){e.call(t,n,r&&st.responseToFeatureCollection(r),r)},t)}}),ft=ot.extend({path:"identify",between:function(e,t){return this.params.time=[e.valueOf(),t.valueOf()],this}}),lt=ft.extend({setters:{layers:"layers",precision:"geometryPrecision",tolerance:"tolerance",returnGeometry:"returnGeometry"},params:{sr:4326,layers:"all",tolerance:3,returnGeometry:!0},on:function(e){var t=st.boundsToExtent(e.getBounds()),n=e.getSize();return this.params.imageDisplay=[n.x,n.y,96],this.params.mapExtent=[t.xmin,t.ymin,t.xmax,t.ymax],this},at:function(e){return e=t.latLng(e),this.params.geometry=[e.lng,e.lat],this.params.geometryType="esriGeometryPoint",this},layerDef:function(e,t){return this.params.layerDefs=this.params.layerDefs?this.params.layerDefs+";":"",this.params.layerDefs+=[e,t].join(":"),this},simplify:function(e,t){var n=Math.abs(e.getBounds().getWest()-e.getBounds().getEast());return this.params.maxAllowableOffset=n/e.getSize().y*(1-t),this},run:function(e,t){return this.request(function(n,r){if(n){e.call(t,n,undefined,r);return}var i=st.responseToFeatureCollection(r);r.results=r.results.reverse();for(var s=0;s<i.features.length;s++){var o=i.features[s];o.layerId=r.results[s].layerId}e.call(t,undefined,i,r)})}}),ct=ft.extend({setters:{setMosaicRule:"mosaicRule",setRenderingRule:"renderingRule",setPixelSize:"pixelSize",returnCatalogItems:"returnCatalogItems",returnGeometry:"returnGeometry"},params:{returnGeometry:!1},at:function(e){return e=t.latLng(e),this.params.geometry=JSON.stringify({x:e.lng,y:e.lat,spatialReference:{wkid:4326}}),this.params.geometryType="esriGeometryPoint",this},getMosaicRule:function(){return this.params.mosaicRule},getRenderingRule:function(){return this.params.renderingRule},getPixelSize:function(){return this.params.pixelSize},run:function(e,t){return this.request(function(n,r){e.call(t,n,r&&this._responseToGeoJSON(r),r)},this)},_responseToGeoJSON:function(e){var t=e.location,n=e.catalogItems,r=e.catalogItemVisibilities,i={pixel:{type:"Feature",geometry:{type:"Point",coordinates:[t.x,t.y]},crs:{type:"EPSG",properties:{code:t.spatialReference.wkid}},properties:{OBJECTID:e.objectId,name:e.name,value:e.value},id:e.objectId}};e.properties&&e.properties.Values&&(i.pixel.properties.values=e.properties.Values);if(n&&n.features){i.catalogItems=st.responseToFeatureCollection(n);if(r&&r.length===i.catalogItems.features.length)for(var s=r.length-1;s>=0;s--)i.catalogItems.features[s].properties.catalogItemVisibility=r[s]}return i}}),ht=t.Evented.extend({options:{proxy:!1,useCors:Y,timeout:0},initialize:function(e){e=e||{},this._requestQueue=[],this._authenticating=!1,t.Util.setOptions(this,e),this.options.url=k(this.options.url)},get:function(e,t,n,r){return this._request("get",e,t,n,r)},post:function(e,t,n,r){return this._request("post",e,t,n,r)},request:function(e,t,n,r){return this._request("request",e,t,n,r)},metadata:function(e,t){return this._request("get","",{},e,t)},authenticate:function(e){return this._authenticating=!1,this.options.token=e,this._runQueue(),this},getTimeout:function(){return this.options.timeout},setTimeout:function(e){this.options.timeout=e},_request:function(e,t,n,r,i){this.fire("requeststart",{url:this.options.url+t,params:n,method:e},!0);var s=this._createServiceCallback(e,t,n,r,i);this.options.token&&(n.token=this.options.token);if(this._authenticating){this._requestQueue.push([e,t,n,r,i]);return}var o=this.options.proxy?this.options.proxy+"?"+this.options.url+t:this.options.url+t;return e!=="get"&&e!=="request"||!!this.options.useCors?it[e](o,n,s,i):it.get.JSONP(o,n,s,i)},_createServiceCallback:function(e,n,r,i,s){return t.Util.bind(function(o,u){o&&(o.code===499||o.code===498)&&(this._authenticating=!0,this._requestQueue.push([e,n,r,i,s]),this.fire("authenticationrequired",{authenticate:t.Util.bind(this.authenticate,this)},!0),o.authenticate=t.Util.bind(this.authenticate,this)),i.call(s,o,u),o?this.fire("requesterror",{url:this.options.url+n,params:r,message:o.message,code:o.code,method:e},!0):this.fire("requestsuccess",{url:this.options.url+n,params:r,response:u,method:e},!0),this.fire("requestend",{url:this.options.url+n,params:r,method:e},!0)},this)},_runQueue:function(){for(var e=this._requestQueue.length-1;e>=0;e--){var t=this._requestQueue[e],n=t.shift();this[n].apply(this,t)}this._requestQueue=[]}}),pt=ht.extend({identify:function(){return I(this)},find:function(){return j(this)},query:function(){return B(this)}}),dt=ht.extend({query:function(){return B(this)},identify:function(){return q(this)}}),vt=ht.extend({options:{idAttribute:"OBJECTID"},query:function(){return B(this)},addFeature:function(e,t,n){return delete e.id,e=E(e),this.post("addFeatures",{features:[e]},function(e,r){var i=r&&r.addResults?r.addResults[0]:undefined;t&&t.call(n,e||r.addResults[0].error,i)},n)},updateFeature:function(e,t,n){return e=E(e,this.options.idAttribute),this.post("updateFeatures",{features:[e]},function(e,r){var i=r&&r.updateResults?r.updateResults[0]:undefined;t&&t.call(n,e||r.updateResults[0].error,i)},n)},deleteFeature:function(e,t,n){return this.post("deleteFeatures",{objectIds:e},function(e,r){var i=r&&r.deleteResults?r.deleteResults[0]:undefined;t&&t.call(n,e||r.deleteResults[0].error,i)},n)},deleteFeatures:function(e,t,n){return this.post("deleteFeatures",{objectIds:e},function(e,r){var i=r&&r.deleteResults?r.deleteResults:undefined;t&&t.call(n,e||r.deleteResults[0].error,i)},n)}}),mt=window.location.protocol!=="https:"?"http:":"https:",gt=t.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/World_Street_Map"}},Topographic:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/World_Topo_Map"}},Oceans:{urlTemplate:mt+"//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/Ocean_Basemap"}},OceansLabels:{urlTemplate:mt+"//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:Z?"esri-labels":"tilePane"}},NationalGeographic:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"National Geographic, DeLorme, HERE, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, increment P Corp."}},DarkGray:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"HERE, DeLorme, MapmyIndia, &copy; OpenStreetMap contributors"}},DarkGrayLabels:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:Z?"esri-labels":"tilePane",attribution:""}},Gray:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"HERE, DeLorme, MapmyIndia, &copy; OpenStreetMap contributors"}},GrayLabels:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:Z?"esri-labels":"tilePane",attribution:""}},Imagery:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community"}},ImageryLabels:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],pane:Z?"esri-labels":"tilePane",attribution:""}},ImageryTransportation:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,subdomains:["server","services"],pane:Z?"esri-labels":"tilePane"}},ShadedRelief:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"USGS"}},ShadedReliefLabels:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places_Alternate/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:12,subdomains:["server","services"],pane:Z?"esri-labels":"tilePane",attribution:""}},Terrain:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"USGS, NOAA"}},TerrainLabels:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:13,subdomains:["server","services"],pane:Z?"esri-labels":"tilePane",attribution:""}},USATopo:{urlTemplate:mt+"//{s}.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:15,subdomains:["server","services"],attribution:"USGS, National Geographic Society, i-cubed"}}}},initialize:function(e,n){var r;if(typeof e=="object"&&e.urlTemplate&&e.options)r=e;else{if(typeof e!="string"||!gt.TILES[e])throw new Error('L.esri.BasemapLayer: Invalid parameter. Use one of "Streets", "Topographic", "Oceans", "OceansLabels", "NationalGeographic", "Gray", "GrayLabels", "DarkGray", "DarkGrayLabels", "Imagery", "ImageryLabels", "ImageryTransportation", "ShadedRelief", "ShadedReliefLabels", "Terrain", "TerrainLabels" or "USATopo"');r=gt.TILES[e]}var i=t.Util.extend(r.options,n);t.Util.setOptions(this,i),this.options.token&&(r.urlTemplate+="?token="+this.options.token),t.TileLayer.prototype.initialize.call(this,r.urlTemplate,i)},onAdd:function(e){_(e),this.options.pane==="esri-labels"&&this._initPane(),this.options.attributionUrl&&D(this.options.attributionUrl,e),e.on("moveend",P),t.TileLayer.prototype.onAdd.call(this,e)},onRemove:function(e){e.off("moveend",P),t.TileLayer.prototype.onRemove.call(this,e)},_initPane:function(){if(!this._map.getPane(this.options.pane)){var e=this._map.createPane(this.options.pane);e.style.pointerEvents="none",e.style.zIndex=500}},getAttribution:function(){if(this.options.attribution)var e='<span class="esri-dynamic-attribution">'+this.options.attribution+"</span>";return e}}),yt=t.TileLayer.extend({options:{zoomOffsetAllowance:.1,errorTileUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEABAMAAACuXLVVAAAAA1BMVEUzNDVszlHHAAAAAXRSTlMAQObYZgAAAAlwSFlzAAAAAAAAAAAB6mUWpAAAADZJREFUeJztwQEBAAAAgiD/r25IQAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7waBAAABw08RwAAAAABJRU5ErkJggg=="},statics:{MercatorZoomLevels:{0:156543.033928,1:78271.5169639999,2:39135.7584820001,3:19567.8792409999,4:9783.93962049996,5:4891.96981024998,6:2445.98490512499,7:1222.99245256249,8:611.49622628138,9:305.748113140558,10:152.874056570411,11:76.4370282850732,12:38.2185141425366,13:19.1092570712683,14:9.55462853563415,15:4.77731426794937,16:2.38865713397468,17:1.19432856685505,18:.597164283559817,19:.298582141647617,20:.14929107082381,21:.07464553541191,22:.0373227677059525,23:.0186613838529763}},initialize:function(e){e.url=k(e.url),e=t.Util.setOptions(this,e),this.tileUrl=e.url+"tile/{z}/{y}/{x}",this.service=U(e),this.service.addEventParent(this);var n=new RegExp(/tiles.arcgis(online)?\.com/g);n.test(e.url)&&(this.tileUrl=this.tileUrl.replace("://tiles","://tiles{s}"),e.subdomains=["1","2","3","4"]),this.options.token&&(this.tileUrl+="?token="+this.options.token),t.TileLayer.prototype.initialize.call(this,this.tileUrl,e)},getTileUrl:function(e){var n=this._getZoomForUrl();return t.Util.template(this.tileUrl,t.extend({s:this._getSubdomain(e),x:e.x,y:e.y,z:this._lodMap&&this._lodMap[n]?this._lodMap[n]:n},this.options))},createTile:function(e,n){var r=document.createElement("img");return t.DomEvent.on(r,"load",t.bind(this._tileOnLoad,this,n,r)),t.DomEvent.on(r,"error",t.bind(this._tileOnError,this,n,r)),this.options.crossOrigin&&(r.crossOrigin=""),r.alt="",!this._lodMap||this._lodMap&&this._lodMap[this._getZoomForUrl()]?r.src=this.getTileUrl(e):this.once("lodmap",function(){r.src=this.getTileUrl(e)},this),r},onAdd:function(e){_(e),this._lodMap||this.metadata(function(n,r){if(!n&&r.spatialReference){var i=r.spatialReference.latestWkid||r.spatialReference.wkid;!this.options.attribution&&e.attributionControl&&r.copyrightText&&(this.options.attribution=r.copyrightText,e.attributionControl.addAttribution(this.getAttribution()));if(e.options.crs===t.CRS.EPSG3857&&i===102100||i===3857){this._lodMap={};var s=r.tileInfo.lods,o=yt.MercatorZoomLevels;for(var u=0;u<s.length;u++){var a=s[u];for(var f in o){var l=o[f];if(this._withinPercentage(a.resolution,l,this.options.zoomOffsetAllowance)){this._lodMap[f]=a.level;break}}}this.fire("lodmap")}else proj4||O("L.esri.TiledMapLayer is using a non-mercator spatial reference. Support may be available through Proj4Leaflet http://esri.github.io/esri-leaflet/examples/non-mercator-projection.html")}},this),t.TileLayer.prototype.onAdd.call(this,e)},metadata:function(e,t){return this.service.metadata(e,t),this},identify:function(){return this.service.identify()},find:function(){return this.service.find()},query:function(){return this.service.query()},authenticate:function(e){var t="?token="+e;return this.tileUrl=this.options.token?this.tileUrl.replace(/\?token=(.+)/g,t):this.tileUrl+t,this.options.token=e,this.service.authenticate(e),this},_withinPercentage:function(e,t,n){var r=Math.abs(e/t-1);return r<n}}),bt=t.ImageOverlay.extend({onAdd:function(e){this._topLeft=e.getPixelBounds().min,t.ImageOverlay.prototype.onAdd.call(this,e)},_reset:function(){this._map.options.crs===t.CRS.EPSG3857?t.ImageOverlay.prototype._reset.call(this):t.DomUtil.setPosition(this._image,this._topLeft.subtract(this._map.getPixelOrigin()))}}),wt=t.Layer.extend({options:{opacity:1,position:"front",f:"image",useCors:Y,attribution:null,interactive:!1,alt:""},onAdd:function(e){_(e),this._update=t.Util.throttle(this._update,this.options.updateInterval,this),e.on("moveend",this._update,this),this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds())?e.addLayer(this._currentImage):this._currentImage&&(this._map.removeLayer(this._currentImage),this._currentImage=null),this._update(),this._popup&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this.metadata(function(t,n){!t&&!this.options.attribution&&e.attributionControl&&n.copyrightText&&(this.options.attribution=n.copyrightText,e.attributionControl.addAttribution(this.getAttribution()))},this)},onRemove:function(e){this._currentImage&&this._map.removeLayer(this._currentImage),this._popup&&(this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._map.off("moveend",this._update,this)},bindPopup:function(e,n){return this._shouldRenderPopup=!1,this._lastClick=!1,this._popup=t.popup(n),this._popupFunction=e,this._map&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this},unbindPopup:function(){return this._map&&(this._map.closePopup(this._popup),this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._popup=!1,this},bringToFront:function(){return this.options.position="front",this._currentImage&&this._currentImage.bringToFront(),this},bringToBack:function(){return this.options.position="back",this._currentImage&&this._currentImage.bringToBack(),this},getAttribution:function(){return this.options.attribution},getOpacity:function(){return this.options.opacity},setOpacity:function(e){return this.options.opacity=e,this._currentImage&&this._currentImage.setOpacity(e),this},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(e,t){return this.options.from=e,this.options.to=t,this._update(),this},metadata:function(e,t){return this.service.metadata(e,t),this},authenticate:function(e){return this.service.authenticate(e),this},redraw:function(){this._update()},_renderImage:function(e,t,n){if(this._map){n&&(e="data:"+n+";base64,"+e);var r=(new bt(e,t,{opacity:0,crossOrigin:this.options.useCors,alt:this.options.alt,pane:this.options.pane||this.getPane(),interactive:this.options.interactive})).addTo(this._map);r.once("load",function(e){if(this._map){var n=e.target,r=this._currentImage;n._bounds.equals(t)&&n._bounds.equals(this._map.getBounds())?(this._currentImage=n,this.options.position==="front"?this.bringToFront():this.bringToBack(),this._map&&this._currentImage._map?this._currentImage.setOpacity(this.options.opacity):this._currentImage._map.removeLayer(this._currentImage),r&&this._map&&this._map.removeLayer(r),r&&r._map&&r._map.removeLayer(r)):this._map.removeLayer(n)}this.fire("load",{bounds:t})},this),this.fire("loading",{bounds:t})}},_update:function(){if(!this._map)return;var e=this._map.getZoom(),t=this._map.getBounds();if(this._animatingZoom)return;if(this._map._panTransition&&this._map._panTransition._inProgress)return;if(e>this.options.maxZoom||e<this.options.minZoom){this._currentImage&&this._currentImage._map.removeLayer(this._currentImage);return}var n=this._buildExportParams();this._requestExport(n,t)},_renderPopup:function(e,n,r,i){e=t.latLng(e);if(this._shouldRenderPopup&&this._lastClick.equals(e)){var s=this._popupFunction(n,r,i);s&&this._popup.setLatLng(e).setContent(s).openOn(this._map)}},_resetPopupState:function(e){this._shouldRenderPopup=!1,this._lastClick=e.latlng}}),Et=wt.extend({options:{updateInterval:150,format:"jpgpng",transparent:!0,f:"json"},query:function(){return this.service.query()},identify:function(){return this.service.identify()},initialize:function(e){e.url=k(e.url),this.service=z(e),this.service.addEventParent(this),t.Util.setOptions(this,e)},setPixelType:function(e){return this.options.pixelType=e,this._update(),this},getPixelType:function(){return this.options.pixelType},setBandIds:function(e){return t.Util.isArray(e)?this.options.bandIds=e.join(","):this.options.bandIds=e.toString(),this._update(),this},getBandIds:function(){return this.options.bandIds},setNoData:function(e,n){return t.Util.isArray(e)?this.options.noData=e.join(","):this.options.noData=e.toString(),n&&(this.options.noDataInterpretation=n),this._update(),this},getNoData:function(){return this.options.noData},getNoDataInterpretation:function(){return this.options.noDataInterpretation},setRenderingRule:function(e){this.options.renderingRule=e,this._update()},getRenderingRule:function(){return this.options.renderingRule},setMosaicRule:function(e){this.options.mosaicRule=e,this._update()},getMosaicRule:function(){return this.options.mosaicRule},_getPopupData:function(e){var n=t.Util.bind(function(n,r,i){if(n)return;setTimeout(t.Util.bind(function(){this._renderPopup(e.latlng,n,r,i)},this),300)},this),r=this.identify().at(e.latlng);this.options.mosaicRule&&r.setMosaicRule(this.options.mosaicRule),r.run(n),this._shouldRenderPopup=!0,this._lastClick=e.latlng},_buildExportParams:function(){var e=this._map.getBounds(),t=this._map.getSize(),n=this._map.options.crs.project(e._northEast),r=this._map.options.crs.project(e._southWest),i=this._map.latLngToLayerPoint(e._northEast),s=this._map.latLngToLayerPoint(e._southWest);if(i.y>0||s.y<t.y)t.y=s.y-i.y;var o=parseInt(this._map.options.crs.code.split(":")[1],10),u={bbox:[r.x,r.y,n.x,n.y].join(","),size:t.x+","+t.y,format:this.options.format,transparent:this.options.transparent,bboxSR:o,imageSR:o};return this.options.from&&this.options.to&&(u.time=this.options.from.valueOf()+","+this.options.to.valueOf()),this.options.pixelType&&(u.pixelType=this.options.pixelType),this.options.interpolation&&(u.interpolation=this.options.interpolation),this.options.compressionQuality&&(u.compressionQuality=this.options.compressionQuality),this.options.bandIds&&(u.bandIds=this.options.bandIds),this.options.noData&&(u.noData=this.options.noData),this.options.noDataInterpretation&&(u.noDataInterpretation=this.options.noDataInterpretation),this.service.options.token&&(u.token=this.service.options.token),this.options.renderingRule&&(u.renderingRule=JSON.stringify(this.options.renderingRule)),this.options.mosaicRule&&(u.mosaicRule=JSON.stringify(this.options.mosaicRule)),u},_requestExport:function(e,n){this.options.f==="json"?this.service.request("exportImage",e,function(e,t){if(e)return;this.options.token&&(t.href+="?token="+this.options.token),this._renderImage(t.href,n)},this):(e.f="image",this._renderImage(this.options.url+"exportImage"+t.Util.getParamString(e),n))}}),St=wt.extend({options:{updateInterval:150,layers:!1,layerDefs:!1,timeOptions:!1,format:"png24",transparent:!0,f:"json"},initialize:function(e){e.url=k(e.url),this.service=U(e),this.service.addEventParent(this),(e.proxy||e.token)&&e.f!=="json"&&(e.f="json"),t.Util.setOptions(this,e)},getDynamicLayers:function(){return this.options.dynamicLayers},setDynamicLayers:function(e){return this.options.dynamicLayers=e,this._update(),this},getLayers:function(){return this.options.layers},setLayers:function(e){return this.options.layers=e,this._update(),this},getLayerDefs:function(){return this.options.layerDefs},setLayerDefs:function(e){return this.options.layerDefs=e,this._update(),this},getTimeOptions:function(){return this.options.timeOptions},setTimeOptions:function(e){return this.options.timeOptions=e,this._update(),this},query:function(){return this.service.query()},identify:function(){return this.service.identify()},find:function(){return this.service.find()},_getPopupData:function(e){var n=t.Util.bind(function(n,r,i){if(n)return;setTimeout(t.Util.bind(function(){this._renderPopup(e.latlng,n,r,i)},this),300)},this),r=this.identify().on(this._map).at(e.latlng);this.options.layers?r.layers("visible:"+this.options.layers.join(",")):r.layers("visible"),r.run(n),this._shouldRenderPopup=!0,this._lastClick=e.latlng},_buildExportParams:function(){var e=this._map.getBounds(),t=this._map.getSize(),n=this._map.options.crs.project(e.getNorthEast()),r=this._map.options.crs.project(e.getSouthWest()),i=parseInt(this._map.options.crs.code.split(":")[1],10),s=this._map.latLngToLayerPoint(e._northEast),o=this._map.latLngToLayerPoint(e._southWest);if(s.y>0||o.y<t.y)t.y=o.y-s.y;var u={bbox:[r.x,r.y,n.x,n.y].join(","),size:t.x+","+t.y,dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:i,imageSR:i};return this.options.dynamicLayers&&(u.dynamicLayers=this.options.dynamicLayers),this.options.layers&&(u.layers="show:"+this.options.layers.join(",")),this.options.layerDefs&&(u.layerDefs=typeof this.options.layerDefs=="string"?this.options.layerDefs:JSON.stringify(this.options.layerDefs)),this.options.timeOptions&&(u.timeOptions=JSON.stringify(this.options.timeOptions)),this.options.from&&this.options.to&&(u.time=this.options.from.valueOf()+","+this.options.to.valueOf()),this.service.options.token&&(u.token=this.service.options.token),this.options.proxy&&(u.proxy=this.options.proxy),u},_requestExport:function(e,n){this.options.f==="json"?this.service.request("export",e,function(e,t){if(e)return;this.options.token&&(t.href+="?token="+this.options.token),this.options.proxy&&(t.href=this.options.proxy+"?"+t.href),t.href?this._renderImage(t.href,n):this._renderImage(t.imageData,n,t.contentType)},this):(e.f="image",this._renderImage(this.options.url+"export"+t.Util.getParamString(e),n))}}),xt=t.Layer.extend({options:{cellSize:512,updateInterval:150},initialize:function(e){e=t.setOptions(this,e),this._zooming=!1},onAdd:function(e){this._map=e,this._update=t.Util.throttle(this._update,this.options.updateInterval,this),this._reset(),this._update()},onRemove:function(){this._map.removeEventListener(this.getEvents(),this),this._removeCells()},getEvents:function(){var e={moveend:this._update,zoomstart:this._zoomstart,zoomend:this._reset};return e},addTo:function(e){return e.addLayer(this),this},removeFrom:function(e){return e.removeLayer(this),this},_zoomstart:function(){this._zooming=!0},_reset:function(){this._removeCells(),this._cells={},this._activeCells={},this._cellsToLoad=0,this._cellsTotal=0,this._cellNumBounds=this._getCellNumBounds(),this._resetWrap(),this._zooming=!1},_resetWrap:function(){var e=this._map,t=e.options.crs;if(t.infinite)return;var n=this._getCellSize();t.wrapLng&&(this._wrapLng=[Math.floor(e.project([0,t.wrapLng[0]]).x/n),Math.ceil(e.project([0,t.wrapLng[1]]).x/n)]),t.wrapLat&&(this._wrapLat=[Math.floor(e.project([t.wrapLat[0],0]).y/n),Math.ceil(e.project([t.wrapLat[1],0]).y/n)])},_getCellSize:function(){return this.options.cellSize},_update:function(){if(!this._map)return;var e=this._map.getPixelBounds(),n=this._getCellSize(),r=t.bounds(e.min.divideBy(n).floor(),e.max.divideBy(n).floor());this._removeOtherCells(r),this._addCells(r),this.fire("cellsupdated")},_addCells:function(e){var n=[],r=e.getCenter(),i=this._map.getZoom(),s,o,u;for(s=e.min.y;s<=e.max.y;s++)for(o=e.min.x;o<=e.max.x;o++)u=t.point(o,s),u.z=i,this._isValidCell(u)&&n.push(u);var a=n.length;if(a===0)return;this._cellsToLoad+=a,this._cellsTotal+=a,n.sort(function(e,t){return e.distanceTo(r)-t.distanceTo(r)});for(o=0;o<a;o++)this._addCell(n[o])},_isValidCell:function(e){var n=this._map.options.crs;if(!n.infinite){var r=this._cellNumBounds;if(!n.wrapLng&&(e.x<r.min.x||e.x>r.max.x)||!n.wrapLat&&(e.y<r.min.y||e.y>r.max.y))return!1}if(!this.options.bounds)return!0;var i=this._cellCoordsToBounds(e);return t.latLngBounds(this.options.bounds).intersects(i)},_cellCoordsToBounds:function(e){var n=this._map,r=this.options.cellSize,i=e.multiplyBy(r),s=i.add([r,r]),o=n.wrapLatLng(n.unproject(i,e.z)),u=n.wrapLatLng(n.unproject(s,e.z));return t.latLngBounds(o,u)},_cellCoordsToKey:function(e){return e.x+":"+e.y},_keyToCellCoords:function(e){var n=e.split(":"),r=parseInt(n[0],10),i=parseInt(n[1],10);return t.point(r,i)},_removeOtherCells:function(e){for(var t in this._cells)e.contains(this._keyToCellCoords(t))||this._removeCell(t)},_removeCell:function(e){var t=this._activeCells[e];t&&(delete this._activeCells[e],this.cellLeave&&this.cellLeave(t.bounds,t.coords),this.fire("cellleave",{bounds:t.bounds,coords:t.coords}))},_removeCells:function(){for(var e in this._cells){var t=this._cells[e].bounds,n=this._cells[e].coords;this.cellLeave&&this.cellLeave(t,n),this.fire("cellleave",{bounds:t,coords:n})}},_addCell:function(e){this._wrapCoords(e);var t=this._cellCoordsToKey(e),n=this._cells[t];n&&!this._activeCells[t]&&(this.cellEnter&&this.cellEnter(n.bounds,e),this.fire("cellenter",{bounds:n.bounds,coords:e}),this._activeCells[t]=n),n||(n={coords:e,bounds:this._cellCoordsToBounds(e)},this._cells[t]=n,this._activeCells[t]=n,this.createCell&&this.createCell(n.bounds,e),this.fire("cellcreate",{bounds:n.bounds,coords:e}))},_wrapCoords:function(e){e.x=this._wrapLng?t.Util.wrapNum(e.x,this._wrapLng):e.x,e.y=this._wrapLat?t.Util.wrapNum(e.y,this._wrapLat):e.y},_getCellNumBounds:function(){var e=this._map.getPixelWorldBounds(),n=this._getCellSize();return e?t.bounds(e.min.divideBy(n).floor(),e.max.divideBy(n).ceil().subtract([1,1])):null}});K.prototype.query=function(e){var t=this.getIndex(e);return this.values[t]},K.prototype.getIndex=function(e){this.dirty&&this.sort();var t=0,n=this.values.length-1,r,i;while(t<=n){r=(t+n)/2|0,i=this.values[Math.round(r)];if(+i.value<+e)t=r+1;else{if(!(+i.value>+e))return r;n=r-1}}return Math.abs(~n)},K.prototype.between=function(e,t){var n=this.getIndex(e),r=this.getIndex(t);if(n===0&&r===0)return[];while(this.values[n-1]&&this.values[n-1].value===e)n--;while(this.values[r+1]&&this.values[r+1].value===t)r++;return this.values[r]&&this.values[r].value===t&&this.values[r+1]&&r++,this.values.slice(n,r)},K.prototype.insert=function(e){return this.values.splice(this.getIndex(e.value),0,e),this},K.prototype.bulkAdd=function(e,t){return this.values=this.values.concat([].concat(e||[])),t?this.sort():this.dirty=!0,this},K.prototype.sort=function(){return this.values.sort(function(e,t){return+t.value- +e.value}).reverse(),this.dirty=!1,this};var Tt=xt.extend({options:{attribution:null,where:"1=1",fields:["*"],from:!1,to:!1,timeField:!1,timeFilterMode:"server",simplifyFactor:0,precision:6},initialize:function(e){xt.prototype.initialize.call(this,e),e.url=k(e.url),e=t.setOptions(this,e),this.service=W(e),this.service.addEventParent(this);if(this.options.fields[0]!=="*"){var n=!1;for(var r=0;r<this.options.fields.length;r++)this.options.fields[r].match(/^(OBJECTID|FID|OID|ID)$/i)&&(n=!0);n===!1&&O("no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.")}this.options.timeField.start&&this.options.timeField.end?(this._startTimeIndex=new K,this._endTimeIndex=new K):this.options.timeField&&(this._timeIndex=new K),this._cache={},this._currentSnapshot=[],this._activeRequests=0},onAdd:function(e){return _(e),this.service.metadata(function(t,n){if(!t){var r=n.supportedQueryFormats;r&&r.indexOf("geoJSON")!==-1&&(this.service.options.isModern=!0),!this.options.attribution&&e.attributionControl&&n.copyrightText&&(this.options.attribution=n.copyrightText,e.attributionControl.addAttribution(this.getAttribution()))}},this),e.on("zoomend",this._handleZoomChange,this),xt.prototype.onAdd.call(this,e)},onRemove:function(e){return e.off("zoomend",this._handleZoomChange,this),xt.prototype.onRemove.call(this,e)},getAttribution:function(){return this.options.attribution},createCell:function(e,t){this._requestFeatures(e,t)},_requestFeatures:function(e,n,r){return this._activeRequests++,this._activeRequests===1&&this.fire("loading",{bounds:e},!0),this._buildQuery(e).run(function(i,s,o){o&&o.exceededTransferLimit&&this.fire("drawlimitexceeded"),!i&&s&&s.features.length&&t.Util.requestAnimFrame(t.Util.bind(function(){this._addFeatures(s.features,n),this._postProcessFeatures(e)},this)),!i&&s&&!s.features.length&&this._postProcessFeatures(e),i&&this._postProcessFeatures(e),r&&r.call(this,i,s)},this)},_postProcessFeatures:function(e){this._activeRequests--,this._activeRequests<=0&&this.fire("load",{bounds:e})},_cacheKey:function(e){return e.z+":"+e.x+":"+e.y},_addFeatures:function(e,t){var n=this._cacheKey(t);this._cache[n]=this._cache[n]||[];for(var r=e.length-1;r>=0;r--){var i=e[r].id;this._currentSnapshot.push(i),this._cache[n].push(i)}this.options.timeField&&this._buildTimeIndexes(e),this.createLayers(e)},_buildQuery:function(e){var t=this.service.query().intersects(e).where(this.options.where).fields(this.options.fields).precision(this.options.precision);return this.options.simplifyFactor&&t.simplify(this._map,this.options.simplifyFactor),this.options.timeFilterMode==="server"&&this.options.from&&this.options.to&&t.between(this.options.from,this.options.to),t},setWhere:function(e,n,r){this.options.where=e&&e.length?e:"1=1";var i=[],s=[],o=0,u=null,a=t.Util.bind(function(e,a){e&&(u=e);if(a)for(var f=a.features.length-1;f>=0;f--)s.push(a.features[f].id);o--,o<=0&&(this._currentSnapshot=s,t.Util.requestAnimFrame(t.Util.bind(function(){this.removeLayers(i),this.addLayers(s),n&&n.call(r,u)},this)))},this);for(var f=this._currentSnapshot.length-1;f>=0;f--)i.push(this._currentSnapshot[f]);for(var l in this._activeCells){o++;var c=this._keyToCellCoords(l),h=this._cellCoordsToBounds(c);this._requestFeatures(h,l,a)}return this},getWhere:function(){return this.options.where},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(e,n,r,i){var s=this.options.from,o=this.options.to,u=0,a=null,f=t.Util.bind(function(t){t&&(a=t),this._filterExistingFeatures(s,o,e,n),u--,r&&u<=0&&r.call(i,a)},this);this.options.from=e,this.options.to=n,this._filterExistingFeatures(s,o,e,n);if(this.options.timeFilterMode==="server")for(var l in this._activeCells){u++;var c=this._keyToCellCoords(l),h=this._cellCoordsToBounds(c);this._requestFeatures(h,l,f)}return this},refresh:function(){for(var e in this._activeCells){var t=this._keyToCellCoords(e),n=this._cellCoordsToBounds(t);this._requestFeatures(n,e)}this.redraw&&this.once("load",function(){this.eachFeature(function(e){this._redraw(e.feature.id)},this)},this)},_filterExistingFeatures:function(e,n,r,i){var s=e&&n?this._getFeaturesInTimeRange(e,n):this._currentSnapshot,o=this._getFeaturesInTimeRange(r,i);if(o.indexOf)for(var u=0;u<o.length;u++){var a=s.indexOf(o[u]);a>=0&&s.splice(a,1)}t.Util.requestAnimFrame(t.Util.bind(function(){this.removeLayers(s),this.addLayers(o)},this))},_getFeaturesInTimeRange:function(e,t){var n=[],r;if(this.options.timeField.start&&this.options.timeField.end){var i=this._startTimeIndex.between(e,t),s=this._endTimeIndex.between(e,t);r=i.concat(s)}else r=this._timeIndex.between(e,t);for(var o=r.length-1;o>=0;o--)n.push(r[o].id);return n},_buildTimeIndexes:function(e){var t,n;if(this.options.timeField.start&&this.options.timeField.end){var r=[],i=[];for(t=e.length-1;t>=0;t--)n=e[t],r.push({id:n.id,value:new Date(n.properties[this.options.timeField.start])}),i.push({id:n.id,value:new Date(n.properties[this.options.timeField.end])});this._startTimeIndex.bulkAdd(r),this._endTimeIndex.bulkAdd(i)}else{var s=[];for(t=e.length-1;t>=0;t--)n=e[t],s.push({id:n.id,value:new Date(n.properties[this.options.timeField])});this._timeIndex.bulkAdd(s)}},_featureWithinTimeRange:function(e){if(!this.options.from||!this.options.to)return!0;var t=+this.options.from.valueOf(),n=+this.options.to.valueOf();if(typeof this.options.timeField=="string"){var r=+e.properties[this.options.timeField];return r>=t&&r<=n}if(this.options.timeField.start&&this.options.timeField.end){var i=+e.properties[this.options.timeField.start],s=+e.properties[this.options.timeField.end];return i>=t&&i<=n||s>=t&&s<=n}},_visibleZoom:function(){if(!this._map)return!1;var e=this._map.getZoom();return e>this.options.maxZoom||e<this.options.minZoom?!1:!0},_handleZoomChange:function(){if(!this._visibleZoom())this.removeLayers(this._currentSnapshot),this._currentSnapshot=[];else for(var e in this._activeCells){var t=this._activeCells[e].coords,n=this._cacheKey(t);this._cache[n]&&this.addLayers(this._cache[n])}},authenticate:function(e){return this.service.authenticate(e),this},metadata:function(e,t){return this.service.metadata(e,t),this},query:function(){return this.service.query()},_getMetadata:function(e){if(this._metadata){var n;e(n,this._metadata)}else this.metadata(t.Util.bind(function(t,n){this._metadata=n,e(t,this._metadata)},this))},addFeature:function(e,n,r){this._getMetadata(t.Util.bind(function(i,s){if(i){n&&n.call(this,i,null);return}this.service.addFeature(e,t.Util.bind(function(t,i){t||(e.properties[s.objectIdField]=i.objectId,e.id=i.objectId,this.createLayers([e])),n&&n.call(r,t,i)},this))},this))},updateFeature:function(e,t,n){this.service.updateFeature(e,function(r,i){r||(this.removeLayers([e.id],!0),this.createLayers([e])),t&&t.call(n,r,i)},this)},deleteFeature:function(e,t,n){this.service.deleteFeature(e,function(e,r){!e&&r.objectId&&this.removeLayers([r.objectId],!0),t&&t.call(n,e,r)},this)},deleteFeatures:function(e,t,n){return this.service.deleteFeatures(e,function(e,r){if(!e&&r.length>0)for(var i=0;i<r.length;i++)this.removeLayers([r[i].objectId],!0);t&&t.call(n,e,r)},this)}}),Nt=Tt.extend({options:{cacheLayers:!0},initialize:function(e){Tt.prototype.initialize.call(this,e),this._originalStyle=this.options.style,this._layers={}},onRemove:function(e){for(var t in this._layers)e.removeLayer(this._layers[t]),this.fire("removefeature",{feature:this._layers[t].feature,permanent:!1},!0);return Tt.prototype.onRemove.call(this,e)},createNewLayer:function(e){var n=t.GeoJSON.geometryToLayer(e,this.options);return n.defaultOptions=n.options,n},_updateLayer:function(e,n){var r=[],i=this.options.coordsToLatLng||t.GeoJSON.coordsToLatLng;n.properties&&(e.feature.properties=n.properties);switch(n.geometry.type){case"Point":r=t.GeoJSON.coordsToLatLng(n.geometry.coordinates),e.setLatLng(r);break;case"LineString":r=t.GeoJSON.coordsToLatLngs(n.geometry.coordinates,0,i),e.setLatLngs(r);break;case"MultiLineString":r=t.GeoJSON.coordsToLatLngs(n.geometry.coordinates,1,i),e.setLatLngs(r);break;case"Polygon":r=t.GeoJSON.coordsToLatLngs(n.geometry.coordinates,1,i),e.setLatLngs(r);break;case"MultiPolygon":r=t.GeoJSON.coordsToLatLngs(n.geometry.coordinates,2,i),e.setLatLngs(r)}},createLayers:function(e){for(var t=e.length-1;t>=0;t--){var n=e[t],r=this._layers[n.id],i;this._visibleZoom()&&r&&!this._map.hasLayer(r)&&(this._map.addLayer(r),this.fire("addfeature",{feature:r.feature},!0)),r&&this.options.simplifyFactor>0&&(r.setLatLngs||r.setLatLng)&&this._updateLayer(r,n),r||(i=this.createNewLayer(n),i.feature=n,i.addEventParent(this),this.options.onEachFeature&&this.options.onEachFeature(i.feature,i),this._layers[i.feature.id]=i,this.setFeatureStyle(i.feature.id,this.options.style),this.fire("createfeature",{feature:i.feature},!0),this._visibleZoom()&&(!this.options.timeField||this.options.timeField&&this._featureWithinTimeRange(n))&&this._map.addLayer(i))}},addLayers:function(e){for(var t=e.length-1;t>=0;t--){var n=this._layers[e[t]];n&&this._map.addLayer(n)}},removeLayers:function(e,t){for(var n=e.length-1;n>=0;n--){var r=e[n],i=this._layers[r];i&&(this.fire("removefeature",{feature:i.feature,permanent:t},!0),this._map.removeLayer(i)),i&&t&&delete this._layers[r]}},cellEnter:function(e,n){!this._zooming&&this._map&&t.Util.requestAnimFrame(t.Util.bind(function(){var e=this._cacheKey(n),t=this._cellCoordsToKey(n),r=this._cache[e];this._activeCells[t]&&r&&this.addLayers(r)},this))},cellLeave:function(e,n){this._zooming||t.Util.requestAnimFrame(t.Util.bind(function(){if(this._map){var e=this._cacheKey(n),t=this._cellCoordsToKey(n),r=this._cache[e],i=this._map.getBounds();if(!this._activeCells[t]&&r){var s=!0;for(var o=0;o<r.length;o++){var u=this._layers[r[o]];u&&u.getBounds&&i.intersects(u.getBounds())&&(s=!1)}s&&this.removeLayers(r,!this.options.cacheLayers),!this.options.cacheLayers&&s&&(delete this._cache[e],delete this._cells[t],delete this._activeCells[t])}}},this))},resetStyle:function(){return this.options.style=this._originalStyle,this.eachFeature(function(e){this.resetFeatureStyle(e.feature.id)},this),this},setStyle:function(e){return this.options.style=e,this.eachFeature(function(t){this.setFeatureStyle(t.feature.id,e)},this),this},resetFeatureStyle:function(e){var n=this._layers[e],r=this._originalStyle||t.Path.prototype.options;return n&&(t.Util.extend(n.options,n.defaultOptions),this.setFeatureStyle(e,r)),this},setFeatureStyle:function(e,t){var n=this._layers[e];return typeof t=="function"&&(t=t(n.feature)),n.setStyle&&n.setStyle(t),this},eachFeature:function(e,t){for(var n in this._layers)e.call(t,this._layers[n]);return this},getFeature:function(e){return this._layers[e]},bringToBack:function(){this.eachFeature(function(e){e.bringToBack&&e.bringToBack()})},bringToFront:function(){this.eachFeature(function(e){e.bringToFront&&e.bringToFront()})},redraw:function(e){return e&&this._redraw(e),this},_redraw:function(e){var n=this._layers[e],r=n.feature;if(n&&n.setIcon&&this.options.pointToLayer&&this.options.pointToLayer){var i=this.options.pointToLayer(r,t.latLng(r.geometry.coordinates[1],r.geometry.coordinates[0])),s=i.options.icon;n.setIcon(s)}if(n&&n.setStyle&&this.options.pointToLayer){var o=this.options.pointToLayer(r,t.latLng(r.geometry.coordinates[1],r.geometry.coordinates[0])),u=o.options;this.setFeatureStyle(r.id,u)}n&&n.setStyle&&this.options.style&&this.resetStyle(r.id)}});e.VERSION=G,e.Support=et,e.options=tt,e.Util=st,e.get=rt,e.post=i,e.request=o,e.Task=ot,e.task=H,e.Query=ut,e.query=B,e.Find=at,e.find=j,e.Identify=ft,e.identify=F,e.IdentifyFeatures=lt,e.identifyFeatures=I,e.IdentifyImage=ct,e.identifyImage=q,e.Service=ht,e.service=R,e.MapService=pt,e.mapService=U,e.ImageService=dt,e.imageService=z,e.FeatureLayerService=vt,e.featureLayerService=W,e.BasemapLayer=gt,e.basemapLayer=X,e.TiledMapLayer=yt,e.tiledMapLayer=V,e.RasterLayer=wt,e.ImageMapLayer=Et,e.imageMapLayer=$,e.DynamicMapLayer=St,e.dynamicMapLayer=J,e.FeatureManager=Tt,e.FeatureLayer=Nt,e.featureLayer=Q});