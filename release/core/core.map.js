define("core/map",["leaflet","core/baseobject","leaflet/chartLayer","leaflet/googleLayer","esri/leaflet","data/ajax","control/draw","control/layerswitch","func/realTarget","func/portInfo"],function(e){e.ICT.Map=e.ICT.BaseObject.extend({map:null,_baseLayer:null,_drawTool:null,realtarget:null,portlayer:null,OperateState:{tshf:!1,hjcx:!1,heatmap:!1},initialize:function(t){e.setOptions(this,t),this.ajax=new e.ICT.Ajax;var n=t.MapOptions.center,r=t.MapOptions.zoom,i=t.MapOptions.minZoom,s=t.MapOptions.maxZoom,o=e.CRS.EPSG3857;this.options.changeLayers.forEach(function(t,n,r){n.id==="baseLayer-ocean"&&n.active&&(o=e.CRS.EPSG3395)});var u=e.map("mappanel",{center:e.latLng(n),zoom:r,minZoom:i,maxZoom:s,crs:o,zoomControl:!1,attributionControl:!1,closePopupOnClick:!1,doubleClickZoom:!1,continuousWorld:!0,maxBounds:e.latLngBounds(e.latLng(-90,-180),e.latLng(90,180)),renderer:new e.VectorLabelCanvas});for(var a=0;a<this.options.changeLayers.length;a++){var f=this.options.changeLayers[a];switch(f.id){case"baseLayer-ocean":f.layer=e.tileLayer.ChartLayer(null,{id:f.id,opacity:0});break;case"baseLayer-googleRoadMap":f.layer=e.tileLayer.GoogleLayer(null,{id:f.id,lyrs:"m",opacity:0});break;case"baseLayer-gooleSatellite":f.layer=e.tileLayer.GoogleLayer(null,{id:f.id,lyrs:"y",opacity:0});break;default:}u.addLayer(f.layer),f.active&&(this._baseLayer=f.layer)}this._baseLayer&&this._baseLayer.setOpacity(1),this.map=u,(new e.ICT.Control.LayerSwitch).addTo(this.map).on("baseLayerChangeEvent",function(t){var n=t.curBaseLayer,r=this.getBaseLayer();this.setBaseLayer(t.curBaseLayer);if(n.options.id==="baseLayer-ocean"){var i=this.map.getCenter();this.map.options.crs=e.CRS.EPSG3395,this.map.panTo(i),this.realtarget.reloadTargets(),this.portlayer.reloadPortLayer()}else if(r.options.id==="baseLayer-ocean"){var i=this.map.getCenter();this.map.options.crs=e.CRS.EPSG3857,this.map.panTo(i),this.realtarget.reloadTargets(),this.portlayer.reloadPortLayer()}},this),e.control.zoom({position:"topright"}).addTo(this.map),e.control.scale({position:"bottomleft"}).addTo(this.map),this._attrcontrol=e.control.attribution({position:"bottomright",prefix:!1}).addTo(this.map),this.map.on("movestart",this._movestartEvt,this).on("click",this._mapClickEvt,this).on("mousemove",this._mousemoveEvt,this).on("moveend",this._moveendEvt,this),this.portlayer=new e.ICT.PortInfo(this),this.realtarget=new e.ICT.RealTarget(this),this.realtarget.addRealTargetLayer(),this.realtarget.initContextMenu()},pointChinge:function(e){Proj4js.defs["EPSG:4326"]="+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs ",Proj4js.defs["EPSG:41001"]="+title=simple mercator EPSG:41001 +proj=merc +lat_ts=0 +lon_0=0 +k=1.000000 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m";var t=new Proj4js.Proj("WGS84"),n=new Proj4js.Proj("EPSG:41001");return Proj4js.transform(n,t,e),e},_movestartEvt:function(e){this._moverstartBounds=e.target.getBounds(),this._startzoom=e.target.getZoom(),this._startcenter=e.target.getCenter()},_mousemoveEvt:function(t){var n=t.latlng,r=e.ict.app.util.tool.latlngTodfmStr(n.lat,"lat"),i=e.ict.app.util.tool.latlngTodfmStr(n.lng,"lng"),s=$.i18n.prop("common_ship_lat"),o=$.i18n.prop("common_ship_lng"),u=[];Project_ParamConfig.lang==="en"?u.push('<table style="width:280px;">'):u.push('<table style="width:230px;">'),u.push("<tr>"),u.push('<td style="width:16%;">'+o+"</td>"),u.push('<td style="width:34%;">'+i+"</td>"),u.push('<td style="width:16%;">'+s+"</td>"),u.push('<td style="width:34%;">'+r+"</td>"),u.push("</tr>"),u.push("</table>"),u=u.join("");if(this._attrcontrol){var a=this._attrcontrol.getContainer();$(a).html(u)}},_moveendEvt:function(e){if(this.hasPoppanel())return;if(!this.realtarget)return;if(this.OperateState.tshf)return;if(this.OperateState.hjcx)return;if(this.OperateState.heatmap)return;this._moveendBounds=e.target.getBounds(),this._endzoom=e.target.getZoom(),this._endcenter=e.target.getCenter(),this._moverstartBoundsExtend=this._moverstartBounds.pad(this.realtarget.config.bufferRatio),this._moveendBoundsExtend=this._moveendBounds.pad(this.realtarget.config.bufferRatio),this.portlayer.showOrHidePortLayer();if(this._endzoom!==this._startzoom||!this._startcenter.equals(this._endcenter))if(this._endzoom===this._startzoom&&!this._startcenter.equals(this._endcenter))this._endzoom>=this.realtarget.config.showLevel&&(this._moveendBoundsExtend.intersects(this._moverstartBoundsExtend)?this.realtarget.getRealTarget():this.realtarget.getRealTarget());else{if(this._startzoom<this.realtarget.config.showLevel&&this._endzoom<this.realtarget.config.showLevel)return;this._startzoom>=this.realtarget.config.showLevel&&this._endzoom>=this.realtarget.config.showLevel?(this._endzoom>this._startzoom&&this.realtarget.getRealTarget(),this._endzoom<this._startzoom&&this.realtarget.getRealTarget()):this._startzoom<this.realtarget.config.showLevel&&this._endzoom>=this.realtarget.config.showLevel?(this.realtarget.hideShipDistLayer(),this.realtarget.showRealTargetLayer()):this._startzoom>=this.realtarget.config.showLevel&&this._endzoom<this.realtarget.config.showLevel&&(this.realtarget.hideRealTargetLayer(),this.realtarget.showShipDistLayer())}},_mapClickEvt:function(e){},activate:function(t,n,r,i){this.deactivate(),this.setCursor(t);switch(t){case e.ICT.MapMouseState.PAN:break;case e.ICT.MapMouseState.ZOOM_IN:this.map.zoomIn();break;case e.ICT.MapMouseState.ZOOM_OUT:this.map.zoomOut();break;case e.ICT.MapMouseState.POINT:this._drawTool==null&&(this._drawTool=new e.ICT.Draw(this.map)),this._drawTool.point(n,i);break;case e.ICT.MapMouseState.POLYLINE:this._drawTool==null&&(this._drawTool=new e.ICT.Draw(this.map)),this._drawTool.polyline(n,i);break;case e.ICT.MapMouseState.PATH:this._drawTool==null&&(this._drawTool=new e.ICT.Draw(this.map)),this._drawTool.path(n,i);break;case e.ICT.MapMouseState.CIRCLE:this._drawTool==null&&(this._drawTool=new e.ICT.Draw(this.map)),this._drawTool.circle(n,i);break;case e.ICT.MapMouseState.RECTANGLE:this._drawTool==null&&(this._drawTool=new e.ICT.Draw(this.map)),this._drawTool.rectangle(n,i);break;case e.ICT.MapMouseState.POLYGON:this._drawTool==null&&(this._drawTool=new e.ICT.Draw(this.map)),this._drawTool.polygon(n,i);break;case e.ICT.MapMouseState.MEASURELEN:break;case e.ICT.MapMouseState.MEASUREAREA:break;default:}r!=null&&r(),this.status=t},deactivate:function(){this._drawTool&&this._drawTool.disable(),this.setCursor(e.ICT.MapMouseState.PAN)},setCursor:function(t){t==e.ICT.MapMouseState.PAN?this.map.getContainer().style.cursor="":this.map.getContainer().style.cursor="default"},setCursorImg:function(e){e!=undefined?this.map.getContainer().style.cursor="url(themes/images/cursor/"+e+"),auto":this.map.getContainer().style.cursor=""},getBaseLayer:function(){return this._baseLayer},setBaseLayer:function(e){this._baseLayer=e},getMap:function(){return this.map},getCurZoom:function(){return this.map.getZoom()},getMinZoom:function(){return this.map.getMinZoom()},getMaxZoom:function(){return this.map.getMaxZoom()},getBounds:function(){return this.map.getBounds()},getBoundsExtend:function(){return this.map.getBounds().pad(Project_ParamConfig.RealTargetConfig.bufferRatio)},hasPoppanel:function(){return this.map.getPane("popupPane").innerHTML==""?!1:!0}}),e.ICT.MapMouseState={PAN:"pan",ZOOM_IN:"zoom_in",ZOOM_OUT:"zoom_out",POINT:"point",PATH:"path",POLYLINE:"polyline",CIRCLE:"circle",RECTANGLE:"rectangle",POLYGON:"polygon",MEASURELEN:"measurelen",MEASUREAREA:"meausrearea"},e.ICT.ShipIcon={ship1:e.icon({iconUrl:"themes/images/filterdisplay/shipTypeList_1.png",iconSize:[10,22],iconAnchor:[5,11]}),ship2:e.icon({iconUrl:"themes/images/filterdisplay/shipTypeList_100.png",iconSize:[10,22],iconAnchor:[5,11]}),ship3:e.icon({iconUrl:"themes/images/filterdisplay/shipTypeList_3.png",iconSize:[10,22],iconAnchor:[5,11]}),ship4:e.icon({iconUrl:"themes/images/filterdisplay/shipTypeList_4.png",iconSize:[10,22],iconAnchor:[5,11]}),ship5:e.icon({iconUrl:"themes/images/filterdisplay/shipTypeList_5.png",iconSize:[10,22],iconAnchor:[5,11]}),ship6:e.icon({iconUrl:"themes/images/filterdisplay/shipTypeList_6.png",iconSize:[10,22],iconAnchor:[5,11]}),ship7:e.icon({iconUrl:"themes/images/filterdisplay/shipTypeList_7.png",iconSize:[10,22],iconAnchor:[5,11]}),ship8:e.icon({iconUrl:"themes/images/filterdisplay/shipTypeList_8.png",iconSize:[10,22],iconAnchor:[5,11]}),ship100:e.icon({iconUrl:"themes/images/filterdisplay/shipTypeList_100.png",iconSize:[10,22],iconAnchor:[5,11]}),close:e.icon({iconUrl:"images/dialog/hjxs_close.png",iconSize:[18,18],iconAnchor:[28,14]})}});