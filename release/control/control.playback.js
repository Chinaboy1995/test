define("control/playback",["leaflet","jquery","leaflet/playback","plugins/rangeSlider"],function(e){e.ICT.Control=e.ICT.Control||{},e.ICT.Control.PlayBack=e.Class.extend({options:{position:"topright",speed:1,Max_Speed:Math.pow(2,20),LAT_LON_TRANSFORM:6e5,trackLineOptions:{weight:2,color:"#ef0300",renderer:e.svg()},OriginCircleOptions:{stroke:!1,color:"#ef0300",fillColor:"#ef0300",fillOpacity:1,radius:4,renderer:e.svg()},layer:{},marker:{icon:e.icon({iconUrl:"themes/images/stateplayback/ship.png",iconSize:[12,25],iconAnchor:[5,12]})}},templateHtml:'<div class="playback-operation"><ul><li class="item item-start play" data-info="2" title="播放"><img src="themes/images/stateplayback/ico_play.png"></li><li class="item item-restart" data-info="3" title="重播"><img src="themes/images/stateplayback/ico_restart.png"></li><li class="item item-slow" data-info="4" title="减速"><img src="themes/images/stateplayback/ico_pre.png"></li><li class="item item-quick" data-info="5" title="加速"><img src="themes/images/stateplayback/ico_next.png"></li><li class="item item-speed"><span>X1</span></li><li class="item item-close" data-info="6" title="关闭"><img src="themes/images/stateplayback/ico_close.png"></li></ul></div><div class="playback-scrollbar"><ul><li class="item item-time"><span class="startTime"></span><span class="endTime"></span></li><li class="item item-scroll"><input type="range" class="range"></li><li class="item item-curtime"><span class="curTime"></span></li></ul></div>',initialize:function(t,n,r,i){e.setOptions(this,i),this._data=t,this._clockCallback=n,this._closeCallback=r},show:function(e){if(!e)return;return this._map=e,this.onAdd(e),this},close:function(){return e.DomUtil.remove(this._container),this.onRemove&&this.onRemove(this._map),this},onAdd:function(t){this._map=t,this._initUi(),this._initStyle();var n=this.dataTransform(this._data),r=[];for(var i=0,s=n.length;i<s;i++){var o=new e.Playback.Track(t,n[i],this.options);r.push(o)}return this._trackController=new e.Playback.TrackController(t,r,this.options),this._playbackClock=new e.Playback.Clock(this._trackController,this._clockCallback,this.options),this.setCursor(this.getStartTime()),this._initEvts(),this.setTime(),this.getStartTime()===this.getEndTime()&&e.ict.app.util.dialog.alert($.i18n.prop("dialog_alert_title"),$.i18n.prop("func_tshf_error1")),this._container},clearData:function(){this._trackController.clearTracks()},onRemove:function(){this.clearData(),typeof this._closeCallback=="function"&&this._closeCallback.call(this,this)},_initUi:function(){var t="ict-control-playback",n=this._container=e.DomUtil.create("div",t),r=this.options;n.innerHTML=this.templateHtml,$("body").append($(n));var i="ict-control-playback"+e.stamp({}),s="playback-operation"+e.stamp({});$(n).attr("id",i),$(n).find(".playback-operation").attr("id",s),e.ict.app.util.tool.drag(i,s),$(n).find(".playback-operation .item-speed span").text("X"+this.options.speed)},_initStyle:function(){var e=$(this._container);e.find(".item-start").attr("title",$.i18n.prop("control_playback_play")),e.find(".item-restart").attr("title",$.i18n.prop("control_playback_again")),e.find(".item-slow").attr("title",$.i18n.prop("control_playback_slowdown")),e.find(".item-quick").attr("title",$.i18n.prop("control_playback_speedup")),e.find(".item-close").attr("title",$.i18n.prop("control_playback_close"))},_initEvts:function(){var t=this,n=$(t._container).find(".playback-operation>ul>li"),r=$(t._container).find(".playback-scrollbar input")[0];n.each(function(){e.DomEvent.on(this,"mousedown dbclick",e.DomEvent.stopPropagation).on(this,"click",e.DomEvent.stop).on(this,"click",t._btnClick,t)}),r.min=t.getStartTime(),r.max=t.getEndTime(),r.value=t.getTime(),e.DomEvent.on(r,"click mousedown dbclick",e.DomEvent.stopPropagation).on(r,"click",e.DomEvent.preventDefault).on(r,"change",t._onRangeChange,t).on(r,"mousemove",t._onRangeChange,t),t.addCallback(function(e){r.value=e;var t=parseInt((e-r.min)/(r.max-r.min)*100);$(r).css("background-size",t+"% 100%")}),t.addCallback(function(e){if(e>=t.getEndTime()){var n=$(t._container).find(".playback-operation>ul>li.item-start");n.addClass("play"),n.find("img").attr("src","themes/images/stateplayback/ico_play.png"),n.attr("title",$.i18n.prop("control_playback_play"))}})},_btnClick:function(e){var t=$(e.currentTarget),n=$(e.currentTarget).data("info");switch(n){case 1:break;case 2:t.hasClass("play")?(t.removeClass("play"),t.find("img").attr("src","themes/images/stateplayback/ico_push.png"),t.attr("title",$.i18n.prop("control_playback_pause")),this.start()):(t.addClass("play"),t.find("img").attr("src","themes/images/stateplayback/ico_play.png"),t.attr("title",$.i18n.prop("control_playback_play")),this.stop());break;case 3:t.siblings(".item-start").removeClass("play"),t.siblings(".item-start").find("img").attr("src","themes/images/stateplayback/ico_push.png"),t.siblings(".item-start").attr("title",$.i18n.prop("control_playback_pause")),this.rePlaying();break;case 4:this.slowSpeed();break;case 5:this.quickSpeed();break;case 6:this.close();break;default:}},_onRangeChange:function(e){var t=Number(e.target.value);this.setCursor(t)},setTime:function(){var t=$(this._container),n=e.ict.app.util.dateTime.formatDateHM(new Date(this.getStartTime())),r=e.ict.app.util.dateTime.formatDateHM(new Date(this.getEndTime())),i=e.ict.app.util.dateTime.formatDateHM(new Date(this.getTime()));t.find(".playback-scrollbar .startTime").text(n),t.find(".playback-scrollbar .endTime").text(r),t.find(".playback-scrollbar .curTime").text(i);var s=this;this.addCallback(function(){i=e.ict.app.util.dateTime.formatDateHM(new Date(s.getTime())),t.find(".playback-scrollbar .curTime").text(i)})},addCallback:function(e){this._playbackClock.addCallback(e)},start:function(){this._playbackClock.start()},stop:function(){this._playbackClock.stop()},quickSpeed:function(){this._playbackClock.quickSpeed();var e=this._playbackClock.getSpeed();$(this._container).find(".playback-operation .item-speed span").text("X"+e)},slowSpeed:function(){this._playbackClock.slowSpeed();var e=this._playbackClock.getSpeed();$(this._container).find(".playback-operation .item-speed span").text("X"+e)},rePlaying:function(){this._playbackClock.rePlaying()},getSpeed:function(){return this._playbackClock.getSpeed()},isPlaying:function(){return this._playbackClock.isPlaying()},setSpeed:function(e){this._playbackClock.setSpeed(e)},setCursor:function(e){this._playbackClock.setCursor(e)},getTime:function(){return this._playbackClock.getTime()},getStartTime:function(){return this._playbackClock.getStartTime()},getEndTime:function(){return this._playbackClock.getEndTime()},getTickLen:function(){return this._playbackClock.getTickLen()},dataTransform:function(t){if(!t||!t.length){console.log("playback_error:data transform error!");return}var n=[];for(var r=0,i=t.length;r<i;r++){var s=t[r].num,o={};o.timePosList=[];for(var u=0,a=t[r].posList.length;u<a;u++){var f={},l=t[r].posList[u];f.lng=l.lo/this.options.LAT_LON_TRANSFORM,f.lat=l.la/this.options.LAT_LON_TRANSFORM,f.time=l.ti*1e3,f.dir=parseFloat(l.co/10),f.heading=parseInt(l.he),f.speed=parseFloat(l.sp/10),f.info_ph=s,f.info_lng=e.ict.app.util.tool.latlngTodfmStr(f.lng,"lng"),f.info_lat=e.ict.app.util.tool.latlngTodfmStr(f.lat,"lat"),f.info_time=e.ict.app.util.dateTime.formatDateHM(new Date(l.ti*1e3)),f.info_dir=(l.co/10).toFixed(1)+"°",f.info_heading=l.he+"°",f.info_speed=parseInt(l.sp/10)+" "+$.i18n.prop("common_ship_speed_unit"),o.timePosList.push(f)}n.push(o)}return n}})});