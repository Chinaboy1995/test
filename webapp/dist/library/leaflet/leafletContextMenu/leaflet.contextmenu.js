/*
	Leaflet.contextmenu, a context menu for Leaflet.
	(c) 2015, Adam Ratcliffe, GeoSmart Maps Limited

	@preserve
*/

(function(e){var t;if(typeof define=="function"&&define.amd)define(["leaflet"],e);else if(typeof module=="object"&&typeof module.exports=="object")t=require("leaflet"),module.exports=e(t);else{if(typeof window.L=="undefined")throw new Error("Leaflet must be loaded first");e(window.L)}})(function(e){e.Map.mergeOptions({contextmenuItems:[]}),e.Map.ContextMenu=e.Handler.extend({_touchstart:e.Browser.msPointer?"MSPointerDown":e.Browser.pointer?"pointerdown":"touchstart",statics:{BASE_CLS:"leaflet-contextmenu"},initialize:function(t){e.Handler.prototype.initialize.call(this,t),this._items=[],this._visible=!1;var n=this._container=e.DomUtil.create("div",e.Map.ContextMenu.BASE_CLS,t._container);n.style.zIndex=1e4,n.style.position="absolute",t.options.contextmenuWidth&&(n.style.width=t.options.contextmenuWidth+"px"),this._createItems(),e.DomEvent.on(n,"click",e.DomEvent.stop).on(n,"mousedown",e.DomEvent.stop).on(n,"dblclick",e.DomEvent.stop).on(n,"contextmenu",e.DomEvent.stop)},addHooks:function(){var t=this._map.getContainer();e.DomEvent.on(t,"mouseleave",this._hide,this).on(document,"keydown",this._onKeyDown,this),e.Browser.touch&&e.DomEvent.on(document,this._touchstart,this._hide,this),this._map.on({contextmenu:this._show,mousedown:this._hide,movestart:this._hide,zoomstart:this._hide},this)},removeHooks:function(){var t=this._map.getContainer();e.DomEvent.off(t,"mouseleave",this._hide,this).off(document,"keydown",this._onKeyDown,this),e.Browser.touch&&e.DomEvent.off(document,this._touchstart,this._hide,this),this._map.off({contextmenu:this._show,mousedown:this._hide,movestart:this._hide,zoomstart:this._hide},this)},showAt:function(t,n){t instanceof e.LatLng&&(t=this._map.latLngToContainerPoint(t)),this._showAtPoint(t,n)},hide:function(){this._hide()},addItem:function(e){return this.insertItem(e)},insertItem:function(e,t){t=t!==undefined?t:this._items.length;var n=this._createItem(this._container,e,t);return this._items.push(n),this._sizeChanged=!0,this._map.fire("contextmenu.additem",{contextmenu:this,el:n.el,index:t}),n.el},removeItem:function(t){var n=this._container;isNaN(t)||(t=n.children[t]),t&&(this._removeItem(e.Util.stamp(t)),this._sizeChanged=!0,this._map.fire("contextmenu.removeitem",{contextmenu:this,el:t}))},removeAllItems:function(){var t;while(this._container.children.length)t=this._container.children[0],this._removeItem(e.Util.stamp(t))},hideAllItems:function(){var e,t,n;for(t=0,n=this._items.length;t<n;t++)e=this._items[t],e.el.style.display="none"},showAllItems:function(){var e,t,n;for(t=0,n=this._items.length;t<n;t++)e=this._items[t],e.el.style.display=""},setDisabled:function(t,n){var r=this._container,i=e.Map.ContextMenu.BASE_CLS+"-item";isNaN(t)||(t=r.children[t]),t&&e.DomUtil.hasClass(t,i)&&(n?(e.DomUtil.addClass(t,i+"-disabled"),this._map.fire("contextmenu.disableitem",{contextmenu:this,el:t})):(e.DomUtil.removeClass(t,i+"-disabled"),this._map.fire("contextmenu.enableitem",{contextmenu:this,el:t})))},isVisible:function(){return this._visible},_createItems:function(){var e=this._map.options.contextmenuItems,t,n,r;for(n=0,r=e.length;n<r;n++)this._items.push(this._createItem(this._container,e[n]))},_createItem:function(t,n,r){if(n.separator||n==="-")return this._createSeparator(t,r);var i=e.Map.ContextMenu.BASE_CLS+"-item",s=n.disabled?i+" "+i+"-disabled":i,o=this._insertElementAt("a",s,t,r),u=this._createEventHandler(o,n.callback,n.context,n.hideOnSelect),a=this._getIcon(n),f=this._getIconCls(n),l="";return a?l='<img class="'+e.Map.ContextMenu.BASE_CLS+'-icon" src="'+a+'"/>':f&&(l='<span class="'+e.Map.ContextMenu.BASE_CLS+"-icon "+f+'"></span>'),o.innerHTML=l+n.text,o.href="#",e.DomEvent.on(o,"mouseover",this._onItemMouseOver,this).on(o,"mouseout",this._onItemMouseOut,this).on(o,"mousedown",e.DomEvent.stopPropagation).on(o,"click",u),e.Browser.touch&&e.DomEvent.on(o,this._touchstart,e.DomEvent.stopPropagation),e.Browser.pointer||e.DomEvent.on(o,"click",this._onItemMouseOut,this),{id:e.Util.stamp(o),el:o,callback:u}},_removeItem:function(t){var n,r,i,s,o;for(i=0,s=this._items.length;i<s;i++){n=this._items[i];if(n.id===t)return r=n.el,o=n.callback,o&&(e.DomEvent.off(r,"mouseover",this._onItemMouseOver,this).off(r,"mouseover",this._onItemMouseOut,this).off(r,"mousedown",e.DomEvent.stopPropagation).off(r,"click",o),e.Browser.touch&&e.DomEvent.off(r,this._touchstart,e.DomEvent.stopPropagation),e.Browser.pointer||e.DomEvent.on(r,"click",this._onItemMouseOut,this)),this._container.removeChild(r),this._items.splice(i,1),n}return null},_createSeparator:function(t,n){var r=this._insertElementAt("div",e.Map.ContextMenu.BASE_CLS+"-separator",t,n);return{id:e.Util.stamp(r),el:r}},_createEventHandler:function(t,n,r,i){var s=this,o=this._map,u=e.Map.ContextMenu.BASE_CLS+"-item-disabled",i=i!==undefined?i:!0;return function(a){if(e.DomUtil.hasClass(t,u))return;i&&s._hide(),n&&n.call(r||o,s._showLocation),s._map.fire("contextmenu:select",{contextmenu:s,el:t})}},_insertElementAt:function(e,t,n,r){var i,s=document.createElement(e);return s.className=t,r!==undefined&&(i=n.children[r]),i?n.insertBefore(s,i):n.appendChild(s),s},_show:function(e){this._showAtPoint(e.containerPoint,e)},_showAtPoint:function(t,n){if(this._items.length){var r=this._map,i=r.containerPointToLayerPoint(t),s=r.layerPointToLatLng(i),o=e.extend(n||{},{contextmenu:this});this._showLocation={latlng:s,layerPoint:i,containerPoint:t},n&&n.relatedTarget&&(this._showLocation.relatedTarget=n.relatedTarget),this._setPosition(t),this._visible||(this._container.style.display="block",this._visible=!0),this._map.fire("contextmenu.show",o)}},_hide:function(){this._visible&&(this._visible=!1,this._container.style.display="none",this._map.fire("contextmenu.hide",{contextmenu:this}))},_getIcon:function(t){return e.Browser.retina&&t.retinaIcon||t.icon},_getIconCls:function(t){return e.Browser.retina&&t.retinaIconCls||t.iconCls},_setPosition:function(t){var n=this._map.getSize(),r=this._container,i=this._getElementSize(r),s;this._map.options.contextmenuAnchor&&(s=e.point(this._map.options.contextmenuAnchor),t=t.add(s)),r._leaflet_pos=t,t.x+i.x>n.x?(r.style.left="auto",r.style.right=Math.min(Math.max(n.x-t.x,0),n.x-i.x-1)+"px"):(r.style.left=Math.max(t.x,0)+"px",r.style.right="auto"),t.y+i.y>n.y?(r.style.top="auto",r.style.bottom=Math.min(Math.max(n.y-t.y,0),n.y-i.y-1)+"px"):(r.style.top=Math.max(t.y,0)+"px",r.style.bottom="auto")},_getElementSize:function(e){var t=this._size,n=e.style.display;if(!t||this._sizeChanged)t={},e.style.left="-999999px",e.style.right="auto",e.style.display="block",t.x=e.offsetWidth,t.y=e.offsetHeight,e.style.left="auto",e.style.display=n,this._sizeChanged=!1;return t},_onKeyDown:function(e){var t=e.keyCode;t===27&&this._hide()},_onItemMouseOver:function(t){e.DomUtil.addClass(t.target||t.srcElement,"over")},_onItemMouseOut:function(t){e.DomUtil.removeClass(t.target||t.srcElement,"over")}}),e.Map.addInitHook("addHandler","contextmenu",e.Map.ContextMenu),e.Mixin.ContextMenu={bindContextMenu:function(t){return e.setOptions(this,t),this._initContextMenu(),this},unbindContextMenu:function(){return this.off("contextmenu",this._showContextMenu,this),this},addContextMenuItem:function(e){this.options.contextmenuItems.push(e)},removeContextMenuItemWithIndex:function(e){var t=[];for(var n=0;n<this.options.contextmenuItems.length;n++)this.options.contextmenuItems[n].index==e&&t.push(n);var r=t.pop();while(r!==undefined)this.options.contextmenuItems.splice(r,1),r=t.pop()},replaceContextMenuItem:function(e){this.removeContextMenuItemWithIndex(e.index),this.addContextMenuItem(e)},_initContextMenu:function(){this._items=[],this.on("contextmenu",this._showContextMenu,this)},_showContextMenu:function(t){var n,r,i,s,o;if(this._map.contextmenu){r=e.extend({relatedTarget:this},t),i=this._map.mouseEventToContainerPoint(t.originalEvent),this.options.contextmenuInheritItems||this._map.contextmenu.hideAllItems();for(s=0,o=this.options.contextmenuItems.length;s<o;s++)n=this.options.contextmenuItems[s],this._items.push(this._map.contextmenu.insertItem(n,n.index));this._map.once("contextmenu.hide",this._hideContextMenu,this),this._map.contextmenu.showAt(i,r)}},_hideContextMenu:function(){var e,t;for(e=0,t=this._items.length;e<t;e++)this._map.contextmenu.removeItem(this._items[e]);this._items.length=0,this.options.contextmenuInheritItems||this._map.contextmenu.showAllItems()}};var t=[e.Marker,e.Path],n={contextmenu:!1,contextmenuItems:[],contextmenuInheritItems:!0},r,i,s;for(i=0,s=t.length;i<s;i++)r=t[i],r.prototype.options?r.mergeOptions(n):r.prototype.options=n,r.addInitHook(function(){this.options.contextmenu&&this._initContextMenu()}),r.include(e.Mixin.ContextMenu);return e.Map.ContextMenu});