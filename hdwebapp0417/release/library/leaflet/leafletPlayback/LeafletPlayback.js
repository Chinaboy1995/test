(function(e){var t;if(typeof define=="function"&&define.amd)define(["leaflet"],e);else if(typeof module=="object"&&typeof module.exports=="object")t=require("leaflet"),module.exports=e(t);else{if(typeof window.L=="undefined")throw"Leaflet must be loaded first";e(window.L)}})(function(e){e.Playback=e.Playback||{},e.Playback.MoveableMarker=e.Marker.extend({initialize:function(t,n,r){var i=n.marker||{};jQuery.isFunction(i)&&(i=i(r)),e.Marker.prototype.initialize.call(this,t,i),this.popupContent="",this.feature=r,i.getPopup&&(this.popupContent=i.getPopup(r)),n.popups&&this.bindPopup(this.getPopupContent()+t.toString()),n.labels&&(this.bindLabel?this.bindLabel(this.getPopupContent(),{noHide:!0}):console.log("Label binding requires leaflet-label (https://github.com/Leaflet/Leaflet.label)"))},getPopupContent:function(){return this.popupContent!==""?"<b>"+this.popupContent+"</b><br/>":""},move:function(t,n){e.DomUtil.TRANSITION&&(this._icon&&(this._icon.style[e.DomUtil.TRANSITION]="all "+n+"ms linear",this._popup&&this._popup._wrapper&&(this._popup._wrapper.style[e.DomUtil.TRANSITION]="all "+n+"ms linear")),this._shadow&&(this._shadow.style[e.DomUtil.TRANSITION]="all "+n+"ms linear")),this.setLatLng(t),this._popup&&this._popup.setContent(this.getPopupContent()+this._latlng.toString())},_old__setPos:e.Marker.prototype._setPos,_updateImg:function(t,n,r){n=e.point(r).divideBy(2)._subtract(e.point(n));var i="";i+=" rotate("+this.options.iconAngle+"deg)",t.style[e.DomUtil.TRANSFORM]+=i,t.style.transformOrigin="50% 50%"},setIconAngle:function(e){this.options.iconAngle=e,this._map&&this.update()},_setPos:function(t){this._icon&&(this._icon.style[e.DomUtil.TRANSFORM]=""),this._shadow&&(this._shadow.style[e.DomUtil.TRANSFORM]=""),this._old__setPos.apply(this,[t]);if(this.options.iconAngle){var n=this.options.icon.options.iconAnchor,r=this.options.icon.options.iconSize,i;this._icon&&(i=this._icon,this._updateImg(i,n,r)),this._shadow&&(r=this.options.icon.options.shadowSize,i=this._shadow,this._updateImg(i,n,r))}}}),e.Playback.Track=e.Class.extend({initialize:function(t,n,r){this._map=t,this.options=r||{},this._dataObj=n,this._ticks=[],this._times=[],this._marker=null;var i=n.timePosList;for(var s=0,o=i.length;s<o;s++){var u=i[s].time;this._times.push(u),this._ticks[u]=i[s],s===0&&(this._startTime=u),s===o-1&&(this._endTime=u)}this._trackLineFeatureGroup||(this._trackLineFeatureGroup=e.featureGroup([]).addTo(this._map)),this._trackPointFeatureGroup||(this._trackPointFeatureGroup=e.featureGroup([]).addTo(this._map))},getFirstTick:function(){return this._ticks[this._startTime]},getLastTick:function(){return this._ticks[this._endTime]},getStartTime:function(){return this._startTime},getEndTime:function(){return this._endTime},getTimes:function(){return this._times},getTimeInterval:function(e){var t=this._times.indexOf(e);if(t!==-1&&t!==this._times.length-1)var n=this._times[t+1],r=n-e;return r},tick:function(e){return this._ticks[e]},getLatLng:function(t){var n=this.tick(t);if(n)return e.latLng(n.lat,n.lng)},setMarker:function(t,n){var r=null;return t?r=this.getLatLng(t):r=this.getLatLng(this._startTime),r&&(this._marker=new e.Playback.MoveableMarker(r,n,this._dataObj)),this._marker},getMarker:function(){return this._marker},createTrackPoint:function(t){var n=this.getLatLng(t);if(n)var r=e.circleMarker(n,this.options.OriginCircleOptions);var i=this.tick(t);return r&&i&&r.bindTooltip(this.getTooltipText(i),this.getTooltipOptions()),this._marker&&(this._marker.unbindTooltip(),this._marker.bindTooltip(this.getTooltipText(i),this.getTooltipOptions())),r},getTooltipText:function(e){var t=$.i18n.prop("common_ship_ph"),n=$.i18n.prop("common_ship_lng"),r=$.i18n.prop("common_ship_lat"),i=$.i18n.prop("common_time_info1"),s=$.i18n.prop("common_ship_dir"),o=$.i18n.prop("common_ship_heading"),u=$.i18n.prop("common_ship_speed"),a=[];return a.push("<table>"),a.push("<tr><td>MMSI:</td><td>"+e.info_ph+"</td></tr>"),a.push("<tr><td>"+n+"</td><td>"+e.info_lng+"</td></tr>"),a.push("<tr><td>"+r+"</td><td>"+e.info_lat+"</td></tr>"),a.push("<tr><td>"+i+"</td><td>"+e.info_time+"</td></tr>"),a.push("<tr><td>"+s+"</td><td>"+e.info_dir+"</td></tr>"),a.push("<tr><td>"+o+"</td><td>"+e.info_heading+"</td></tr>"),a.push("<tr><td>"+u+"</td><td>"+e.info_speed+"</td></tr>"),a.push("</table>"),a=a.join(""),a},getTooltipOptions:function(){return{offset:[0,0],direction:"top",permanent:!1}},moveMarker:function(t,n,r){if(this._marker){var i=this._marker.getLatLng(),s=this.tick(r);if(n!==0){this._marker.move(t,n),this._marker.setIconAngle(s.dir);var o=[[i.lat,i.lng],[t.lat,t.lng]],u=e.polyline(o,this.options.trackLineOptions),a=this.createTrackPoint(r),f=this;(function(e,t,n){f._timeoutTicker=setTimeout(function(){f._trackLineFeatureGroup.addLayer(e),f._trackPointFeatureGroup.addLayer(t)},n)})(u,a,n)}else this.clearTrackInfo(),this.drawHistoryTrackLine(r),this.drawHistoryTrackPoints(r)}},drawHistoryTrackLine:function(t){var n=[];for(var r=0,i=this._times.length;r<i;r++)if(this._times[r]<=t){var s=this.getLatLng(this._times[r]);s&&n.push(s)}var o=e.polyline(n,this.options.trackLineOptions);this._trackLineFeatureGroup.addLayer(o)},drawHistoryTrackPoints:function(e){for(var t=0,n=this._times.length;t<n;t++)if(this._times[t]<=e){var r=this.createTrackPoint2(this._times[t]);r&&this._trackPointFeatureGroup.addLayer(r)}},createTrackPoint2:function(t){var n=this.getLatLng(t);if(n)var r=e.circleMarker(n,this.options.OriginCircleOptions);var i=this.tick(t);return i&&r.bindTooltip(this.getTooltipText(i),this.getTooltipOptions()),this._marker&&(this._marker.setLatLng(n),this._marker.setIconAngle(i.dir),this._marker.unbindTooltip(),this._marker.bindTooltip(this.getTooltipText(i),this.getTooltipOptions())),r},clearTrackInfo:function(){try{this._timeoutTicker&&(clearTimeout(this._timeoutTicker),this._timeoutTicker=null),this._trackLineFeatureGroup&&this._trackLineFeatureGroup.clearLayers(),this._trackPointFeatureGroup&&this._trackPointFeatureGroup.clearLayers()}catch(e){console.log("tshf:clearlayer error")}}}),e.Playback.TrackController=e.Class.extend({initialize:function(e,t,n){this.options=n||{},this._map=e,this._tracks=[],this.setTracks(t)},clearTracks:function(){while(this._tracks.length>0){var e=this._tracks.pop(),t=e.getMarker();t&&this._map.removeLayer(t),e.clearTrackInfo()}},clearLineAndPoint:function(){for(var e=0,t=this._tracks.length;e<t;e++){var n=this._tracks[e];n.clearTrackInfo()}},setTracks:function(e){this.clearTracks(),this.addTracks(e)},addTracks:function(e){if(!e)return;if(e instanceof Array)for(var t=0,n=e.length;t<n;t++)this.addTrack(e[t]);else this.addTrack(e)},addTrack:function(e,t){if(!e)return;var n=e.setMarker(t,this.options);n&&(n.addTo(this._map),this._map.panTo(n.getLatLng()),this._tracks.push(e))},tock:function(e,t){for(var n=0,r=this._tracks.length;n<r;n++){var i=this._tracks[n].getLatLng(e);(t===0||i)&&this._tracks[n].moveMarker(i,t,e)}},getStartTime:function(){var e=0;if(this._tracks.length>0){e=this._tracks[0].getStartTime();for(var t=1,n=this._tracks.length;t<n;t++){var r=this._tracks[t].getStartTime();r<e&&(e=r)}}return e},getEndTime:function(){var e=0;if(this._tracks.length>0){e=this._tracks[0].getEndTime();for(var t=1,n=this._tracks.length;t<n;t++){var r=this._tracks[t].getEndTime();r>e&&(e=r)}}return e},getAllTimes:function(){var e=[];if(this._tracks.length>0)for(var t=0,n=this._tracks.length;t<n;t++){var r=this._tracks[t].getTimes();e=e.concat(r)}e=this.uniqueArr(e);for(var t=0,i=e.length;t<i-1;t++)for(var s=0;s<i-1-t;s++)if(e[s]>e[s+1]){var o=e[s];e[s]=e[s+1],e[s+1]=o}return e},uniqueArr:function(e){var t=[];for(var n=0,r=e.length;n<r;n++)t.indexOf(e[n])===-1&&t.push(e[n]);return t},getTracks:function(){return this._tracks}}),e.Playback.Clock=e.Class.extend({initialize:function(t,n,r){this._trackController=t,this._callbacksArry=[],n&&this.addCallback(n),e.setOptions(this,r),this._speed=this.options.speed,this.max_speed=this.options.Max_Speed,this._alltime=this._trackController.getAllTimes(),this._cursor=t.getStartTime(),this._alltime.length&&(this._tickLen=3e5/this._alltime.length)},_tick:function(e){this._cursor=this.getNextTime();if(!this._cursor||this._cursor>this.getEndTime()){clearTimeout(this._intervalID),this._intervalID=null;return}this._trackController.tock(this._cursor,e),this._callbacks(this._cursor)},_callbacks:function(e){var t=this._callbacksArry;for(var n=0,r=t.length;n<r;n++)t[n](e)},addCallback:function(e){this._callbacksArry.push(e)},getTransitionTime:function(){var e=this._cursor,t=this.getNextTime(),n=this._tickLen/this._speed;return e&&t&&t>e&&(n=(t-e)/this._speed),n},start:function(){if(this._intervalID)return;this._intervalID=!0;var e=this;(function t(){if(!e._intervalID)return;var n=e.getTransitionTime();clearTimeout(e._intervalID),e._intervalID=setTimeout(function(){e._tick(n),t()},n)})()},stop:function(){if(!this._intervalID)return;clearTimeout(this._intervalID),this._intervalID=null},getSpeed:function(){return this._speed},isPlaying:function(){return this._intervalID?!0:!1},setSpeed:function(e){this._speed=e,this._intervalID&&(this.stop(),this.start())},quickSpeed:function(){this._speed=this._speed>=this.max_speed?this._speed:this._speed*2,this._intervalID&&(this.stop(),this.start())},slowSpeed:function(){this._speed=this._speed<=1?this._speed:this._speed/2,this._intervalID&&(this.stop(),this.start())},rePlaying:function(){this._trackController.clearLineAndPoint(),this.isPlaying()&&this.stop(),this.setCursor(this.getStartTime()),this.start()},setCursor:function(e){var t=this.getValidCursor(e);if(!t)return;this._cursor=t,this._trackController.tock(this._cursor,0),this._callbacks(this._cursor)},getValidCursor:function(e){var t;if(e<=this.getEndTime()&&e>=this.getStartTime()){t=e;for(var n=0,r=this._alltime.length;n<r;n++)if(this._alltime[n]>=t){t=this._alltime[n];break}}return t},getTime:function(){return this._cursor},getAllTime:function(){return this._alltime},getStartTime:function(){return this._trackController.getStartTime()},getEndTime:function(){return this._trackController.getEndTime()},getLastTime:function(){var e,t=this._alltime.indexOf(this._cursor);return t!==-1&&t!==0&&(e=this._alltime[t-1]),e},getNextTime:function(){var e,t=this._alltime.indexOf(this._cursor);return t!==-1&&t!==this._alltime.length-1&&(e=this._alltime[t+1]),e},getTickLen:function(){return this._tickLen}})});