define("func/portInfo",["leaflet","echarts","func/base","data/ajax","control/panel","plugins/mcscroll"],function(e,t){e.ICT.PortInfo=e.Class.extend({initialize:function(t){this.config=Project_ParamConfig.PortConfig,this.ajax=new e.ICT.Ajax,this.ictmap=t,this._portList=[],this._portLayerList=[],this.portLayerGroup=e.featureGroup([]),this.ictmap.map.addLayer(this.portLayerGroup),this.getPortList()},getPortList:function(){var e=this.config.listUrl;this.ajax.get(e,null,!0,this,function(e){if(e.state!==1)console.error(e.msg.error);else{var t=e.msg.portsList;this._portList=[];for(var n=0,r=t.length;n<r;n++){var i=this.convertPortObj(t[n]);this._portList.push(i)}this.setPortLayerList(),this.addPortLayer()}},function(e){console.error("获取港口信息列表出错！")})},convertPortObj:function(e){var t={};return t.id=e.id,t.cc=e.cc,t.lon=e.lo/6e5,t.lat=e.la/6e5,t.name=e.pn,t},createPortMarker:function(t,n){n=n===undefined?!0:n;var r=e.latLng(t.lat,t.lon),i=t.name,s=e.icon({iconUrl:"themes/images/shipIcons/port.png",iconSize:[20,20],iconAnchor:[10,10]}),o={icon:s,title:i,data:t},u=e.marker(r,o);return n&&u.on("click",this.portClickEvt,this),u},portClickEvt:function(e){var t=e.target,n={},r=this.config.infoUrl;n.id=t.options.data.id,this.ajax.post(r,n,!0,this,function(e){if(e.state!=1)console.error(e.msg.error);else{var n=this.convertPortInfoObj(e.msg.portObject),r={maxWidth:300,minWidth:300,className:"ict_portInfo_popupContainer"};t.on("popupopen",function(){this._initInfoPopEvts()},this),t.bindPopup(this.getPopupContent(n),r).openPopup()}},function(e){console.error("获取港口信息出错！")})},locateByPortId:function(e){var t=this.getPortById(e);t&&(this.ictmap.map.setView(t.getLatLng(),this.config.showLevel),t.fire("click"))},portStastic:function(t){var n=this.config.portStaticUrl;this.ajax.post(n,t,!0,this,function(t){t.state!==1?(console.error(t.msg.error),e.ict.app.util.dialog.error($.i18n.prop("dialog_alert_title"),$.i18n.prop("port_info_stastic_error"))):(this._locatePortLyr.closePopup(),this.showStasticRes(t))},function(t){e.ict.app.util.dialog.error($.i18n.prop("dialog_alert_title"),$.i18n.prop("port_info_stastic_error"))})},showStasticRes:function(t){var n={title:$.i18n.prop("port_static_title"),width:800,height:600};n.contentHTML=this.getStasticHtml(t);var r=this._stasticPanel=new e.ICT.PopPanel(n);r.show(),this._initStasticEvts(),this.initecharts(t)},getStasticHtml:function(e){var t=$.i18n.prop("port_static_chart"),n=$.i18n.prop("port_static_table"),r=[];return r.push('<div class="port_stastic_container">'),r.push('<div class="titleDiv">'),r.push('<ul class="nav nav_titleNav">'),r.push('<li class="active" data-info="chart"><a href="#" >'+t+"</a></li>"),r.push('<li data-info="table"><a href="#">'+n+"</a></li>"),r.push("</ul>"),r.push("</div>"),r.push('<div class="contentDiv">'),r.push(this.getstasticChartHtml(e)),r.push(this.getstasticTableHtml(e)),r.push("</div>"),r.push("</div>"),r.join("")},getstasticChartHtml:function(e){var t=$.i18n.prop("port_static_qysr"),n=$.i18n.prop("port_static_qysl"),r=[];return r.push('<div class="stasticChartDiv" style="display:block;">'),r.push("<p>"+t+"</p>"),r.push('<div class="stastic_chart_enter"></div>'),r.push("<p>"+n+"</p>"),r.push('<div class="stastic_chart_out"></div>'),r.push("</div>"),r.join("")},getstasticTableHtml:function(e){var t=e.msg.shipDst,n=e.msg.shipSrc,r=t.length,i=n.length,s=$.i18n.prop("port_static_qysrcount",r),o=$.i18n.prop("port_static_qyslcount",i),u=$.i18n.prop("common_ship_country"),a=$.i18n.prop("func_filter_shiptype_1"),f=$.i18n.prop("func_filter_shiptype_3"),l=$.i18n.prop("func_filter_shiptype_6"),c=$.i18n.prop("func_filter_shiptype_5"),h=$.i18n.prop("func_filter_shiptype_7"),p=$.i18n.prop("func_filter_shiptype_8"),d=$.i18n.prop("func_filter_shiptype_100"),v=[];v.push('<div class="stasticTableDiv" style="display:none;">'),v.push("<p>"+s+"</p>"),v.push('<div class="stastic_table_enter">'),v.push("<table>"),v.push("<thead><tr><th>"+u+"</th><th>"+a+"</th><th>"+f+"</th><th>"+l+"</th><th>"+c+"</th><th>"+h+"</th><th>"+p+"</th><th>"+d+"</th></tr></thead>"),v.push("<tbody>");for(var m=0,g=t.length;m<g;m++){var y=t[m];v.push("<tr>"),v.push('<td><img src="themes/images/country/'+y.countryCn.trim()+'.png">'+y.countryCn+"</td>"),v.push("<td>"+y.shiphuo+"</td>"),v.push("<td>"+y.shipyou+"</td>"),v.push("<td>"+y.shiptuo+"</td>"),v.push("<td>"+y.shipyu+"</td>"),v.push("<td>"+y.shipke+"</td>"),v.push("<td>"+y.shipjun+"</td>"),v.push("<td>"+y.shipother+"</td>"),v.push("</tr>"),m<g-1&&v.push('<tr class="splitTr"><td colspan="8">&nbsp</td></tr>')}v.push("</tbody>"),v.push("</table>"),v.push("</div>"),v.push("<p>"+o+"</p>"),v.push('<div class="stastic_table_out">'),v.push("<table>"),v.push("<thead><tr><th>"+u+"</th><th>"+a+"</th><th>"+f+"</th><th>"+l+"</th><th>"+c+"</th><th>"+h+"</th><th>"+p+"</th><th>"+d+"</th></tr></thead>"),v.push("<tbody>");for(var m=0,g=n.length;m<g;m++){var b=n[m];v.push("<tr>"),v.push('<td><img src="themes/images/country/'+b.countryCn.trim()+'.png">'+b.countryCn+"</td>"),v.push("<td>"+b.shiphuo+"</td>"),v.push("<td>"+b.shipyou+"</td>"),v.push("<td>"+b.shiptuo+"</td>"),v.push("<td>"+b.shipyu+"</td>"),v.push("<td>"+b.shipke+"</td>"),v.push("<td>"+b.shipjun+"</td>"),v.push("<td>"+b.shipother+"</td>"),v.push("</tr>"),m<g-1&&v.push('<tr class="splitTr"><td colspan="8">&nbsp</td></tr>')}return v.push("</tbody>"),v.push("</table>"),v.push("</div>"),v.push("</div>"),v.join("")},initecharts:function(e){var n=this._stasticPanel.getContainer(),r={},i={};for(var s=0,o=e.msg.shipDst.length;s<o;s++){var u=e.msg.shipDst[s];r[u.countryCn]=[],r[u.countryCn].push(u.shiphuo),r[u.countryCn].push(u.shipyou),r[u.countryCn].push(u.shiptuo),r[u.countryCn].push(u.shipyu),r[u.countryCn].push(u.shipke),r[u.countryCn].push(u.shipjun),r[u.countryCn].push(u.shipother)}for(var s=0,o=e.msg.shipSrc.length;s<o;s++){var a=e.msg.shipSrc[s];i[a.countryCn]=[],i[a.countryCn].push(a.shiphuo),i[a.countryCn].push(a.shipyou),i[a.countryCn].push(a.shiptuo),i[a.countryCn].push(a.shipyu),i[a.countryCn].push(a.shipke),i[a.countryCn].push(a.shipjun),i[a.countryCn].push(a.shipother)}this.echart_enter=t.init(n.find(".stastic_chart_enter").get(0)),this.echart_out=t.init(n.find(".stastic_chart_out").get(0));var f=this.getChartOption(r),l=this.getChartOption(i);this.echart_enter.setOption(f,!0),this.echart_out.setOption(l,!0)},_initStasticEvts:function(){var e=this,t=this._stasticPanel.getContainer();t.find(".nav_titleNav>li").on("click",function(){$(this).addClass("active").siblings().removeClass("active");var e=$(this).data("info");e==="chart"?(t.find(".stasticChartDiv").css("display","block"),t.find(".stasticTableDiv").css("display","none")):(t.find(".stasticChartDiv").css("display","none"),t.find(".stasticTableDiv").css("display","block"))}),t.find(".stastic_table_enter").mCustomScrollbar({theme:"minimal-dark"}),t.find(".stastic_table_out").mCustomScrollbar({theme:"minimal-dark"})},getChartOption:function(e){var t=$.i18n.prop("func_filter_shipflag_1"),n=$.i18n.prop("func_filter_shipflag_5"),r=$.i18n.prop("func_filter_shipflag_2"),i=$.i18n.prop("func_filter_shipflag_3"),s=$.i18n.prop("func_filter_shipflag_4"),o=$.i18n.prop("func_filter_shipflag_100"),u=$.i18n.prop("func_filter_shiptype_1"),a=$.i18n.prop("func_filter_shiptype_3"),f=$.i18n.prop("func_filter_shiptype_6"),l=$.i18n.prop("func_filter_shiptype_5"),c=$.i18n.prop("func_filter_shiptype_7"),h=$.i18n.prop("func_filter_shiptype_8"),p=$.i18n.prop("func_filter_shiptype_100"),d={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},legend:{data:[t,n,r,i,s,o]},xAxis:[{type:"category",data:[u,a,f,l,c,h,p]}],yAxis:[{type:"value"}],color:["#065F89","#0A7CB0","#0FA0E3","#3AD3FF","#6DDEFE","#BDF1FF"],series:[{name:t,type:"bar",barWidth:10,stack:"stastic",data:e[t]},{name:n,type:"bar",stack:"stastic",data:e[n]},{name:r,type:"bar",stack:"stastic",data:e[r]},{name:i,type:"bar",stack:"stastic",data:e[i]},{name:s,type:"bar",stack:"stastic",data:e[s]},{name:o,type:"bar",stack:"stastic",data:e[o]}]};return d},_initInfoPopEvts:function(){var t=this,n=$(".ict_portInfo_popupContainer"),r=n.find(".msg"),i=e.ict.app.util.dateTime;n.find(".Wdate").on("focus",function(){var e={readOnly:!0,dateFmt:"yyyy-MM-dd HH",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0,maxDate:"%y-%M-%d %H:%m:%s"};WdatePicker(e)});var s=i.getNewDateTimeBeforHour(24);s=i.formatDateH(s);var o=i.formatDateH(new Date);n.find(".Wdate.startTime").val(s),n.find(".Wdate.endTime").val(o),$(".ict_portInfo_popupContainer .btnDiv button").on("click",function(){var e=$(this).data("id"),s=n.find(".startTime").val(),o=n.find(".endTime").val(),u=i.checkStrartEndTime(s+":00:00",o+":00:00",1);if(!u.result){r.text(u.msg);return}s=i.getCusUnixTime(s+":00:00"),o=i.getCusUnixTime(o+":00:00");var a={portid:e,startTime:s,endTime:o};t.portStastic(a)})},convertPortInfoObj:function(e){var t={};return t.id=e.id,t.areaname=e.area_Name,t.name=e.port_Name,t.countryen=e.country,t.countryzh=e.country_Chinese,t.countrycode=e.country_Code,t.portsize=e.harbor_Size,t.porttype=e.harbor_Type,t.lat=e.latitude/6e5,t.lon=e.longitude/6e5,t},clearLocatLyr:function(){this._locatePortLyr&&this._locatePortLyr.remove(),this._locatePortLyr=null},getPortobjById:function(e){var t={};for(var n=0,r=this._portList.length;n<r;n++)if(this._portList[n].id==e){t=this._portList[n];break}return t},getPopupContent:function(t){var n=e.ict.app.util.tool.latlngTodfmStr(t.lat,"lat"),r=e.ict.app.util.tool.latlngTodfmStr(t.lon,"lng"),i=$.i18n.prop("port_info_title"),s=$.i18n.prop("port_info_id"),o=$.i18n.prop("port_info_areaenname"),u=$.i18n.prop("port_info_enname"),a=$.i18n.prop("port_info_coenname"),f=$.i18n.prop("port_info_cozhname"),l=$.i18n.prop("port_info_size"),c=$.i18n.prop("port_info_type"),h=$.i18n.prop("common_ship_lng"),p=$.i18n.prop("common_ship_lat"),d=$.i18n.prop("port_info_conum"),v=$.i18n.prop("port_static_jltj"),m=$.i18n.prop("common_time_info2"),g=$.i18n.prop("common_btn_ok"),y=[];return y.push('<div class="portInfo_Div">'),y.push('<div class="portInfo_title">'+i+"</div>"),y.push('<div class="portInfo_table_div">'),y.push("<table>"),y.push("<tr><td>"+s+"</td><td>"+t.id+"</td></tr>"),y.push("<tr><td"+o+"</td><td>"+t.areaname+"</td></tr>"),y.push("<tr><td>"+u+"</td><td>"+t.name+"</td></tr>"),y.push("<tr><td>"+a+"</td><td>"+t.countryen+"</td></tr>"),y.push("<tr><td>"+f+"</td><td>"+t.countryzh+"</td></tr>"),y.push("<tr><td>"+l+"</td><td>"+t.portsize+"</td></tr>"),y.push("<tr><td>"+c+"</td><td>"+t.porttype+"</td></tr>"),y.push("<tr><td>"+h+"</td><td>"+r+"</td></tr>"),y.push("<tr><td>"+p+"</td><td>"+n+"</td></tr>"),y.push("<tr><td>"+d+"</td><td>"+t.countrycode+"</td></tr>"),y.push("</table>"),y.push("</div>"),y.push('<div class="port_stastic">'),y.push("<p>"+v+"</p>"),y.push('<input type="text" class="Wdate startTime">&nbsp<label>'+m+'</label>&nbsp<input type="text" readonly  class="Wdate endTime">'),y.push("</div>"),y.push('<p class="msg"></p>'),y.push('<div class="btnDiv">'),y.push('<button type="button" data-id="'+t.id+'">'+g+"</button>"),y.push("</div>"),y.push("</div>"),y.join("")},setPortLayerList:function(){this._portLayerList=[];for(var e=0,t=this._portList.length;e<t;e++){var n=this._portList[e],r=this.createPortMarker(n);this._portLayerList.push(r)}},showOrHidePortLayer:function(){this.ictmap.getCurZoom()<this.config.showLevel?this.hidePortLayer():this.showPortLayer()},showPortLayer:function(){this.portLayerGroup?this.portLayerGroup.eachLayer(function(e){e.setOpacity(1),e.on("click",this.portClickEvt,this)},this):this.getPortList()},hidePortLayer:function(){if(!this.portLayerGroup)return;this.portLayerGroup.eachLayer(function(e){e.setOpacity(0),e.off("click",this.portClickEvt,this)},this)},getPortById:function(e){var t=null;return this.portLayerGroup&&this.portLayerGroup.eachLayer(function(n){var r=n.options.data;r.id===e&&(t=n)},this),t},addPortLayer:function(){this.portLayerGroup=new e.FeatureGroup(this._portLayerList),this.ictmap.getCurZoom()<this.config.showLevel&&this.hidePortLayer(),this.ictmap.map.addLayer(this.portLayerGroup)},removePortLayer:function(){this.portLayerGroup&&this.ictmap.map.hasLayer(this.portLayerGroup)&&this.ictmap.map.removeLayer(this.portLayerGroup),this.portLayerGroup=null}})});