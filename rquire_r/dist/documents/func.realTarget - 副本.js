define("func/realTarget",["leaflet","func/base","core/namespace","leaflet/shipDistLayer","leaflet/rotateMarker","plugins/contextmenu","data/ajax","func/hjcx","func/tshf","func/userLogin","plugins/ajaxpoll"],function(e){e.ICT.RealTarget=e.Class.extend({_allRealTargetList:[],_filterRealTargetList:[],_filterLayers:[],_shipdistLayer:null,_realTargetFeatureGroup:null,rightClickTargetData:null,clickTarget:null,_websocket:null,_shipSelectMarker:null,initialize:function(t){this.ajax=new e.ICT.Ajax,this.config=Project_ParamConfig.RealTargetConfig,this.ictmap=t,this._realTargetFeatureGroup=e.featureGroup([]),this.ictmap.map.addLayer(this._realTargetFeatureGroup),this.shipTypeList=Project_ParamConfig.FilterDisplayConfig.shipTypeList,this.shipFlagList=Project_ParamConfig.FilterDisplayConfig.shipFlagList,this.shipStateList=Project_ParamConfig.FilterDisplayConfig.shipStateList,this.shipSourceList=Project_ParamConfig.FilterDisplayConfig.shipSourceList},getRealTarget:function(){if(this.ictmap.map.getZoom()<this.config.showLevel){this.showShipDistLayer();return}var t=this.config.shipRealUrl,n={};n.limit=this.config.limit,n.timeout=this.config.timeout,n=e.extend(n,this.getCurRectExtend()),this.ajax.post(t,n,!0,this,function(e){if(e.state!==1)console.error(e.msg);else{var t=e.msg.shipList;this._allRealTargetList=[];for(var n=0,r=t.length;n<r;n++){var i=this.convertTargetObj(t[n]);this._allRealTargetList.push(i)}this.updateFilterList(),this.firstAddRealTargetLayer()}},function(e){})},getRealTarget2:function(){if(this.ictmap.map.getZoom()<this.config.showLevel){this.showShipDistLayer();return}var t=this.config.shipRealUrl,n={};n.limit=this.config.limit,n.timeout=this.config.timeout,n=e.extend(n,this.getCurRectExtend()),this.ajax.post(t,n,!0,this,function(e){if(e.state!==1)console.error(e.msg);else{var t=e.msg.shipList;this._allRealTargetList=[];for(var n=0,r=t.length;n<r;n++){var i=this.convertTargetObj(t[n]);this._allRealTargetList.push(i)}this.updateFilterList(),this.updateFilterLayer()}},function(e){})},sendAjaxPoll:function(e,t,n){$.poll({url:e,data:t,context:this,dataType:"json",method:"POST",pollDelay:5e3,pollDone:function(e){e.state!==1?console.error(e.msg.result):typeof n=="function"?n.call(this,e):null},pollFail:function(e){console.log("pollfial")}})},convertTargetObj:function(e){var t={};return t.id=e.ti,t.time=e.re,t.lon=parseFloat(e.lo/6e5),t.lat=parseFloat(e.la/6e5),t.dir=(e.di/10).toFixed(1),t.heading=e.he,t.speed=(e.sp/10).toFixed(1),t.status=e.st,t.infosrc=e.os,t.mmsi=e.mi,t.shipname=e.sn.replace(/@/g,""),t.callsign=e.cs.replace(/@/g,""),t.imo=e.imn,t.country=this.getDetialConvertName(e.cn,"country"),t.shiptype=e.ast,t},getDetialConvertName:function(e,t){var n="";e=e.toString();if(t=="ship_type")switch(e){case"1":n="货船";break;case"2":n="搜救船";break;case"3":n="油轮";break;case"4":n="拖轮";break;case"5":n="渔船";break;case"6":n="拖船";break;case"7":n="客船";break;default:n="其他"}else if(t=="country")switch(e){case"中国":n="中国";break;case"英国":n="英国";break;case"法国":n="法国";break;case"美国":n="美国";break;default:n="其他"}else if(t=="hwlx")n=e;else if(t=="status")switch(e){case"0":n="机动船在航";break;case"1":n="锚泊";break;case"2":n="船舶失控";break;case"3":n="船舶操作受限";break;default:n=e}else if(t=="fixing_device")switch(e){case"-1":res1="非法";break;case"0":n="默认";break;case"1":n="GPS";break;case"2":n="GLONASS";break;case"3":n="GPS/GLONASS组合";break;case"4":n="Loran-C";break;case"5":n="Chayka";break;case"6":n="综合导航系统";break;case"7":n="观测";break;case"8":n="北斗";break;case"9":case"10":case"11":case"12":case"13":case"14":n="未使用";break;case"15":n="内部GNSS";break;default:n=e}else if(t=="commun_state")switch(e){case"0":n="未知";break;case"1":n="SOTDMA";break;case"2":n="ITDMA";break;default:n=e}else if(t=="pos_accuracy")switch(e){case"0":n="未知";break;case"1":n="定位误差大于10米";break;case"2":n="定位误差小于等于10米";break;default:n=e}else if(t=="orig_info_source")switch(e){case"1":n="农业部";break;case"2":n="海事局";break;case"3":n="海监";break;default:n=e}else if(t=="orig_info_type")switch(e){case"1":n="Argos及海事卫星";break;case"2":n="北斗";break;case"3":n="AIS静态";break;case"4":n="AIS动态";break;case"5":n="LRIT";break;case"7":n="海监";break;case"15":n="综合信息";break;default:n=e}return n},getCurRect:function(){var e={},t=this.ictmap.getBounds(),n=t.getSouthWest(),r=t.getNorthEast();return e.ldlon=parseFloat(n.lng.toFixed(6)),e.ldlat=parseFloat(n.lat.toFixed(6)),e.rulon=parseFloat(r.lng.toFixed(6)),e.rulat=parseFloat(r.lat.toFixed(6)),e},getCurRectExtend:function(){var e={},t=this.ictmap.getBounds().pad(this.config.bufferRatio),n=t.getSouthWest(),r=t.getNorthEast();return e.ldlon=parseFloat(n.lng.toFixed(6)),e.ldlat=parseFloat(n.lat.toFixed(6)),e.rulon=parseFloat(r.lng.toFixed(6)),e.rulat=parseFloat(r.lat.toFixed(6)),e},updateAllTargetList:function(e){for(var t=0,n=this._allRealTargetList.length;t<n;t++){var r=this._allRealTargetList[t];if(e.id===r.id){this.isChange(r,e)&&(this._allRealTargetList[t]=e);break}}t===n&&n<this.config.limit&&this._allRealTargetList.push(e)},updateFilterList:function(){this._filterRealTargetList=[];for(var e=0,t=this._allRealTargetList.length;e<t;e++){var n=this._allRealTargetList[e];this.checkFilter(n)&&this._filterRealTargetList.push(n)}},updateFilterLayer:function(){for(var t=0,n=this._filterRealTargetList.length;t<n;t++){var r=this._filterRealTargetList[t];for(var i=0,s=this._filterLayers.length;i<s;i++){var o=this._filterLayers[i],u=o.options.data;if(u.id===r.id){if(this.isChange(u,r)){var a=e.latLng(r.lat,r.lon);o.setLatLng(a),o.setRotationAngle(r.dir),o.options.data=r,o.setOpacity(1)}break}}if(i===s&&this._realTargetFeatureGroup){var f=this.createMarker(r,!0);this._filterLayers.push(f),this._realTargetFeatureGroup.addLayer(f)}}console.log(this._filterLayers.length)},removeInFilterLayer:function(){var e=this;e._filterLayers=$.map(e._filterLayers,function(t){var n=!0,r=t.options.data;for(var i=0,s=e._filterRealTargetList.length;i<s;i++){var o=e._filterRealTargetList[i];if(o.id===r.id){n=!1;break}}return n&&e._realTargetFeatureGroup?(e._realTargetFeatureGroup.removeLayer(t),null):t})},updateFilterLayer2:function(){this._realTargetFeatureGroup.eachLayer(function(e){var t=!0,n=e.options.data;for(var r=0,i=this._filterRealTargetList.length;r<i;r++){var s=this._filterRealTargetList[r];if(s.id===n.id){t=!1;break}}t?(e.setOpacity(0),e.off("contextmenu",this._markerRightClickEvt,this),e.off("click",this._markerClickEvt,this)):(e.setOpacity(1),e.on("contextmenu",this._markerRightClickEvt,this),e.on("click",this._markerClickEvt,this))},this)},firstAddRealTargetLayer:function(){this.removeRealTargetLayer(),this._filterLayers=[];for(var t=0,n=this._filterRealTargetList.length;t<n;t++){var r=this._filterRealTargetList[t],i=this.createMarker(r,!0);this._filterLayers.push(i)}this._realTargetFeatureGroup=e.featureGroup(this._filterLayers).addTo(this.ictmap.map)},removeTargetLayerById:function(e){for(var t=0,n=this._filterLayers.length;t<n;t++){var r=this._filterLayers[t];if(e===r.options.data.id&&this._realTargetFeatureGroup){this._filterLayers.splice(t,1),this._realTargetFeatureGroup.removeLayer(r);break}}},removeRealTargetLayer:function(){this._realTargetFeatureGroup&&this._realTargetFeatureGroup.clearLayers()},removeUnuseTarget:function(){var t=this.ictmap.getBoundsExtend(),n=[];for(var r=0,i=this._allRealTargetList.length;r<i;r++){var s=this._allRealTargetList[r],o=e.latLng(s.lat,s.lon);t.contains(o)&&n.push(s)}this._allRealTargetList=n},removeUnuseFilterLayer:function(){var e=this.ictmap.getBoundsExtend(),t=[];for(var n=0,r=this._filterLayers.length;n<r;n++){var i=this._filterLayers[n],s=i.getLatLng();e.contains(s)?t.push(i):this._realTargetFeatureGroup.removeLayer(i)}this._filterLayers=t},isChange:function(e,t){var n=!1;if(t.lat!==e.lat||t.lon!==e.lon)n=!0;return n},checkFilter:function(e){return!0;var t,n,r,i,s,s,s,s},convertNameToKey:function(e,t){e=e.toString();var n=null;if(t!=="shiptype")if(t==="shipflag")switch(e){case"中国":n="1";break;case"英国":n="2";break;case"法国":n="3";break;case"美国":n="4";break;case"俄罗斯":n="5";break;default:n="100"}else t!=="shipstate"&&t==="shipsrc";return n},createMarker:function(t,n){var n=n?n:!1,r=e.latLng(t.lat,t.lon),i=t.shipname,s=this.getTargetIcon(t.shiptype),o={icon:s,rotationAngle:t.dir,title:i,data:t};n&&(o.icon.options.className="leaflet-marker-rightclick-icon");var u=e.marker(r,o);return n&&(u.on("contextmenu",this._markerRightClickEvt,this),u.once("contextmenu",function(e){this.initContextMenu(),this._markerRightClickEvt(e)},this),u.on("click",this._markerClickEvt,this)),u},_markerRightClickEvt:function(t){e.DomEvent.stopPropagation(t);var n=this.ictmap.map.getContainer(),r=t.containerPoint.x+n.offsetLeft,i=t.containerPoint.y+n.offsetTop;this.rightClickTargetData=t.target.options.data,$(".leaflet-marker-rightclick-icon").contextMenu({x:r,y:i})},initContextMenu:function(){var e=this,t=$.i18n.prop("contextmenu_tshf"),n=$.i18n.prop("contextmenu_addhf"),r=$.i18n.prop("contextmenu_hjcx"),i=$.i18n.prop("contextmenu_addhj");$.contextMenu({selector:".leaflet-marker-rightclick-icon",trigger:"none",callback:function(t,n){e._rightClickCallback(t,n)},items:{tshf:{name:t,icon:"edit"},addhf:{name:n,icon:"edit"},hjcx:{name:r,icon:"edit"},addcx:{name:i,icon:"edit"}}})},_rightClickCallback:function(t,n){if(!e.ICT.Func.UserLogin.getInstance().isLogin()){e.ICT.Func.UserLogin.getInstance().alertLoginDialog();return}var r=this.rightClickTargetData;if(t==="tshf")e.ICT.Func.TSHFOneShip.run();else if(t==="addhf"){var i=e.ICT.Func.TSHF.getInstance();i.addTarget(r),i._targetPanel?i.updateList():e.ict.app.util.dialog.success("提示","添加成功")}else if(t==="hjcx")e.ICT.Func.HJCXOneShip.run();else if(t==="addcx"){var s=e.ICT.Func.HJCXMoreShip.getInstance();s.addTarget(r),s._popPanel?s.updateList():e.ict.app.util.dialog.success("提示","添加成功")}},_markerClickEvt:function(t){var n=t.target,r=this.config.shipInfoUrl,i=t.target.options.data.id,s={};s.shipid=i,this.removeSelectMarker(),this.createSelectMarker(t),this.clickTarget=t.target,this.ajax.post(r,s,!0,this,function(t){if(t.state!==1)console.error(t.msg.result),e.ict.app.util.dialog.error("错误提示",t.msg.error),this.removeShipInfoPopPanel();else{var n=this.convertshipInfoObj(t.msg);this.showShipInfoPopPanel(n),this._initPopEvt()}},function(e){this.removeShipInfoPopPanel()})},showShipInfoPopPanel:function(t){if(this._shipinfoPopPanel){this._shipinfoPopPanel.setContent(this.getPopupContent(t));return}var n={title:"船舶信息",width:460,height:330,right:40,top:100,className:"ict_realTarget_popupContainer",contentHTML:this.getPopupContent(t)};this._shipinfoPopPanel=new e.ICT.PopPanel(n),this._shipinfoPopPanel.show(),this._shipinfoPopPanel.on("popPanelRemove",function(){this._shipinfoPopPanel=null,this.removeSelectMarker()},this)},removeShipInfoPopPanel:function(){this._shipinfoPopPanel&&(this._shipinfoPopPanel.remove(),this._shipinfoPopPanel=null)},createSelectMarker:function(t){var n=t.target.getLatLng(),r=e.divIcon({iconSize:[24,24],iconAnchor:[12,12],className:"ict_markerselect_divicon"});this._shipSelectMarker=e.marker(n,{icon:r}),this._shipSelectMarker.on("contextmenu",function(){t.target.fire("contextmenu",t)},this),this._shipSelectMarker.on("click",function(){t.target.fire("click",t)},this),this._shipSelectMarker.addTo(this.ictmap.map),$(".ict_markerselect_divicon").css("border","dotted 2px #f00"),t.target.options.hasSelectState=!0,t.target.on("move",function(e){this._shipSelectMarker&&t.target.options.hasSelectState&&this._shipSelectMarker.setLatLng(e.target.getLatLng())},this)},removeSelectMarker:function(){this._shipSelectMarker&&this.clickTarget&&(this._shipSelectMarker.remove(),this._shipSelectMarker=null,this.clickTarget.options.hasSelectState=!1)},getTargetIcon:function(t){var t=t.toString(),n=null;switch(t){case"1":n=e.ICT.ShipIcon.ship1;break;case"2":n=e.ICT.ShipIcon.ship2;break;case"3":n=e.ICT.ShipIcon.ship3;break;case"4":n=e.ICT.ShipIcon.ship4;break;case"5":n=e.ICT.ShipIcon.ship5;break;case"6":n=e.ICT.ShipIcon.ship6;break;case"7":n=e.ICT.ShipIcon.ship7;break;case"8":n=e.ICT.ShipIcon.ship8;break;default:n=e.ICT.ShipIcon.ship100}return n},convertshipInfoObj:function(e){var t={};return t.id=e.ti,t.time=e.re,t.lon=parseFloat(e.lo/6e5),t.lat=parseFloat(e.la/6e5),t.dir=(e.di/10).toFixed(1),t.heading=e.he,t.speed=e.sp/10,t.status=this.getDetialConvertName(e.st,"status"),t.infosrc=e.os,t.mmsi=e.mi,t.shipname=e.sn.replace(/@/g,"")||"未知",t.callsign=e.cs.replace(/@/g,"")||"未知",t.imo=e.imn,t.country=e.cn.replace(/@/g,"")||"其他",t.shiptype=this.getDetialConvertName(e.ast,"ship_type"),t.shiplength=e.sl+"米",t.shipwidth=e.sb+"米",t.rotsensor=e.ro,t.destination=e.de.replace(/@/g,"")||"未知",t.reachtime=e.et,t},getPopupContent:function(t){var n=e.ict.app.util.tool.latlngTodfmStr(t.lat,"lat"),r=e.ict.app.util.tool.latlngTodfmStr(t.lon,"lng"),i=e.ict.app.util.dateTime.getTimeStrFromUnix(t.time),s=[];return s.push('<div class="shipInfo_Div">'),s.push('<div class="shipInfo_table_div">'),s.push('<table data-id="'+t.id+'">'),s.push('<tr><td width="20%">船名:</td><td>'+t.shipname+'</td><td width="20%">国别:</td><td>'+t.country+"</td></tr>"),s.push("<tr><td>呼号:</td><td>"+t.callsign+"</td><td>MMSI:</td><td>"+t.mmsi+"</td></tr>"),s.push("<tr><td>IMO:</td><td>"+t.imo+"</td><td>船长:</td><td>"+t.shiplength+"</td></tr>"),s.push("<tr><td>船舶类型:</td><td>"+t.shiptype+"</td><td>船宽:</td><td>"+t.shipwidth+"</td></tr>"),s.push("<tr><td>经度:</td><td>"+r+"</td><td>纬度:</td><td>"+n+"</td></tr>"),s.push("<tr><td>航向:</td><td>"+t.dir+"°</td><td>船艏向:</td><td>"+t.heading+"°</td></tr>"),s.push("<tr><td>转向率:</td><td>"+t.rotsensor+"</td><td>目的地:</td><td>"+t.destination+"</td></tr>"),s.push("<tr><td>预计到达时间:</td><td>"+t.reachtime+"</td><td>数据更新时间:</td><td>"+i+"</td></tr>"),s.push("</table>"),s.push("</div>"),s.push('<div class="btnDiv">'),s.push('<button type="button" class="btn daxx">档案信息</button>'),s.push('<button type="button" class="btn addcd">添加船队</button>'),s.push("</div>"),s.push("</div>"),s.join("")},_initPopEvt:function(){var e=this;$(".ict_realTarget_popupContainer .btnDiv>button").on("click",function(e){var t=$(".ict_realTarget_popupContainer table").data("id")})},showShipDistLayer:function(){this._shipdistLayer?this._shipdistLayer.setOpacity(1):(this._shipdistLayer=new e.TileLayer.ShipDistLayer(this.config.shipDistLayerUrl),this.ictmap.map.addLayer(this._shipdistLayer))},hideShipDistLayer:function(){this._shipdistLayer&&this._shipdistLayer.setOpacity(0)},addShipDistLayer:function(){this.removeShipDistLayer(),this._shipdistLayer=new e.TileLayer.ShipDistLayer(this.config.shipDistLayerUrl),this.ictmap.map.addLayer(this._shipdistLayer)},removeShipDistLayer:function(){if(this._shipdistLayer||this.ictmap.map.hasLayer(this._shipdistLayer))this._shipdistLayer.remove(),this._shipdistLayer=null},showRealTargetLayer:function(){this._realTargetFeatureGroup?this._realTargetFeatureGroup.eachLayer(function(e){e.setOpacity&&e.setOpacity(1),e.setStyle&&e.setStyle({opacity:1,fillOpacity:1})},this):this.getRealTarget()},hideRealTargetLayer:function(){this._realTargetFeatureGroup&&this._realTargetFeatureGroup.eachLayer(function(e){e.setOpacity&&e.setOpacity(0),e.setStyle&&e.setStyle({opacity:0,fillOpacity:0})},this)},removeRealTargetLayer:function(){this._realTargetFeatureGroup&&(this._realTargetFeatureGroup.clearLayers(),this._realTargetFeatureGroup=null)},addRealTargetLayer:function(){this.ictmap.getCurZoom()<this.config.showLevel?(this.showShipDistLayer(),this.removeRealTargetLayer()):(this.hideShipDistLayer(),this.getRealTarget())},locateShip:function(t){this.clearLocatLyr();var n=this.getShipById(t.shipid);if(n)this.ictmap.map.panTo(n.getLatLng()),n.fire("click");else{var r=this.config.shipInfoUrl;this.ajax.post(r,t,!0,this,function(t){if(t.state!==1)e.ict.app.util.dialog.error("错误",t.msg.error);else{var n=this.convertshipInfoObj(t.msg),r=this.convertTargetObj(t.msg);this._locateShiplyr=this.createMarker(r,!0),this.ictmap.map.addLayer(this._locateShiplyr),this._locateShiplyr.fire("click"),this.ictmap.map.panTo(this._locateShiplyr.getLatLng())}},function(e){})}},clearLocatLyr:function(){this._locateShiplyr&&(this.ictmap.map.removeLayer(this._locateShiplyr),this._locateShiplyr=null,this.removeShipInfoPopPanel())},getShipById:function(e){if(!this._realTargetFeatureGroup)return null;var t=null;return this._realTargetFeatureGroup.eachLayer(function(n){var r=n.options.data;if(r.id===e&&n.options.opacity!==0){t=n;return}},this),t},isRealTargetShow:function(){var e=!1;return this._realTargetFeatureGroup&&this.ictmap.map.hasLayer(this._realTargetFeatureGroup)&&this.ictmap.map.getZoom()>=this.config.showLevel&&(e=!0),e}})});