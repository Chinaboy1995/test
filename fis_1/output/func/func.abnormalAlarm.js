define("func/abnormalAlarm",["leaflet","func/base","control/panel","plugins/ajaxpoll"],function(t){t.ICT.Func.add("AbnormalAlarm",{Class:t.Class.extend({initialize:function(){this.ictmap=t.ict.app.ictmap,this.menu=t.ict.app.menu,this.menuid="ict_menu_main_ycgj",this.config=Project_ParamConfig.abnormalAlarmConfig,this._container=null,this._popPanel=null,this._data=[]},start:function(){this._container||this._popPanel||(this._initUi(),this._initEvts(),this.curtype="area",this._container.find(".alarmNav>li:first-child").click(),this.menu.mainmenu.deactiveMenuExceptOne(this.menuid))},stop:function(){this._popPanel&&this._popPanel.remove(),this.removeLayer(),this._container=null,this._popPanel=null,this._data=[],this.menu.mainmenu.deactiveMenu(this.menuid)},_initUi:function(){var a={title:"异常告警",width:510,height:458,left:100,top:200};a.contentHTML=this._container=$(this.getContentHtml());var i=new t.ICT.PopPanel(a);i.show(),this.config.isClose=!1,this._popPanel=i,this._popPanel.on("popPanelRemove",function(){this.menu.mainmenu.deactiveMenu(this.menuid),this._popPanel=this._container=null,this._data=[],this.config.isClose=!0},this)},getContentHtml:function(){var t=[];return t.push('<div class="alarmContainer">'),t.push('   <ul class="alarmNav">'),t.push('      <li class="active" data-info="area"><a href="#" >驶入敏感区域</a></li>'),t.push('      <li  data-info="behavior"><a href="#">船速过快</a></li>'),t.push('      <li data-info="gather"><a href="#" >异常聚集</a></li>'),t.push('      <li data-info="ais"><a href="#" >AIS关闭</a></li>'),t.push("   </ul>"),t.push('	<div class="tableContainer"></div>'),t.push("</div>"),t.join("")},_initEvts:function(){var a=this;a._container.find(".alarmNav>li").on("click",function(){$(this).addClass("active").siblings().removeClass("active"),a.removeLayer();var i=$(this).data("info"),e=null;switch(i){case"area":e=a.config.url_area;break;case"behavior":e=a.config.url_behavior;break;case"gather":e=a.config.url_gather;break;case"ais":e=a.config.url_ais}a.curtype=i;var n={};n.tim=t.ict.app.startTime,e&&a.sendAjaxPoll(e,n,a._ajaxSucCallback)})},sendAjaxPoll:function(t,a,i){$.poll({url:t,data:a,currentFunc:"AbnormalAlarm",context:this,dataType:"json",method:"POST",pollDelay:5e3,pollDone:function(t){1!==t.state?console.error(t.msg.result):"function"==typeof i?i.call(this,t):null},pollFail:function(){console.log("pollfial")}})},_ajaxSucCallback:function(a){var i={height:358,thData:[{name:"time",value:"时间",width:35},{name:"detail",value:"详细信息"}],tbData:[]};if(1===a.state){i.tbData=[];var e=this._data=a.msg.anomalyList;if("area"==this.curtype)for(var n=0,l=e.length;l>n;n++){var r={},o=e[n];r.data_id=n,r.time=t.ict.app.util.dateTime.getTimeStrFromUnix(o.tim);var s=t.ict.app.util.tool.latlngTodfmStr(o.lon/6e5,"lng"),p=t.ict.app.util.tool.latlngTodfmStr(o.lat/6e5,"lat"),c=-1===o.tid?o.tio:o.tid;r.detail="位置:"+s+" "+p+"，批号:"+c+"，mmsi:"+o.msi,i.tbData.push(r)}else if("behavior"==this.curtype)for(var n=0,l=e.length;l>n;n++){var r={},o=e[n];r.data_id=n,r.time=t.ict.app.util.dateTime.getTimeStrFromUnix(o.tim);var s=t.ict.app.util.tool.latlngTodfmStr(o.lon/6e5,"lng"),p=t.ict.app.util.tool.latlngTodfmStr(o.lat/6e5,"lat"),c=-1===o.tid?o.tio:o.tid,h=o.cog/10+"节";r.detail="位置:"+s+" "+p+"，批号:"+c+"，mmsi:"+o.msi+"，航速:"+h,i.tbData.push(r)}else if("gather"==this.curtype)for(var n=0,l=e.length;l>n;n++){var r={},o=e[n];r.data_id=n,r.time=t.ict.app.util.dateTime.getTimeStrFromUnix(o.tim);var u=this.getShipType(o),d=t.ict.app.util.tool.latlngTodfmStr(o.ldlon/6e5,"lng"),m=t.ict.app.util.tool.latlngTodfmStr(o.ldlat/6e5,"lat"),f=t.ict.app.util.tool.latlngTodfmStr(o.rulon/6e5,"lng"),g=t.ict.app.util.tool.latlngTodfmStr(o.rulat/6e5,"lat");r.detail="位置:左下("+d+" "+m+")右上("+f+" "+g+")，船舶类型:"+u+"，当前数量:"+o.scou+"，历史期望:"+o.cavg,i.tbData.push(r)}else if("ais"==this.curtype)for(var n=0,l=e.length;l>n;n++){var r={},o=e[n];r.data_id=n,r.time=t.ict.app.util.dateTime.getTimeStrFromUnix(o.tim);var s=t.ict.app.util.tool.latlngTodfmStr(o.lon/6e5,"lng"),p=t.ict.app.util.tool.latlngTodfmStr(o.lat/6e5,"lat"),c=-1===o.tid?o.tio:o.tid,v=o.offs+"秒";r.detail="位置:"+s+" "+p+"，批号:"+c+"，mmsi:"+o.msi+"，关闭时间:"+v,i.tbData.push(r)}if(this._container){var _=this._container.find(".tableContainer");new t.ICT.TablePanel(i).addTo(_),_.find(".tbDiv tr").on("click",$.proxy(this._rowClickEvt,this))}}},getShipType:function(t){var a=parseInt(t.ast),i="";switch(a){case 0:i="";break;case 1:i="货船";break;case 2:i="搜救船";break;case 3:i="油轮";break;case 4:i="拖轮";break;case 5:i="渔船";break;case 6:i="拖船";break;case 7:i="客船";break;case 100:i="其他"}return i},_rowClickEvt:function(t){var a=$(t.currentTarget),i=a.data("id");if(this.removeLayer(),i>=0&&this._data&&"area"===this.curtype){var e=this._data[i];this._marker=this.createShipMarker(e),this.ictmap.map.addLayer(this._marker),this.ictmap.map.panTo(this._marker.getLatLng()),this._marker.openPopup()}},removeLayer:function(){this._marker&&(this.ictmap.map.removeLayer(this._marker),this._marker=null)},createShipMarker:function(a){var i=a.lat/6e5,e=a.lon/6e5,n=t.latLng(i,e),l=this.getTargetIcon(a.ast),r={icon:l,data:a},o=t.marker(n,r),s={minWidth:200};return o.bindPopup(this.getPopupContent(a),s),o},getPopupContent:function(a){var i=t.ict.app.util.tool.latlngTodfmStr(a.lat/6e5,"lat"),e=t.ict.app.util.tool.latlngTodfmStr(a.lon/6e5,"lng"),n=t.ict.app.util.dateTime.getTimeStrFromUnix(a.tim),l=this.ictmap.realtarget.getDetialConvertName(a.ast,"ship_type"),r=[];return r.push('<div style="padding:5px;">'),r.push("<table>"),r.push("<tr><td>船舶类型:</td><td>"+l+"</td></tr>"),r.push("<tr><td>MMSI:</td><td>"+a.msi+"</td></tr>"),r.push("<tr><td>经纬度:</td><td>"+e+","+i+"</td></tr>"),r.push("<tr><td>敏感区域id:</td><td>"+a.rid+"</td></tr>"),r.push("<tr><td>时间:</td><td>"+n+"</td></tr>"),r.push("</table>"),r.push("</div>"),r.join("")},getTargetIcon:function(a){var i;switch(a){case 1:i=t.ICT.ShipIcon.ship1;break;case 2:i=t.ICT.ShipIcon.ship2;break;case 3:i=t.ICT.ShipIcon.ship3;break;case 4:i=t.ICT.ShipIcon.ship7;break;case 5:i=t.ICT.ShipIcon.ship4;break;case 6:i=t.ICT.ShipIcon.ship7;break;case 7:i=t.ICT.ShipIcon.ship5;break;case 100:i=t.ICT.ShipIcon.ship6;break;default:i=t.ICT.ShipIcon.ship7}return i}})})});