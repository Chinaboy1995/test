!function(t){var i;if("function"==typeof define&&define.amd)define(["leaflet"],t);else if("object"==typeof module&&"object"==typeof module.exports)i=require("leaflet"),module.exports=t(i);else{if("undefined"==typeof window.L)throw"Leaflet must be loaded first";t(window.L)}}(function(t){t.Playback=t.Playback||{},t.Playback.MoveableMarker=t.Marker.extend({initialize:function(i,e,s){var r=e.marker||{};jQuery.isFunction(r)&&(r=r(s)),t.Marker.prototype.initialize.call(this,i,r),this.popupContent="",this.feature=s,r.getPopup&&(this.popupContent=r.getPopup(s)),e.popups&&this.bindPopup(this.getPopupContent()+i.toString()),e.labels&&(this.bindLabel?this.bindLabel(this.getPopupContent(),{noHide:!0}):console.log("Label binding requires leaflet-label (https://github.com/Leaflet/Leaflet.label)"))},getPopupContent:function(){return""!==this.popupContent?"<b>"+this.popupContent+"</b><br/>":""},move:function(i,e){t.DomUtil.TRANSITION&&(this._icon&&(this._icon.style[t.DomUtil.TRANSITION]="all "+e+"ms linear",this._popup&&this._popup._wrapper&&(this._popup._wrapper.style[t.DomUtil.TRANSITION]="all "+e+"ms linear")),this._shadow&&(this._shadow.style[t.DomUtil.TRANSITION]="all "+e+"ms linear")),this.setLatLng(i),this._popup&&this._popup.setContent(this.getPopupContent()+this._latlng.toString())},_old__setPos:t.Marker.prototype._setPos,_updateImg:function(i,e,s){e=t.point(s).divideBy(2)._subtract(t.point(e));var r="";r+=" rotate("+this.options.iconAngle+"deg)",i.style[t.DomUtil.TRANSFORM]+=r,i.style.transformOrigin="50% 50%"},setIconAngle:function(t){this.options.iconAngle=t,this._map&&this.update()},_setPos:function(i){if(this._icon&&(this._icon.style[t.DomUtil.TRANSFORM]=""),this._shadow&&(this._shadow.style[t.DomUtil.TRANSFORM]=""),this._old__setPos.apply(this,[i]),this.options.iconAngle){var e,s=this.options.icon.options.iconAnchor,r=this.options.icon.options.iconSize;this._icon&&(e=this._icon,this._updateImg(e,s,r)),this._shadow&&(r=this.options.icon.options.shadowSize,e=this._shadow,this._updateImg(e,s,r))}}}),t.Playback.Track=t.Class.extend({initialize:function(i,e,s){this._map=i,this.options=s||{},this._dataObj=e,this._ticks=[],this._times=[],this._marker=null;for(var r=e.timePosList,n=0,a=r.length;a>n;n++){var o=r[n].time;this._times.push(o),this._ticks[o]=r[n],0===n&&(this._startTime=o),n===a-1&&(this._endTime=o)}this._trackLineFeatureGroup||(this._trackLineFeatureGroup=t.featureGroup([]).addTo(this._map)),this._trackPointFeatureGroup||(this._trackPointFeatureGroup=t.featureGroup([]).addTo(this._map))},getFirstTick:function(){return this._ticks[this._startTime]},getLastTick:function(){return this._ticks[this._endTime]},getStartTime:function(){return this._startTime},getEndTime:function(){return this._endTime},getTimes:function(){return this._times},getTimeInterval:function(t){var i=this._times.indexOf(t);if(-1!==i&&i!==this._times.length-1)var e=this._times[i+1],s=e-t;return s},tick:function(t){return this._ticks[t]},getLatLng:function(i){var e=this.tick(i);return e?t.latLng(e.lat,e.lng):void 0},setMarker:function(i,e){var s=null;return s=this.getLatLng(i?i:this._startTime),s&&(this._marker=new t.Playback.MoveableMarker(s,e,this._dataObj)),this._marker},getMarker:function(){return this._marker},createTrackPoint:function(i){var e=this.getLatLng(i);if(e)var s=t.circleMarker(e,this.options.OriginCircleOptions);var r=this.tick(i);return r&&s.bindTooltip(this.getTooltipText(r),this.getTooltipOptions()),this._marker&&(this._marker.unbindTooltip(),this._marker.bindTooltip(this.getTooltipText(r),this.getTooltipOptions())),s},getTooltipText:function(t){var i=[];return i.push("<table>"),i.push("<tr><td>批号:</td><td>"+t.info_ph+"</td></tr>"),i.push("<tr><td>经度:</td><td>"+t.info_lng+"</td></tr>"),i.push("<tr><td>纬度:</td><td>"+t.info_lat+"</td></tr>"),i.push("<tr><td>时间:</td><td>"+t.info_time+"</td></tr>"),i.push("<tr><td>航向:</td><td>"+t.info_dir+"</td></tr>"),i.push("<tr><td>航艏向:</td><td>"+t.info_heading+"</td></tr>"),i.push("<tr><td>航速:</td><td>"+t.info_speed+"</td></tr>"),i.push("</table>"),i=i.join("")},getTooltipOptions:function(){return{offset:[0,0],direction:"top"}},moveMarker:function(i,e,s){if(this._marker){var r=this._marker.getLatLng(),n=this.tick(s);if(this._marker.move(i,e),this._marker.setIconAngle(n.dir),0!==e){var a=[[r.lat,r.lng],[i.lat,i.lng]],o=t.polyline(a,this.options.trackLineOptions);this._trackLineFeatureGroup.addLayer(o);var h=this.createTrackPoint(s);this._trackPointFeatureGroup.addLayer(h)}}},drawHistoryTrackLine:function(i){for(var e=[],s=0,r=this._times.length;r>s;s++)if(this._times[s]<=i){var n=this.getLatLng(this._times[s]);n&&e.push(n)}var a=t.polyline(e,this.options.trackLineOptions);this._trackLineFeatureGroup.addLayer(a)},drawHistoryTrackPoints:function(t){for(var i=0,e=this._times.length;e>i;i++)if(this._times[i]<=t){var s=this.createTrackPoint(this._times[i]);s&&this._trackPointFeatureGroup.addLayer(s)}},clearTrackInfo:function(){this._trackLineFeatureGroup&&this._trackLineFeatureGroup.clearLayers(),this._trackPointFeatureGroup&&this._trackPointFeatureGroup.clearLayers()}}),t.Playback.TrackController=t.Class.extend({initialize:function(t,i,e){this.options=e||{},this._map=t,this._tracks=[],this.setTracks(i)},clearTracks:function(){for(;this._tracks.length>0;){var t=this._tracks.pop(),i=t.getMarker();i&&this._map.removeLayer(i),t.clearTrackInfo()}},clearLineAndPoint:function(){for(var t=0,i=this._tracks.length;i>t;t++){var e=this._tracks[t];e.clearTrackInfo()}},setTracks:function(t){this.clearTracks(),this.addTracks(t)},addTracks:function(t){if(t)if(t instanceof Array)for(var i=0,e=t.length;e>i;i++)this.addTrack(t[i]);else this.addTrack(t)},addTrack:function(t,i){if(t){var e=t.setMarker(i,this.options);e&&(e.addTo(this._map),this._map.panTo(e.getLatLng()),this._tracks.push(t))}},tock:function(t,i){for(var e=0,s=this._tracks.length;s>e;e++){var r=this._tracks[e].getLatLng(t);r&&this._tracks[e].moveMarker(r,i,t)}},getStartTime:function(){var t=0;if(this._tracks.length>0){t=this._tracks[0].getStartTime();for(var i=1,e=this._tracks.length;e>i;i++){var s=this._tracks[i].getStartTime();t>s&&(t=s)}}return t},getEndTime:function(){var t=0;if(this._tracks.length>0){t=this._tracks[0].getEndTime();for(var i=1,e=this._tracks.length;e>i;i++){var s=this._tracks[i].getEndTime();s>t&&(t=s)}}return t},getAllTimes:function(){var t=[];if(this._tracks.length>0)for(var i=0,e=this._tracks.length;e>i;i++){var s=this._tracks[i].getTimes();t=t.concat(s)}t=this.uniqueArr(t);for(var i=0,r=t.length;r-1>i;i++)for(var n=0;r-1-i>n;n++)if(t[n]>t[n+1]){var a=t[n];t[n]=t[n+1],t[n+1]=a}return t},uniqueArr:function(t){for(var i=[],e=0,s=t.length;s>e;e++)-1===i.indexOf(t[e])&&i.push(t[e]);return i},getTracks:function(){return this._tracks}}),t.Playback.Clock=t.Class.extend({initialize:function(i,e,s){this._trackController=i,this._callbacksArry=[],e&&this.addCallback(e),t.setOptions(this,s),this._speed=this.options.speed,this.max_speed=this.options.Max_Speed,this._alltime=this._trackController.getAllTimes(),this._cursor=i.getStartTime(),this._alltime.length&&(this._tickLen=3e5/this._alltime.length),this._transitionTime=this._tickLen/this._speed},_tick:function(t){return t._cursor>=t._trackController.getEndTime()?(clearInterval(t._intervalID),void(t._intervalID=null)):(t._trackController.tock(t._cursor,t._transitionTime),t._callbacks(t._cursor),void(t._cursor=t.getNextTime()))},_callbacks:function(t){for(var i=this._callbacksArry,e=0,s=i.length;s>e;e++)i[e](t)},addCallback:function(t){this._callbacksArry.push(t)},start:function(){this._intervalID||(this._intervalID=window.setInterval(this._tick,this._transitionTime,this))},stop:function(){this._intervalID&&(clearInterval(this._intervalID),this._intervalID=null)},getSpeed:function(){return this._speed},isPlaying:function(){return this._intervalID?!0:!1},setSpeed:function(t){this._speed=t,this._transitionTime=this._tickLen/t,this._intervalID&&(this.stop(),this.start())},quickSpeed:function(){this._speed=this._speed>=this.max_speed?this._speed:2*this._speed,this._transitionTime=this._tickLen/this._speed,this._intervalID&&(this.stop(),this.start())},slowSpeed:function(){this._speed=this._speed<=1?this._speed:this._speed/2,this._transitionTime=this._tickLen/this._speed,this._intervalID&&(this.stop(),this.start())},rePlaying:function(){this._trackController.clearLineAndPoint(),this.isPlaying()&&this.stop(),this.setCursor(this.getStartTime()),this.start()},setCursor:function(t){var i=parseInt(t);i&&(this._cursor=i,this._trackController.tock(this._cursor,0),this._callbacks(this._cursor))},getTime:function(){return this._cursor},getAllTime:function(){return this._alltime},getStartTime:function(){return this._trackController.getStartTime()},getEndTime:function(){return this._trackController.getEndTime()},getLastTime:function(){var t=this._alltime.indexOf(this._cursor);return-1===t?this._alltime[0]:0===t?this._alltime[this._alltime.length-1]:this._alltime[t-1]},getNextTime:function(){var t=this._alltime.indexOf(this._cursor);return-1===t?this._alltime[this._alltime.length-1]:t!==this._alltime.length-1?this._alltime[t+1]:void this.stop()},getTickLen:function(){return this._tickLen}})});