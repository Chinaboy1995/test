define("func/hjcx",["leaflet","func/base","data/ajax"],function(t){t.Class.HJCXBase=t.Class.extend({initialize:function(){this.util=t.ict.app.util,this.ictmap=t.ict.app.ictmap,this.ajax=new t.ICT.Ajax,this.config=Project_ParamConfig.hjcxConfig,this._hjcxLayerGroup=null,this._hjcxlayerarr={},this._shipmarker=null},addHjLayerGroup:function(i,r){this._hjcxLayerGroup=t.featureGroup().addTo(this.ictmap.map);for(var e=this.ictmap.realtarget.currentTarget.options.data,a=e.id,s=[],h=[],n=null,l=null,o=null,p=0,c=i.length;c>p;p++){var u=this.convertShipObj(i[p]),d=t.latLng(u.lat,u.lon);h.push(d);var y=this.createHjPoint(u,r);if(s.push(y),0===p){var g=this.convertShipObj(i[0]),L=t.latLng(g.lat,g.lon);if(c>=2){var j=this.convertShipObj(i[1]),f=t.latLng(j.lat,j.lon);o=this.createCloseMarker(L,f,a)}else o=this.createCloseMarker(L,null,a)}if(p===c-1){u.shipname=e.shipname,u.shiptype=e.shiptype,u.mode=e.mode,u.id=e.id;var m=this.ictmap.realtarget.getShipById(e.id);m?l=this._shipmarker=m:(l=this._shipmarker=this.ictmap.realtarget.createMarker(u,!0),s.push(l))}}if(h.length>=2&&(n=this.createHjLine(h),s.unshift(n)),o&&s.push(o),s.length>0){this._hjcxlayerarr[a]=s;for(var x=0,v=s.length;v>x;x++)this._hjcxLayerGroup.addLayer(s[x])}l&&this.ictmap.map.panTo(l.getLatLng())},convertShipObj:function(t){var i={};return i.dir=t.co/10,i.heading=t.he,i.lat=parseFloat(t.la/6e5),i.lon=parseFloat(t.lo/6e5),i.speed=t.sp/10,i.time=t.ti,i},removeLayerGroup:function(){this._hjcxLayerGroup&&(this._hjcxLayerGroup.clearLayers(),this._hjcxLayerGroup=null)},createHjPoint:function(i,r){var r=r,e=this.util.dateTime.getTimeStrFromUnix(i.time),a=this.util.tool.latlngTodfmStr(i.lat,"lat"),s=this.util.tool.latlngTodfmStr(i.lon,"lng"),h=t.latLng(i.lat,i.lon),n=i.dir,l=i.speed,o=[];o.push("<table>"),o.push("<tr><td>批号:</td><td>"+r+"</td></tr>"),o.push("<tr><td>经度:</td><td>"+s+"</td></tr>"),o.push("<tr><td>纬度:</td><td>"+a+"</td></tr>"),o.push("<tr><td>时间:</td><td>"+e+"</td></tr>"),o.push("<tr><td>航向:</td><td>"+n+"°</td></tr>"),o.push("<tr><td>航速:</td><td>"+l+" 节</td></tr>"),o.push("</table>"),o=o.join("");var p={radius:4,stroke:!1,fill:!0,fillColor:"#f00",opacity:1,fillOpacity:1,data:i},c=t.circleMarker(h,p),u={offset:[6,8],direction:"top",permanent:!1,opacity:.8,className:"realtarget-label-target"};return c.bindTooltip(o,u).openTooltip(),c},createShipMarker:function(i){var r=this.util.dateTime.getTimeStrFromUnix(i.time),e=this.util.tool.latlngTodfmStr(i.lat,"lat"),a=this.util.tool.latlngTodfmStr(i.lon,"lng"),s=t.latLng(i.lat,i.lon),h=i.dir,n=i.speed+"节",l="经度:"+a+"<br>纬度:"+e+"<br>时间:"+r+"<br>航向:"+h+"°<br>航速:"+n,o={icon:t.ICT.ShipIcon.ship7,rotationAngle:h,data:i},p=t.marker(s,o),c={offset:[6,8],direction:"right",permanent:!1,opacity:.8,className:"realtarget-label-target"};p.bindTooltip(l,c).openTooltip();return p},getPopupContent:function(t){var i=this.util.tool.latlngTodfmStr(t.lat,"lat"),r=this.util.tool.latlngTodfmStr(t.lon,"lng"),e=this.util.dateTime.getTimeStrFromUnix(t.time),a=[];return a.push('<div class="displayctr_div" style="padding:5px;">'),a.push("<table>"),a.push("<tr><td>国别:</td><td>"+t.country+"</td></tr>"),a.push("<tr><td>船艏向:</td><td>"+t.heading+"°</td></tr>"),a.push("<tr><td>经纬度:</td><td>"+r+" "+i+"</td></tr>"),a.push("<tr><td>航速:</td><td>"+t.speed+"节</td></tr>"),a.push("<tr><td>时间:</td><td>"+e+"</td></tr>"),a.push("</table>"),a.push("</div>"),a.join("")},createHjLine:function(i){var r={opacity:1,fillOpacity:1},e=t.polyline(i,r);return e},createhjPly:function(i,r){var e=t.latLng(i.lat,i.lon),a=t.latLng(r.lat,r.lon),s=[e,a],h={opacity:1,fillOpacity:1},n=t.polyline(s,h);return n},createCloseMarker:function(i,r,e){var a=t.icon({iconUrl:"themes/images/shipIcons/hjxs_close.png",iconSize:[18,18],iconAnchor:[28,14]});r&&r.lng<i.lng&&(a=t.icon({iconUrl:"themes/images/shipIcons/hjxs_close.png",iconSize:[18,18],iconAnchor:[-9,14]}));var s={icon:a,id:e,opacity:1},h=t.marker(i,s);return h.on("click",this._markerCloseClickEvt,this),h},_markerCloseClickEvt:function(t){{var i=t.target;i.options.id}this.removeLayerGroup(),this.config.hjcxList=[]},removeLayerById:function(t){for(var i=this._hjcxlayerarr[t],r=0,e=i.length;e>r;r++)this._hjcxLayerGroup.removeLayer(i[r]);delete this._hjcxlayerarr[t]},isChange:function(t,i){return!(t.lon===i.lon&&t.lat===i.lat)}}),t.ICT.Func.add("HJCX_HJXS",{Class:t.Class.HJCXBase.extend({initialize:function(){t.Class.HJCXBase.prototype.initialize.apply(this,arguments),this.ictmap=t.ict.app.ictmap,this.hjxsShipArr=[],this.hjxsShipLayerArr={},this.hjxsLineLayer=null,this.hjxsPointLayer=null,this.isShow=!0},start:function(){var i=this.ictmap.realtarget.currentTarget.options.data;this.isShowhj(i)||(i.ISHJXSPPOINTONE=!0,this.hjxsShipArr.push(i),this.hjxsShipLayerArr[i.id]=[],t.ict.app.util.dialog.success("提示","成功加入航迹显示列表！")),null===this.hjxsLineLayer&&(this.hjxsLineLayer=t.featureGroup(),this.ictmap.map.addLayer(this.hjxsLineLayer)),null===this.hjxsPointLayer&&(this.hjxsPointLayer=t.featureGroup(),this.ictmap.map.addLayer(this.hjxsPointLayer))},stop:function(){this.removeLayerGroup()},isShowhj:function(t){for(var i=!1,r=0,e=this.hjxsShipArr.length;e>r;r++){var a=this.hjxsShipArr[r];t.id===a.id&&(i=!0)}return i},updateHJ:function(t){if(1===t.state&&t.msg.shipList&&t.msg.shipList.length)for(var i=t.msg.shipList,r=0,e=i.length;e>r;r++){var a=this.ictmap.realtarget.convertTargetObj(i[r]);if(this.isShowhj(a)){var s=this.getTargetByid(a.id);this.isChange(s,a)&&(this.createPath(s,a),this.updateTarget(a))}}},createPath:function(i,r){var e=t.latLng(i.lat,i.lon),a=t.latLng(r.lat,r.lon),s=r.id,h=this.createHjLine([e,a]);if(this.hjxsLineLayer.addLayer(h),this.hjxsShipLayerArr[s].push(h),i.ISHJXSPPOINTONE){var n=this.createHjPoint(i,s);this.hjxsPointLayer.addLayer(n),this.hjxsShipLayerArr[s].push(n);var l=this.createCloseMarker(e,a,s);this.hjxsPointLayer.addLayer(l),this.hjxsShipLayerArr[s].push(l)}var o=this.createHjPoint(r,s);this.hjxsPointLayer.addLayer(o),this.hjxsShipLayerArr[s].push(o)},updateTarget:function(t){for(var i=0,r=this.hjxsShipArr.length;r>i;i++){var e=this.hjxsShipArr[i];if(t.id===e.id){this.hjxsShipArr[i]=t;break}}},getTargetByid:function(t){for(var i=0,r=this.hjxsShipArr.length;r>i;i++){var e=this.hjxsShipArr[i];if(t===e.id)return e}},_markerCloseClickEvt:function(t){for(var i=t.target,r=i.options.id,e=this.hjxsShipLayerArr[r],a=0;a<e.length;a++)this.ictmap.map.removeLayer(e[a]);this.deleteFromShipArr(r),delete this.hjxsShipLayerArr[r]},deleteFromShipArr:function(t){this.hjxsShipArr=$.map(this.hjxsShipArr,function(i){return i.id===t?null:i})},isChange:function(t,i){return!(t.lon===i.lon&&t.lat===i.lat)},showPathLayer:function(){this.hjxsLineLayer&&this.hjxsPointLayer&&(this.hjxsLineLayer.eachLayer(function(t){t.setOpacity&&t.setOpacity(1),t.setStyle&&t.setStyle({opacity:1,fillOpacity:1})},this),this.hjxsPointLayer.eachLayer(function(t){t.setOpacity&&t.setOpacity(1),t.setStyle&&t.setStyle({opacity:1,fillOpacity:1})},this),this.isShow=!0)},hidePathLayer:function(){this.hjxsLineLayer&&this.hjxsPointLayer&&(this.hjxsLineLayer.eachLayer(function(t){t.setOpacity&&t.setOpacity(0),t.setStyle&&t.setStyle({opacity:0,fillOpacity:0})},this),this.hjxsPointLayer.eachLayer(function(t){t.setOpacity&&t.setOpacity(0),t.setStyle&&t.setStyle({opacity:0,fillOpacity:0})},this),this.isShow=!1)},removeLayerGroup:function(){this.hjxsLineLayer&&(this.hjxsLineLayer.clearLayers(),this.hjxsLineLayer=null),this.hjxsPointLayer&&(this.hjxsPointLayer.clearLayers(),this.hjxsPointLayer=null)}})}),t.ICT.Func.add("HJCX_HJKZ",{Class:t.Class.HJCXBase.extend({initialize:function(){t.Class.HJCXBase.prototype.initialize.apply(this,arguments),this.hjkzCurtarget=null},start:function(t){var i=this.ictmap.realtarget.currentTarget.options.data,r=this.config.hjkzUrl,e={};e.modeType=i.mode,e.shipId=i.id,e.limit=t,this.hjkzCurtarget=i,this.ajax.post(r,e,!0,this,function(t){if(1!==t.state)this.util.dialog.error("错误提示","没有航迹数据！"),console.error(t.msg.error),this.hjkzCurtarget=null;else{var i=t.msg.posList;this.sucessHandler(i)}})},stop:function(){},sucessHandler:function(t){if(!t.length)return this.util.dialog.error("错误提示","没有航迹数据！"),void(this.hjkzCurtarget=null);var i=this.ictmap.realtarget.currentTarget.options.data;this.removeLayerGroup(),this.addHjLayerGroup(t,i.id);var r=this.convertShipObj(t.pop());r.id=i.id,this.hjkzCurtarget=r},hjkzUpdateTarget:function(i){if(null!==this.hjkzCurtarget&&this._hjcxLayerGroup&&1==i.state&&i.msg.shipList&&!(i.msg.shipList.length<=0))for(var r=i.msg.shipList,e=0,a=r.length;a>e;e++){var s=this.ictmap.realtarget.convertTargetObj(r[e]),h=s.id,n=this.hjkzCurtarget.id;if(n===h&&this.isChange(this.hjkzCurtarget,s)){var l=this.createhjPly(this.hjkzCurtarget,s);this._hjcxLayerGroup.addLayer(l);var o=this.createHjPoint(s,h);this._hjcxLayerGroup.addLayer(o);var p=t.latLng(s.lat,s.lon);this._shipmarker.setLatLng(p),this.hjkzCurtarget=s,this.hjkzCurtarget.id=h;break}}},_markerCloseClickEvt:function(i){t.Class.HJCXBase.prototype._markerCloseClickEvt.call(this,i),this.hjkzCurtarget=null}})})});