define("func/monitorStatisc",["leaflet","func/base","control/draw","control/panel","plugins/linqtojs","data/ajax"],function(t){t.ICT.Func.add("MonitorStatisc",{Class:t.Class.extend({_data:{historyChk:!1,realtimeChk:!1,startTime:null,endTime:null},initialize:function(){this.ictmap=t.ict.app.ictmap,this.dateUtil=t.ict.app.util.dateTime,this.dialog=t.ict.app.util.dialog,this.menu=t.ict.app.menu,this.menuid="ict_menu_main_jktj",this.config=Project_ParamConfig.monitorStatiscConfig,this.ajax=new t.ICT.Ajax,this._container=null,this._popPanel=null,this._drawPopPanel=null,this._resultPopPanel=null,this._layer=null,this._layerType=null},start:function(){this._container||this._popPanel||(this._initUi(),this._initEvts(),this._container.find("input[type=radio]").eq(0).click(),this._container.find("input[type=checkbox]").eq(0).click(),this.menu.mainmenu.deactiveMenuExceptOne(this.menuid),this.menu.mainmenu.disableMenuExceptOne(this.menuid))},stop:function(){this._popPanel&&this._popPanel.remove(),this._layer&&this._layer.remove(),this._drawPopPanel&&this._drawPopPanel.remove(),this._resultPopPanel&&this._resultPopPanel.remove(),this._timer&&(clearInterval(this._timer),this._timer=null),this.ictmap.deactivate(),this.menu.mainmenu.deactiveMenu(this.menuid),this._container=null,this._popPanel=null,this._drawPopPanel=null,this._resultPopPanel=null,this._layer=null,this._layerType=null,this.menu.mainmenu.enableMenu()},_initUi:function(){var e={title:"监测统计",width:400,height:380,left:100,top:200},i=this._container=$(this.getContentHTML());e.contentHTML=i;var a=this._popPanel=new t.ICT.PopPanel(e);a.show(),a.on("popPanelRemove",function(){this._popPanel=null,this._container=null,this.stop()},this)},getContentHTML:function(){var t=[];return t.push('<div class="monitorStatiscContainer">'),t.push("<p>绘制区域：</p>"),t.push('<div class="form-group">'),t.push('<label><input type="radio" name="drawRadio" value="rect">&nbsp矩形&nbsp<img src="themes/images/model/frame/ico_rect.png">&nbsp&nbsp</label>'),t.push('<label><input type="radio" name="drawRadio" value="circle">&nbsp圆形&nbsp<img src="themes/images/model/frame/ico_circle.png">&nbsp&nbsp</label>'),t.push('<label><input type="radio" name="drawRadio" value="polygon">&nbsp多边形&nbsp<img src="themes/images/model/frame/ico_ployon.png">&nbsp&nbsp</label>'),t.push("</div>"),t.push("<hr>"),t.push("<p>统计类型：</p>"),t.push('<div class="form-group">'),t.push('<label><input type="checkbox" name="staticType" value="realtime">区域实时船舶数量</label>'),t.push("</div>"),t.push('<div class="form-group">'),t.push('<label><input type="checkbox" name="staticType" value="history">区域历史进出数量</label>'),t.push("</div>"),t.push('<div class="timeDiv">'),t.push('<label>时间:</label> <input type="text" class="Wdate startTime"> <label>&nbsp至&nbsp</label> <input type="text" class="Wdate endTime">'),t.push("</div>"),t.push('<p class="msg"></p>'),t.push('<div class="btnDiv">'),t.push('<button type="button" class="okBtn">确定</button>'),t.push('<button type="button" class="cancelBtn">取消</button>'),t.push("</div>"),t.push("</div>"),t.join("")},_initEvts:function(){var e=this;e._container.find("input[type=radio]").on("click",function(){e._layer&&e._layer.remove(),e.__drawPopPanel&&e._drawPopPanel.remove();var i=$(this).val();"circle"==i?e.ictmap.activate(t.ICT.MapMouseState.CIRCLE,e._drawCallback,null,e):"rect"==i?e.ictmap.activate(t.ICT.MapMouseState.RECTANGLE,e._drawCallback,null,e):"polygon"==i&&e.ictmap.activate(t.ICT.MapMouseState.POLYGON,e._drawCallback,null,e)}),e._container.find("input[type=checkbox]").on("change",function(){var t=e._container.find("input[type=checkbox]");t.each(function(){"realtime"==this.value&&(e._data.realtimeChk=1==this.checked?!0:!1),"history"==this.value&&(1==this.checked?(e._data.historyChk=!0,e._container.find(".timeDiv").css("display","block")):(e._data.historyChk=!1,e._container.find(".timeDiv").css("display","none")))})}),e._container.find(".Wdate").on("focus",function(){var t={readOnly:!0,dateFmt:"yyyy-MM-dd HH:mm",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0,maxDate:"%y-%M-%d %H:%m:%s"};WdatePicker(t)});var i=e.dateUtil.getNewDateTimeBeforHour(168);i=e.dateUtil.formatDateHM(i);var a=e.dateUtil.formatDateHM(new Date);e._container.find(".Wdate.startTime").val(i),e._container.find(".Wdate.endTime").val(a),e._container.find(".okBtn").on("click",function(){var t=e._container.find(".msg"),i=e._container.find(".startTime").val(),a=e._container.find(".endTime").val();if(t.html(""),!e._layer)return void t.html("请绘制区域！");if(!e._data.realtimeChk&&!e._data.historyChk)return void t.html("请选择统计方式！");if(e._data.historyChk){var i=e._container.find(".startTime").val(),a=e._container.find(".endTime").val(),n=e.dateUtil.checkStrartEndTime(i+":00",a+":00",7);if(!n.result)return void t.text(n.msg);e._data.startTime=e.dateUtil.getCusUnixTime(i+":00"),e._data.endTime=e.dateUtil.getCusUnixTime(a+":00")}e._resultPopPanel&&e._resultPopPanel.remove(),e.analysis()}),e._container.find(".cancelBtn").on("click",function(){e.stop()})},_drawCallback:function(e){var i=this._layer=e.layer,a=this._layerType=e.layerType;this._drawPopPanel&&this._drawPopPanel.remove(),this._drawPopPanel=new t.ICT.DrawPopPanel(i,a),this._drawPopPanel.on("popPanelRemove",function(){this._drawPopPanel=null},this),this._drawPopPanel.on("CancelDraw",function(){this._layer=null},this),this._drawPopPanel.show(),this.ictmap.map.addLayer(i),i.editing&&(i.editing.enable(),i.on("edit",function(){this._drawPopPanel.updateContent()},this))},analysis:function(){var e={title:"监控统计结果",width:900,height:600,contentHTML:this.getResultHTML()},i=this._resultPopPanel=new t.ICT.PopPanel(e);i.on("popPanelRemove",function(){this._resultPopPanel=null,this.config.isClose=!0,this.stop()},this),i.show(),this.config.isClose=!1,this._popPanel.close(),this.ictmap.deactivate(),this._initResEvts();var a=this._resultPopPanel.getContainer().find(".monitotleResContainer");this._data.realtimeChk&&this._data.historyChk?(a.find(".realTime-secondFilter").css("display","block"),a.find(".histroy-secondFilter").css("display","none")):this._data.realtimeChk||a.find(".result").css("display","none").end().find(".result-history").css("display","block"),a.find(".nav-titleNav>li.active>a").click()},_initResEvts:function(){var t=this._resultPopPanel.getContainer().find(".monitotleResContainer"),e=this;t.find(".nav-titleNav>li>a").on("click",{context:e},e._firstTitleEvt),t.find(".nav-secondNav>li>a").on("click",{context:e},e._secondFilterEvt),t.find(".histroy-secondFilter button").on("click",{context:e},e._historySecEvt),t.find(".histroy-secondFilter input").on("focus",{context:e},e._onFocus)},_firstTitleEvt:function(t){var e=t.data.context,i=$(this).data("info"),a=e._resultPopPanel.getContainer().find(".monitotleResContainer");$(this).parent().addClass("active").siblings().removeClass("active"),"realTime"==i?(a.find(".realTime-secondFilter").css("display","block"),a.find(".histroy-secondFilter").css("display","none"),a.find(".nav-secondNav>li:first-child>a").click()):"history"==i&&(a.find(".realTime-secondFilter").css("display","none"),a.find(".histroy-secondFilter").css("display","block"),a.find(".result").css("display","none").end().find(".result-history").css("display","block"))},_secondFilterEvt:function(t){var e=t.data.context,i=$(this).data("info"),a=e._resultPopPanel.getContainer().find(".monitotleResContainer");if($(this).parent().addClass("active").siblings().removeClass("active"),"realTime-0"==i){a.find(".result").css("display","none").end().find(".result-realTime-0").css("display","block"),e._timer&&(clearInterval(e._timer),e._timer=null);var n=e.ictmap.realtarget.getTargetsInExtend(e._layer);n.length&&e.realtimeCountRes(n),e._timer=setInterval(function(){var t=e.ictmap.realtarget.getTargetsInExtend(e._layer);t.length&&e.realtimeCountRes(t)},e.config.updateTime)}else if("realTime-1"==i){a.find(".result").css("display","none").end().find(".result-realTime-1").css("display","block"),e._timer&&(clearInterval(e._timer),e._timer=null);var n=e.ictmap.realtarget.getTargetsInExtend(e._layer);n.length&&e.realtimeAreaRes(n),e._timer=setInterval(function(){var t=e.ictmap.realtarget.getTargetsInExtend(e._layer);t.length&&e.realtimeAreaRes(t)},e.config.updateTime)}},realtimeCountRes:function(t){if(this._resultPopPanel){for(var e=t.groupBy("country"),i=[],a=0,n=e.length;n>a;a++){var s={};s.co=e[a].key;for(var l=e[a].value,r=l.groupBy("shiptype"),o=0,h=r.length;h>o;o++){var c=r[o];"货船"===c.key?s.tc1=c.value.length:"搜救船"===c.key?s.tc2=c.value.length:"油轮"===c.key?s.tc3=c.value.length:"拖船"===c.key?s.tc4=c.value.length:"渔船"===c.key?s.tc5=c.value.length:"客船"===c.key?s.tc6=c.value.length:"军事船"===c.key?s.tc7=c.value.length:"其他"===c.key&&(s.tc100=c.value.length)}s.tc1||(s.tc1=0),s.tc2||(s.tc2=0),s.tc3||(s.tc3=0),s.tc4||(s.tc4=0),s.tc5||(s.tc5=0),s.tc6||(s.tc6=0),s.tc7||(s.tc7=0),s.tc100||(s.tc100=0),i.push(s)}var d=this._resultPopPanel.getContainer().find(".monitotleResContainer"),p=t.length,u=i,m=[];m.push("<p>实时船舶总数："+p+"艘</p>"),m.push("<table>"),m.push("<thead><tr><th>国别</th><th>货船</th><th>搜救船</th><th>油轮</th><th>拖船</th><th>渔船</th><th>客船</th><th>军事船</th><th>其他</th></tr></thead>"),m.push("<tbody>");for(var a=0,n=u.length;n>a;a++){var v=u[a];m.push("<tr>"),m.push('<td><img src="themes/images/country/'+v.co.trim()+'.png">'+v.co+"</td>"),m.push("<td>"+v.tc1+"</td>"),m.push("<td>"+v.tc2+"</td>"),m.push("<td>"+v.tc3+"</td>"),m.push("<td>"+v.tc4+"</td>"),m.push("<td>"+v.tc5+"</td>"),m.push("<td>"+v.tc6+"</td>"),m.push("<td>"+v.tc7+"</td>"),m.push("<td>"+v.tc100+"</td>"),m.push("</tr>"),n-1>a&&m.push('<tr class="splitTr"><td colspan="8">&nbsp</td></tr>')}m.push("</tbody>"),m.push("</table>"),m=m.join(""),d.find(".result-realTime-0").html(m)}},realtimeAreaRes:function(e){if(this._resultPopPanel){var i=this._resultPopPanel.getContainer().find(".monitotleResContainer"),a=e,n=[];n.push("<table>"),n.push("<thead><tr>"),n.push("<th>批号</th>"),n.push("<th>模式</th>"),n.push("<th>船名</th>"),n.push("<th>船舶类型</th>"),n.push("<th>经度</th>"),n.push("<th>纬度</th>"),n.push("<th>时间</th>"),n.push("<th>船速</th>"),n.push("<th>航向</th>"),n.push("<th>信息来源</th>"),n.push("</tr></thead>"),n.push("<tbody>");for(var s=0,l=a.length;l>s;s++){var r=a[s],o=t.ict.app.util.tool.latlngTodfmStr(r.lat,"lat"),h=t.ict.app.util.tool.latlngTodfmStr(r.lon,"lng"),c=this.dateUtil.getTimeStrFromUnix(r.time),d=(this.ictmap.realtarget.getDetialConvertName(r.infotype,"orig_info_type"),this.ictmap.realtarget.getDetialConvertName(r.infosrc,"orig_info_source")),p=0===r.mode?"融合模式":"原始模式";n.push("<tr>"),n.push("<td>"+r.id+"</td>"),n.push("<td>"+p+"</td>"),n.push("<td>"+r.shipname+"</td>"),n.push("<td>"+r.shiptype+"</td>"),n.push("<td>"+h+"</td>"),n.push("<td>"+o+"</td>"),n.push("<td>"+c+"</td>"),n.push("<td>"+r.speed+" 节</td>"),n.push("<td>"+r.dir+"°</td>"),n.push("<td>"+d+"</td>"),n.push("</tr>"),l-1>s&&n.push('<tr class="splitTr"><td colspan="8">&nbsp</td></tr>')}n.push("</tbody>"),n.push("</table>"),n=n.join(""),i.find(".result-realTime-1").html(n)}},sendAjaxPoll:function(t,e,i){$.poll({url:t,data:e,currentFunc:"MonitorStatisc",context:this,dataType:"json",method:"POST",pollDelay:5e3,pollDone:function(t){1!==t.state?this.dialog.error("错误提示","没有统计结果！"):"function"==typeof i?i.call(this,t):null},pollFail:function(){console.log("pollfial")}})},getArea:function(){if(this._layer&&this._layer.getBounds){var t={},e=this._layer.getBounds();return t.ldlon=e.getWest(),t.ldlat=e.getSouth(),t.rulon=e.getEast(),t.rulat=e.getNorth(),t}return{}},_historySecEvt:function(t){t.data.context},_onFocus:function(){var t={readOnly:!0,dateFmt:"yyyy-MM-dd HH",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0};WdatePicker(t)},getResultHTML:function(){var t=[];return t.push('<div class="monitotleResContainer">'),t.push(this.getTitleNavHTML()),t.push(this.getSecondFilterHtml()),t.push('<div class="result result-realTime-0">正在统计，请您耐心等待...</div>'),t.push('<div class="result result-realTime-1">正在统计，请您耐心等待...</div>'),t.push('<div class="result result-history">正在统计，请您耐心等待...</div>'),t.push("</div>"),t.join("")},getTitleNavHTML:function(){var t="";return t+='<ul  class="nav nav-titleNav">',0==this._data.realtimeChk?t+='<li class="active"><a href="#" data-info="history">历史进出统计</a></li>':0==this._data.historyChk?t+='<li class="active"><a href="#" data-info="realTime">实时船舶数量</a></li>':(t+='<li class="active"><a href="#" data-info="realTime">实时船舶数量</a></li>',t+='<li><a href="#" data-info="history">历史进出统计</a></li>'),t+="</ul>"},getSecondFilterHtml:function(){var t="",e="";return t+='<div class="realTime-secondFilter">',t+='<ul class="nav nav-secondNav">',t+='<li class="active"><a href="#" data-info="realTime-0">数量统计</a></li>',t+='<li><a href="#" data-info="realTime-1">目标列表</a></li>',t+="</ul>",t+="</div>",e+='<div class="histroy-secondFilter">',e+='<label>时间范围：<input class="startTime Wdate" type="text"><span>&nbsp&nbsp</span>至<span>&nbsp&nbsp</span><input class="endTime Wdate" type="text"><label><span>&nbsp&nbsp</span>',e+='<button type="button">确定</button>',e+="</div>",0==this._data.realtimeChk?e:0==this._data.historyChk?t:t+e}})})});