define("func/fxpg",["leaflet","func/base","data/ajax","control/panel","control/paging","plugins/mcscroll"],function(t){t.ICT.Func.add("FXPG",{Class:t.Class.extend({initialize:function(){this.ajax=new t.ICT.Ajax,this.ictmap=t.ict.app.ictmap,this.map=t.ict.app.ictmap.map,this.url=Project_ParamConfig.wjAnalysisConfig.fxpgUrl,this.menu=t.ict.app.menu,this.menuid="ict_menu_main_xwwj",this.layer=null,this._layerGroup=null,this.data=null,this._container=null,this._popPanel=null,this.pagecount=15},start:function(){this.ajaxCount=0,this.openPopPanel();var t=1;this.getData(t),this.getAllData()},stop:function(){this.removeLayer(),this.removePopPanel(),this.data=null,this._container=null},openPopPanel:function(){var a={title:"风险评估",width:660,height:410,left:340,top:160};a.contentHTML=this._container=$(this.getContentHtml()),this._popPanel=new t.ICT.PopPanel(a),this._popPanel.show(),this._popPanel.on("popPanelRemove",function(){var a=this.menu.getContainer(),i=t.ICT.Func.WJAnalysis.getInstance();a.find(".submenu_wjanalysis  .submenu_li_fxpg").removeClass("active"),i.removeLayer(),t.ict.app.ictmap.OperateState.wjfx=!1,this.removeLayer(),this.data=null,this._popPanel=null,this._container=null},this)},getContentHtml:function(){var t=[];return t.push('<div class="fxpg_res_container">'),t.push('<div class="fxpg_res_table_container">'),t.push('<div class="thDiv">'),t.push("<table>"),t.push("<tr>"),t.push("<th>批号</th>"),t.push("<th>MMSI</th>"),t.push("<th>船名</th>"),t.push('<th style="width:20%">经度</th>'),t.push('<th style="width:20%">纬度</th>'),t.push('<th style="width:20%">更新时间</th>'),t.push("<th>风险等级</th>"),t.push("</tr>"),t.push("</table>"),t.push("</div>"),t.push('<div class="tbDiv"></div>'),t.push("</div>"),t.push('<div class="fxpg_res_page_container">'),t.push("</div>"),t.push("</div>"),t.join("")},removeLayer:function(){this.layer&&(this.map.removeLayer(this.layer),this.layer=null),this._layerGroup&&(this.map.removeLayer(this._layerGroup),this._layerGroup=null)},removePopPanel:function(){this._popPanel&&(this._popPanel.remove(),this._popPanel=null)},getData:function(t){var a=this.url,i={pageid:t,pagecount:this.pagecount};this.ajax.post(a,i,!0,this,function(t){this.ajaxCount++,1!==t.state?console.log(t.state.msg):(this.data=t,this.displayData())},function(t){this.ajaxCount++,console.error(t.responseText)})},getAllData:function(){var t=this.url,a={pageid:1,pagecount:800};this.ajax.post(t,a,!0,this,function(t){1!==t.state?console.log(t.state.msg):this.displayAllData(t)})},displayAllData:function(a){for(var i=a.msg.shipList,e=[],n=0,s=i.length;s>n;n++){var l=i[n],r=this.createShipMarker(l);e.push(r)}this._layerGroup=t.featureGroup(e).addTo(this.map)},displayData:function(){var a=this.data,i=a.msg.shipList;if(!(i.length<=0)){var e=[];e.push('<div class="mscrollbar"><table>');for(var n=0,s=i.length;s>n;n++){var l=i[n],r=this.convertDataDisplay(l);e.push("<tr data-id="+r.ti+">"),e.push("<td>"+r.ti+"</td>"),e.push("<td>"+r.msi+"</td>"),e.push("<td>"+(r.sn.replace(/@/g,"")||"未知")+"</td>"),e.push('<td style="width:20%">'+r.lon+"</td>"),e.push('<td style="width:20%">'+r.lat+"</td>"),e.push('<td style="width:20%">'+r.tim+"</td>"),e.push("<td>"+r.lev+"</td>"),e.push("</tr>")}e.push("</table></div>"),e=e.join("");var h=this;if(1==this.ajaxCount){var o=(a.msg.total,a.msg.max_page);this._container.find(".fxpg_res_table_container>.tbDiv").html(e),this._container.find(".mscrollbar").mCustomScrollbar({theme:"minimal-dark"}),this._container.find(".tbDiv table tr").on("click",function(t){h.clickRow(t)});var p={total:o,count:5,present:1};p.pageChange=function(t){h.getData(t)};var u=new t.ICT.Control.Paging(p),d=this._container.find(".fxpg_res_page_container")[0];u.addTo(d)}else this._container.find(".fxpg_res_table_container>.tbDiv").html(e),this._container.find(".mscrollbar").mCustomScrollbar({theme:"minimal-dark"}),this._container.find(".tbDiv table tr").on("click",function(t){h.clickRow(t)})}},clickRow:function(t){$(t.currentTarget).addClass("active").siblings().removeClass("active");var a=$(t.currentTarget).data("id"),i=this.getShipObjById(a);this.layer&&this.map.removeLayer(this.layer);var e=this.layer=this.createShipMarker(i);this.map.addLayer(e),e.openPopup(),this.map.panTo(e.getLatLng())},getShipObjById:function(t){for(var a=this.data.msg.shipList,i={},e=0,n=a.length;n>e;e++)if(a[e].ti==t){i=a[e];break}return i},convertDataDisplay:function(a){var i={};return i.msi=a.msi,i.ti=a.ti,i.lev=a.lev,i.sn=a.sn,i.lon=t.ict.app.util.tool.latlngTodfmStr(a.lon/6e5,"lng"),i.lat=t.ict.app.util.tool.latlngTodfmStr(a.lat/6e5,"lat"),i.tim=t.ict.app.util.dateTime.getTimeStrFromUnix(a.tim),i},createShipMarker:function(a){var i=t.latLng(a.lat/6e5,a.lon/6e5),e={icon:t.ICT.ShipIcon.ship7,data:a},n=t.marker(i,e),s=this.createPopPanel(a);return n.bindPopup(s),n},createPopPanel:function(a){var i={minWidth:200,maxWidth:300},e=t.popup(i),n=this.getPopPanelContent(a);return e.setContent(n),e},getPopPanelContent:function(t){var a=this.convertDataDisplay(t),i=[];return i.push('<div style="padding:5px;">'),i.push("<table>"),i.push("<tr><td>批号：</td><td>"+a.ti+"</td></tr>"),i.push("<tr><td>MMSI：</td><td>"+a.msi+"</td></tr>"),i.push("<tr><td>船名：</td><td>"+(a.sn.replace(/@/g,"")||"未知")+"</td></tr>"),i.push("<tr><td>经度：</td><td>"+a.lon+"</td></tr>"),i.push("<tr><td>纬度：</td><td>"+a.lat+"</td></tr>"),i.push("<tr><td>更新时间：</td><td>"+a.tim+"</td></tr>"),i.push("<tr><td>风险等级：</td><td>"+a.lev+"</td></tr>"),i.push("</table>"),i.push("</div>"),i.join("")}})})});