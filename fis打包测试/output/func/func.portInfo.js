define("func/portInfo",["leaflet","func/base","data/ajax"],function(t){t.ICT.Func.add("PortInfo",{Class:t.Class.extend({initialize:function(){this.config=Project_ParamConfig.PortConfig,this.ajax=new t.ICT.Ajax,this.ictmap=t.ict.app.ictmap,this.menu=t.ict.app.menu,this.menuid="ict_menu_main_gkxx",this._portList=[],this._portLayerList=[],this._portLayerGroup=null,this.isShow=!1},start:function(){this.ictmap.OperateState.port=!0,this._portLayerGroup?this.showPortLayer():this.getPortList(),this.menu.mainmenu.deactiveMenuExceptOne(this.menuid),this.menu.mainmenu.disableMenuExceptOne(this.menuid)},stop:function(){this.ictmap.OperateState.port=!1,this.hidePortLayer(),this.menu.mainmenu.deactiveMenu(this.menuid),this.menu.mainmenu.enableMenu()},getPortList:function(){var i=this.config.listUrl;this.ajax.get(i,null,!0,this,function(i){if(this.ictmap.OperateState.port!==!1)if(1!=i.state)console.error(i.msg.error),t.ict.app.util.dialog.error("错误提示","没有港口信息！");else{var r=i.msg.portlist;this._portList=[];for(var e=0,o=r.length;o>e;e++){var a=this.convertPortObj(r[e]);this._portList.push(a)}this.setPortLayerList(),this.addPortLayer()}},function(){})},convertPortObj:function(t){var i={};return i.id=t.id,i.cc=t.cc,i.lon=t.lon/6e5,i.lat=t.lat/6e5,i.name=t.name,i},setPortLayerList:function(){this._portLayerList=[];for(var t=0,i=this._portList.length;i>t;t++){var r=this._portList[t],e=this.createPortMarker(r);this._portLayerList.push(e)}},createPortMarker:function(i){var r=t.latLng(i.lat,i.lon),e=i.name,o=t.icon({iconUrl:"themes/images/shipIcons/port.png",iconSize:[20,20],iconAnchor:[16,16]}),a={icon:o,title:e,data:i},s=t.marker(r,a);return s.on("click",this._portClickEvt,this),s},_portClickEvt:function(i){var r=i.target,e={},o=this.config.infoUrl;e.id=r.options.data.id,this.ajax.post(o,e,!0,this,function(i){if(1!=i.state)console.error(i.msg.error);else{var e=i.msg.port;e=t.extend(e,r.options.data);var o={maxWidth:300,minWidth:300,className:"ict_portInfo_popupContainer"};r.bindPopup(this.getPopupContent(e),o).openPopup()}},function(){console.error("获取港口信息出错！")})},getPopupContent:function(i){var r=t.ict.app.util.tool.latlngTodfm(i.lat,"lat");r=r[3]+" "+r[0]+"°"+r[1]+"′"+r[2]+"″";var e=t.ict.app.util.tool.latlngTodfm(i.lon,"lng");e=e[3]+" "+e[0]+"°"+e[1]+"′"+e[2]+"″";var o=[];return o.push('<div class="portInfo_Div">'),o.push('<div class="portInfo_title">港口信息资料</div>'),o.push('<div class="portInfo_table_div">'),o.push("<table>"),o.push("<tr><td>港口ID:</td><td>"+i.id+"</td></tr>"),o.push("<tr><td>区域英文名:</td><td>"+i.area_name+"</td></tr>"),o.push("<tr><td>港口英文名:</td><td>"+i.port_name+"</td></tr>"),o.push("<tr><td>国家英文名:</td><td>"+i.country+"</td></tr>"),o.push("<tr><td>国家中文名:</td><td>"+i.country_chinese+"</td></tr>"),o.push("<tr><td>港口大小:</td><td>"+i.harbor_size+"</td></tr>"),o.push("<tr><td>港口类型:</td><td>"+i.harbor_type+"</td></tr>"),o.push("<tr><td>经度:</td><td>"+e+"</td></tr>"),o.push("<tr><td>纬度:</td><td>"+r+"</td></tr>"),o.push("<tr><td>国家代码:</td><td>"+i.cc+"</td></tr>"),o.push("</table>"),o.push("</div>"),o.push("</div>"),o.join("")},showPortLayer:function(){this._portLayerGroup&&(this._portLayerGroup.eachLayer(function(t){t.setOpacity&&t.setOpacity(1),t.setStyle&&t.setStyle({opacity:1,fillOpacity:1})},this),this.isShow=!0)},hidePortLayer:function(){this._portLayerGroup&&(this._portLayerGroup.eachLayer(function(t){t.setOpacity&&t.setOpacity(0),t.setStyle&&t.setStyle({opacity:0,fillOpacity:0})},this),this.isShow=!1)},addPortLayer:function(){this._portLayerGroup=new t.FeatureGroup(this._portLayerList),this.ictmap.map.addLayer(this._portLayerGroup),this.isShow=!0},removePortLayer:function(){this._portLayerGroup&&this.ictmap.map.removeLayer(this._portLayerGroup),this._portLayerGroup=null,this.isShow=!1}})})});