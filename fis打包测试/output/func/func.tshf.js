define("func/tshf",["leaflet","func/base","control/panel","control/draw","control/playback","plugins/mcscroll","plugins/my97DatePicker","data/ajax"],function(t){t.ICT.Func.add("TSHFMoreShip",{Class:t.Class.extend({initialize:function(){this.menu=t.ict.app.menu,this.menuid="ict_menu_main_tshf",this.config=Project_ParamConfig.tshfConfig,this.ictmap=t.ict.app.ictmap,this.dateUtil=t.ict.app.util.dateTime,this.ajax=new t.ICT.Ajax,this._areaPanel=null,this._targetPanel=null,this._drawPopPanel=null,this._layer=null,this._playback=null},start:function(){this.menu.submenu.has(this.menuid)||this.menu.submenu.add(this.menuid,this.getSubMenuHTML()),this.menu.submenu.show(this.menuid),this._initSubMenuEvts()},stop:function(){this._areaPanel&&this._areaPanel.remove(!1),this._targetPanel&&this._targetPanel.remove(!1),this._drawPopPanel&&this._drawPopPanel.remove(!1),this._layer&&this._layer.remove(),this._areaPanel=null,this._targetPanel=null,this._drawPopPanel=null,this._layer=null,this.ictmap.deactivate(),this.menu.submenu.destory(this.menuid),this.menu.mainmenu.deactiveMenu(this.menuid)},getSubMenuHTML:function(){var t=[];return t.push('<ul class="submenu_tshf">'),t.push('<li class="menu_item zdqy"><img src="themes/images/frame/menu_tshf_zdqy.png">&nbsp<label>指定区域</label></li>'),t.push('<li class="menu_item zdmb"><img src="themes/images/frame/menu_tshf_zdmb.png">&nbsp<label>指定目标</label></li>'),t.push("</ul>"),t.join("")},_initSubMenuEvts:function(){var t=this,e=this.menu.getContainer();e.find(".submenu_tshf .menu_item").on("click",function(e){e.stopPropagation();var a=$(this);a.hasClass("zdqy")?(t._areaPanel&&(t._areaPanel.remove(!1),t._areaPanel=null),t.areaPlayback(),t.menu.submenu.hide()):a.hasClass("zdmb")&&(t._targetPanel&&(t._targetPanel.remove(!1),t._targetPanel=null),t.targetPlayback(),t.menu.submenu.hide())})},areaPlayback:function(){var e={title:"指定区域",width:400,height:270,top:100,left:200,contentHTML:this.getAreaHtml()},a=this._areaPanel=new t.ICT.PopPanel(e);this._areaPanel.on("popPanelRemove",function(){this._areaPanel=null,this.stop()},this),a.show(),this._initAreaEvts(),this.ictmap.activate(t.ICT.MapMouseState.CIRCLE,this._drawCallback,null,this)},_initAreaEvts:function(){var e=this._areaPanel.getContainer().find(".areaPlaybackContainer"),a=e.find(".msg"),i=this;e.find("input[type=radio]").on("click",function(){i._layer&&i._layer.remove(),i._drawPopPanel&&i._drawPopPanel.remove();var e=$(this).val();"circle"==e?i.ictmap.activate(t.ICT.MapMouseState.CIRCLE,i._drawCallback,null,i):"rect"==e&&i.ictmap.activate(t.ICT.MapMouseState.RECTANGLE,i._drawCallback,null,i)}),e.find("input[type=text]").on("focus",function(){var t={readOnly:!0,dateFmt:"yyyy-MM-dd HH:mm",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0,maxDate:"%y-%M-%d %H:%m:%s"};WdatePicker(t)});var n=this.dateUtil.getNewDateTimeBeforHour(24);n=this.dateUtil.formatDateHM(n);var s=this.dateUtil.formatDateHM(new Date);e.find(".Wdate.startTime").val(n),e.find(".Wdate.endTime").val(s),e.find(".playbackbtn").on("click",function(){if(a.text(""),!i._layer)return void a.text("请绘制区域");var t=e.find(".startTime").val(),n=e.find(".endTime").val(),s=i.dateUtil.checkStrartEndTime(t+":00",n+":00",90);if(!s.result)return void a.text(s.msg);t=i.dateUtil.getCusUnixTime(t+":00"),n=i.dateUtil.getCusUnixTime(n+":00");var l={},r=i._layer.getBounds();l.ldlon=r.getSouthWest().lng,l.ldlat=r.getSouthWest().lat,l.rulon=r.getNorthEast().lng,l.rulat=r.getNorthEast().lat,l.mode=Project_ParamConfig.CurrentMode,l.startTime=t,l.endTime=n;var o=i.config.areaUrl;i.ajax.post(o,l,!0,i,function(t){1!=t.state?(console.error(t.msg.error),a.text("没有态势回放数据！")):this.playBack(t)},function(){})})},_drawCallback:function(e){var a=this._layer=e.layer,i=e.layerType;this._drawPopPanel&&this._drawPopPanel.remove(),this._drawPopPanel=new t.ICT.DrawPopPanel(a,i),this._drawPopPanel.on("popPanelRemove",function(){this._drawPopPanel=null},this),this._drawPopPanel.show(),this.ictmap.map.addLayer(a),this._layer=a,a.editing&&(a.editing.enable(),a.on("edit",function(){this._drawPopPanel.updateContent()},this))},targetPlayback:function(){var e={title:"指定目标",width:400,height:480,top:100,left:200,contentHTML:this.getTargetHtml()},a=this._targetPanel=new t.ICT.PopPanel(e);this._targetPanel.on("popPanelRemove",function(){this._targetPanel=null,this.config.playbackList=[],this.stop()},this),a.show(),this.updateList(),this._initTargetEvts()},_initTargetEvts:function(){var t=this._targetPanel.getContainer().find(".playbackTargetContainer"),e=t.find(".msg1"),a=t.find(".msg2"),i=this;t.find(".Wdate").on("focus",function(){var t={readOnly:!0,dateFmt:"yyyy-MM-dd HH:mm",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0,maxDate:"%y-%M-%d %H:%m:%s"};WdatePicker(t)});var n=this.dateUtil.getNewDateTimeBeforHour(24);n=this.dateUtil.formatDateHM(n);var s=this.dateUtil.formatDateHM(new Date);t.find(".Wdate.startTime").val(n),t.find(".Wdate.endTime").val(s),t.find(".addBtn").on("click",function(){var a=t.find(".shipIMO").val();if(e.text(""),""==a)return void e.text("请输入船舶批号！");var n=i.config.getShipByMMSIUrl,s={num:a,type:1,mode:Project_ParamConfig.CurrentMode,pageid:1,pagecount:1e3};i.ajax.post(n,s,!0,this,function(t){if(1!=t.state)console.error(t.msg.error),e.text("没有态势回放数据！");else{for(var a=t.msg.shipList||t.msg["shipList "],n=0,s=a.length;s>n;n++){var l=a[n],r={};r.id=l.num,r.shipname=l.sn,r.mmsi=l.mmsi,r.mode=l.mode,i.addTarget(r)}i.updateList()}})}),t.find(".deleteBtn").on("click",function(){var e=t.find(".listContent input:checked");e.each(function(){var t=$(this).parent().parent().data("key");i.deleteTarget(t)}),i.updateList()}),t.find("input.allchk").on("click",function(){var e=t.find(".listContent input[type=checkbox]");e.each(1==this.checked?function(){this.checked=!0}:function(){this.checked=!1})}),t.find(".playbackBtn").on("click",function(){a.text("");var e=t.find(".listContent input:checked"),n=[];if(e.each(function(){var t=$(this).parent().parent().data("key"),e=i.getTargetById(t);n.push(e)}),n.length<=0)return void a.text("请选择回放目标！");var s=t.find(".startTime").val(),l=t.find(".endTime").val(),r=i.dateUtil.checkStrartEndTime(s+":00",l+":00",90);if(!r.result)return void a.text(r.msg);s=i.dateUtil.getCusUnixTime(s+":00"),l=i.dateUtil.getCusUnixTime(l+":00");for(var o=i.config.moreshipUrl,h={},p=[],c=[],u=0;u<n.length;u++)p.push(n[u].mode),c.push(n[u].id);h.modeArr=p.join("~"),h.shipIdArr=c.join("~"),h.startTime=s,h.endTime=l,i.ajax.post(o,h,!0,i,function(t){1!=t.state?(console.error(t.msg.error),a.text("没有态势回放数据！")):this.playBack(t)},function(){})})},addTarget:function(t){if(0==this.config.playbackList.length)this.config.playbackList.push(t);else{isadd=!0;for(var e=0,a=this.config.playbackList.length;a>e;e++)if(this.config.playbackList[e].id==t.id){isadd=!1;break}isadd&&this.config.playbackList.push(t)}},deleteTarget:function(t){for(var e=this.config.playbackList,a=null,i=0,n=e.length;n>i;i++)if(e[i].id==t){a=i;break}null!==a&&e.splice(a,1)},getTargetById:function(t){for(var e=this.config.playbackList,a=null,i=0,n=e.length;n>i;i++)if(e[i].id==t){a=e[i];break}return a},updateList:function(){var t=this._targetPanel.getContainer().find(".playbackTargetContainer"),e=t.find(".listContent"),a=this.config.playbackList,i=[];i.push('<div class="mscroll"><table>');for(var n=0,s=a.length;s>n;n++){var l=a[n].id,r=a[n].shipname;i.push("<tr>"),i.push('<td class="mmsi" data-key="'+l+'"><label><input type="checkbox" checked>&nbsp&nbsp'+l+"</label></td><td>"+r+"</td>"),i.push("</tr>")}i.push("</table></div>"),i=i.join(""),e.html(i),e.find(".mscroll").mCustomScrollbar({theme:"minimal-dark"})},playBack:function(e){this._targetPanel&&this._targetPanel.remove(),this._areaPanel&&this._areaPanel.remove(),this.ictmap.OperateState.tshf=!0,this.menu.mainmenu.disableMenu(),this.ictmap.realtarget.hideRealTargetLayer(),this.config.playbackList=[],this._playback&&(this._playback.close(),this._playback=null);var a=this.ictmap.map.getZoom(),i=this.ictmap.map.getCenter();e=e.msg.shipList;var n=this;this._playback=new t.ICT.Control.PlayBack(e,null,function(){n._playback=null,n.ictmap.OperateState.tshf=!1,n.menu.mainmenu.enableMenu(),n.ictmap.map.setView(i,a),n.ictmap.realtarget.addRealTargetLayer()},null).show(this.ictmap.map)},getAreaHtml:function(){var t=[];return t.push('<div class="areaPlaybackContainer">'),t.push('<fieldset class="drawDiv">'),t.push("<legend>绘制区域：</legend> "),t.push('<form class="form-inline">'),t.push('<div class="form-group">'),t.push('<div class="radio"><label><input type="radio" name="drawRadio" value="circle" checked ><img src="themes/images/frame/ico_circle.png">圆形</label></div>'),t.push('<div class="radio"><label><input type="radio" name="drawRadio" value="rect"><img src="themes/images/frame/ico_rect.png">矩形</label></div>'),t.push("</div>"),t.push("</form>"),t.push("</fieldset>"),t.push('<div class="timeDiv">'),t.push('<label>时间:</label> <input type="text" class="Wdate startTime"> <label>&nbsp至&nbsp</label> <input type="text" class="Wdate endTime"> '),t.push("</div>"),t.push('<p class="msg"></p>'),t.push('<div class="btnDiv"><button type="button" class="btn playbackbtn">回放</button></div>'),t.push("</div>"),t.join("")},getTargetHtml:function(){var t=[];return t.push('<div class="playbackTargetContainer">'),t.push('  <div class="cbphDiv">'),t.push("    <label>船舶:</label>"),t.push('    <input type="text" class="shipIMO">'),t.push('    <button class="btn addBtn">添加</button>'),t.push("  </div>"),t.push('  <p class="msg msg1"></p>'),t.push('  <p class="cblb_txt">船舶列表:</p>'),t.push('  <div class="phlbDiv">'),t.push('    <label><input type="checkbox" class="allchk" checked>全选</label>'),t.push('    <button class="btn deleteBtn">删除</button>'),t.push("  </div>"),t.push('  <div class="shiplist">'),t.push("    <div><table><tr><td>批号</td><td>船舶名</td></tr></table></div>"),t.push("    <hr>"),t.push('    <div class="listContent"></div>'),t.push("  </div>"),t.push('  <p class="msg msg2"></p>'),t.push("  <hr>  "),t.push('  <div class="timeDiv"><label>时间:</label> <input type="text" class="Wdate startTime"> <label>&nbsp至&nbsp</label> <input type="text" class="Wdate endTime"></div>'),t.push('  <div class="btnDiv"><button type="button" class="btn playbackBtn">回放</button></div>'),t.push("</div>"),t.join("")}})}),t.ICT.Func.add("TSHFOneShip",{Class:t.Class.extend({initialize:function(){this.config=Project_ParamConfig.tshfConfig,this.ictmap=t.ict.app.ictmap,this.menu=t.ict.app.menu,this.dateUtil=t.ict.app.util.dateTime,this.ajax=new t.ICT.Ajax,this._popPanel=null,this._playback=null},start:function(){this._popPanel&&this._popPanel.remove(),this._initUi(),this._initEvts()},stop:function(){this._popPanel&&this._popPanel.remove(),this._playback&&this._playback.close()},_initUi:function(){var e={title:"态势回放",width:400,height:160,contentHTML:this.getContentHtml()},a=this._popPanel=new t.ICT.PopPanel(e);a.show()},getContentHtml:function(){var t=[];return t.push('<div class="tshf_oneship_container">'),t.push('<div class="timeDiv">'),t.push("<label>时间：</label>"),t.push('<input type="text" class="Wdate startTime">'),t.push("<label>&nbsp 至 &nbsp</label>"),t.push('<input type="text" class="Wdate endTime">'),t.push("</div>"),t.push('<p class="msg"></p>'),t.push('<div class="btnDiv">'),t.push('<button type="button" class="confirm">确定</button>'),t.push('<button type="button" class="cancel">取消</button>'),t.push("</div>"),t.push("</div>"),t.join("")},_initEvts:function(){var t=this._popPanel.getContainer().find(".tshf_oneship_container"),e=t.find(".msg"),a=this;this._popPanel.on("popPanelRemove",function(){this._popPanel=null},this),t.find(".Wdate").on("focus",function(){var t={readOnly:!0,dateFmt:"yyyy-MM-dd HH:mm",isShowClear:!1,startDate:"%y-%M-01 00:00:00",alwaysUseStartDate:!0,maxDate:"%y-%M-%d %H:%m:%s"};WdatePicker(t)});var i=this.dateUtil.getNewDateTimeBeforHour(24);i=this.dateUtil.formatDateHM(i);var n=this.dateUtil.formatDateHM(new Date);t.find(".Wdate.startTime").val(i),t.find(".Wdate.endTime").val(n),t.find(".confirm").on("click",function(){e.text("");var i=t.find(".startTime").val(),n=t.find(".endTime").val(),s=a.dateUtil.checkStrartEndTime(i+":00",n+":00",90);if(!s.result)return void e.text(s.msg);i=a.dateUtil.getCusUnixTime(i+":00"),n=a.dateUtil.getCusUnixTime(n+":00");var l=a.config.moreshipUrl,r=a.ictmap.realtarget.currentTarget.options.data.id,o=a.ictmap.realtarget.currentTarget.options.data.mode,h={modeArr:o,shipIdArr:r,startTime:i,endTime:n};a.ajax.post(l,h,!0,a,function(t){1!==t.state?(console.error(t.msg.error),e.text("没有态势回放数据！")):a.playBack(t)},function(){})}),t.find(".cancel").on("click",function(){a.stop()})},playBack:function(e){if(this._popPanel){this._popPanel.remove(),this.ictmap.OperateState.tshf=!0,this.menu.mainmenu.disableMenu(),this.ictmap.realtarget.hideRealTargetLayer(),this._playback&&(this._playback.close(),this._playback=null),e=e.msg.shipList;var a=this.ictmap.map.getZoom(),i=this.ictmap.map.getCenter(),n=this;this._playback=new t.ICT.Control.PlayBack(e,null,function(){n._playback=null,n.ictmap.OperateState.tshf=!1,n.menu.mainmenu.enableMenu(),n.ictmap.map.setView(i,a),n.ictmap.realtarget.addRealTargetLayer()},null).show(this.ictmap.map)}}})})});