define("func/wjAnalysis",["leaflet","esri/leaflet","func/base","func/fxpg","data/ajax","leaflet/rasterLayer"],function(e){e.ICT.Func.add("WJAnalysis",{Class:e.Class.extend({initialize:function(){this.menu=e.ict.app.menu,this.menuid="ict_menu_main_xwwj",this.ictmap=e.ict.app.ictmap,this.config=Project_ParamConfig.wjAnalysisConfig,this.ajax=new e.ICT.Ajax,this._layer=null,this._ssfblayergroup=null,this._activeForecateLayer=null,this.fxpgObj=null},start:function(){this.menu.submenu.has(this.menuid)&&this.menu.submenu.destory(this.menuid),this.menu.submenu.add(this.menuid,this.getSubMenuHTML()),this.menu.submenu.show(this.menuid),this._initSubMenuEvts(),this.menu.mainmenu.deactiveMenuExceptOne(this.menuid),this.menu.mainmenu.disableMenuExceptOne(this.menuid)},stop:function(){this.menu.submenu.hide(),this.removeLayer(),this.removeHdycLayer(),this.fxpgObj&&(this.fxpgObj.stop(),this.fxpgObj=null),this.menu.mainmenu.deactiveMenu(this.menuid),this.menu.mainmenu.enableMenu()},getSubMenuHTML:function(){var e=[];e.push('<div class="submenu_wjanalysis">'),e.push('<div class="submenu_wjanalysis_jtms">'),e.push('<label><img src="themes/images/frame/menu_xwfx_skfx.png">&nbsp&nbsp交通模式</label>'),e.push("<ul>"),e.push('<li class="submenu_li submenu_li_mdfb">'),e.push("<label>密度分布</label>"),e.push('<ul class="time_ul"  style="display:none;">'),e.push("<li>"),e.push("<label>时间:</label>"),e.push('<select name="mdfb_time">');for(var a=0,t=this.config.densityArr.length;t>a;a++){var s=this.config.densityArr[a];e.push('<option value="'+a+'">'+s.time+"</option>")}e.push("</select>"),e.push("</li>"),e.push("</ul>"),e.push("</li>"),e.push('<li class="submenu_li submenu_li_llfb">'),e.push("<label>流量分布</label>"),e.push('<ul class="time_ul" style="display:none;">'),e.push("<li>"),e.push("<label>时间:</label>"),e.push('<select name="llfb_time">');for(var a=0,t=this.config.flowArr.length;t>a;a++){var s=this.config.flowArr[a];e.push('<option value="'+a+'">'+s.time+"</option>")}return e.push("</select>"),e.push("</li>"),e.push("</ul>"),e.push("</li>"),e.push('<li class="submenu_li submenu_li_ssfb"><label>失事分布</label></li>'),e.push("</ul>"),e.push("</div>"),e.push('<div class="submenu_wjanalysis_ycpg">'),e.push('<label><img src="themes/images/frame/menu_xwfx_ycpg.png">&nbsp&nbsp预测评估</label>'),e.push("<ul>"),e.push('<li class="submenu_li submenu_li_hdyc"><label>活动预测</label></li>'),e.push('<li class="submenu_li submenu_li_fxpg"><label>风险评估</label></li>'),e.push("</ul>"),e.push("</div>"),e.push("</div>"),e.join("")},_initSubMenuEvts:function(){var a=this.menu.getContainer(),t=this;a.find(".submenu_wjanalysis .submenu_li_mdfb").on("click",function(){var e=$(this);e.hasClass("active")?(e.find(".time_ul").css("display","none"),e.removeClass("active"),t.removeLayer(),t.ictmap.realtarget.addRealTargetLayer(),t.ictmap.OperateState.wjfx=!1):(e.find(".time_ul").css("display","block"),e.addClass("active").siblings(":not(.submenu_li_hdyc)").removeClass("active"),e.siblings().find(".time_ul").css("display","none"),t.ictmap.realtarget.hideRealTargetLayer(),e.find("select").change(),t.ictmap.OperateState.wjfx=!0)}),a.find(".submenu_wjanalysis .submenu_li_llfb").on("click",function(){var e=$(this);e.hasClass("active")?(e.find(".time_ul").css("display","none"),e.removeClass("active"),t.removeLayer(),t.ictmap.realtarget.addRealTargetLayer(),t.ictmap.OperateState.wjfx=!1):(e.find(".time_ul").css("display","block"),e.addClass("active").siblings(":not(.submenu_li_hdyc)").removeClass("active"),e.siblings().find(".time_ul").css("display","none"),t.ictmap.realtarget.hideRealTargetLayer(),e.find("select").change(),t.ictmap.OperateState.wjfx=!0)}),a.find(".submenu_wjanalysis .submenu_li_ssfb").on("click",function(){var a=$(this);a.hasClass("active")?(a.removeClass("active"),t.removeLayer(),t.ictmap.realtarget.addRealTargetLayer(),t.ictmap.OperateState.wjfx=!1):(a.addClass("active").siblings(":not(.submenu_li_hdyc)").removeClass("active"),a.siblings().find(".time_ul").css("display","none"),t.ictmap.realtarget.hideRealTargetLayer(),t._ssfblayergroup=e.featureGroup(),t.ictmap.map.addLayer(t._ssfblayergroup),t.removeLayer(),t.addSsfbLayer(),t.ictmap.OperateState.wjfx=!0)}),a.find(".submenu_wjanalysis .submenu_li_hdyc").on("click",function(){var e=$(this);e.hasClass("active")?(e.removeClass("active"),t.removeHdycLayer(),t.ictmap.realtarget.addRealTargetLayer(),t.ictmap.OperateState.wjfx_hdyc=!1):(e.addClass("active"),t.ictmap.realtarget.hideRealTargetLayer(),t.addHdycLayer(),t.ictmap.OperateState.wjfx_hdyc=!0)}),a.find(".submenu_wjanalysis  .submenu_li_fxpg").on("click",function(){var s=$(this);t.fxpgObj=e.ICT.Func.FXPG.getInstance(),s.hasClass("active")?(s.removeClass("active"),t.removeLayer(),t.fxpgObj.stop(),t.ictmap.OperateState.wjfx=!1,t.ictmap.realtarget.addRealTargetLayer()):(s.addClass("active"),a.find(".submenu_wjanalysis_jtms .submenu_li").removeClass("active"),a.find(".submenu_wjanalysis_jtms .time_ul").css("display","none"),t.ictmap.realtarget.hideRealTargetLayer(),t.removeLayer(),t.ictmap.OperateState.wjfx=!0,t.fxpgObj.start())}),a.find(".submenu_wjanalysis .submenu_li > ul").on("click",function(e){e.stopPropagation()}),a.find(".submenu_wjanalysis .submenu_li >ul >li >select").on("change",function(){var e=$(this),a=e.attr("name"),s=parseInt(e.val()),i=null;"mdfb_time"===a?i=t.config.densityArr[s].url:"llfb_time"===a&&(i=t.config.flowArr[s].url),i&&t.updateLayer(i)})},createLayer:function(a){return e.esri.dynamicMapLayer({url:a})},updateLayer:function(e){this.removeLayer(),this._layer=this.createLayer(e),this.ictmap.map.addLayer(this._layer)},addSsfbLayer:function(){var e=this.config.accidentUrl;this.ajax.get(e,null,!0,this,function(e){1!==e.state?console.log(e.msg.error):this.displaySsfbData(e)})},displaySsfbData:function(a){var t=a.msg.list;if(!(t.length<=0))for(var s=0,i=t.length;i>s;s++){var l=t[s];this.convertData(l);var n=this.createCircleMarker(l);this._ssfblayergroup||(this._ssfblayergroup=e.featureGroup(),this.ictmap.map.addLayer(this._ssfblayergroup)),this._ssfblayergroup.addLayer(n)}},convertData:function(e){e.lon=parseFloat(e.lon/6e5),e.lat=parseFloat(e.lat/6e5)},createCircleMarker:function(a){var t=e.latLng(a.lat,a.lon),s={radius:4,stroke:!1,fill:!0,fillColor:"#f00",opacity:1,fillOpacity:1,data:a},i=e.circleMarker(t,s),l=this.createPopPanel(a);return i.bindPopup(l),i},createPopPanel:function(a){var t={minWidth:200,maxWidth:300},s=e.popup(t),i=this.getPopPanelContent(a);return s.setContent(i),s},getPopPanelContent:function(a){var t=e.ict.app.util.tool.latlngTodfmStr(a.lat,"lat"),s=e.ict.app.util.tool.latlngTodfmStr(a.lon,"lng"),i=e.ict.app.util.dateTime.getTimeStrFromUnix(a.tim/1e3),l=[];return l.push('<div style="padding:5px;">'),l.push("<table>"),l.push("<tr><td>ID号：</td><td>"+a.id+"</td></tr>"),l.push("<tr><td>经度：</td><td>"+s+"</td></tr>"),l.push("<tr><td>纬度：</td><td>"+t+"</td></tr>"),l.push("<tr><td>描述：</td><td>"+a.des||"</td></tr>"),l.push("<tr><td>危险等级：</td><td>"+a.dlev+"</td></tr>"),l.push("<tr><td>更新时间：</td><td>"+i+"</td></tr>"),l.push("<tr><td>事件类型：</td><td>"+this.getEvtType(a.itp)+"</td></tr>"),l.push("<tr><td>更新人：</td><td>"+a.uby||"</td></tr>"),l.push("</table>"),l.push("</div>"),l.join("")},getEvtType:function(e){var a="";return a=1==e?"翻船":2==e?"撞船":3==e?"海盗":e},addHdycLayer:function(){this.config.activeForecastUrl;this._activeForecateLayer=e.gridLayer.rasterLayer({opacity:.5,tileSize:64,minZoom:0,maxZoom:18,bounds:e.latLngBounds(e.latLng(-90,-180),e.latLng(90,180))}),this.ictmap.map.addLayer(this._activeForecateLayer)},removeHdycLayer:function(){this._activeForecateLayer&&(this.ictmap.map.removeLayer(this._activeForecateLayer),this._activeForecateLayer=null)},removeLayer:function(){this._layer&&(this.ictmap.map.removeLayer(this._layer),this._layer=null),this._ssfblayergroup&&(this.ictmap.map.removeLayer(this._ssfblayergroup),this._ssfblayergroup=null)}})})});