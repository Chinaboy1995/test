!function(t){var i;if("function"==typeof define&&define.amd)define(["leaflet"],t);else if("object"==typeof module&&"object"==typeof module.exports)i=require("leaflet"),module.exports=t(i);else{if("undefined"==typeof window.L)throw"Leaflet must be loaded first";t(window.L)}}(function(t){return t.Playback=t.Playback||{},t.Playback.Util=t.Class.extend({statics:{DateStr:function(t){return new Date(t).toDateString()},TimeStr:function(t){var i=new Date(t),e=i.getHours(),r=i.getMinutes(),n=i.getSeconds(),s=t/1e3,a=(s-Math.floor(s)).toFixed(2).slice(1),o="AM";return e>11&&(e%=12,o="PM"),0===e&&(e=12),10>r&&(r="0"+r),10>n&&(n="0"+n),e+":"+r+":"+n+a+" "+o},ParseGPX:function(t){for(var i={type:"Feature",geometry:{type:"MultiPoint",coordinates:[]},properties:{time:[],speed:[],altitude:[]},bbox:[]},e=$.parseXML(t),r=$(e).find("trkpt"),n=0,s=r.length;s>n;n++){var a=r[n],o=parseFloat(a.getAttribute("lat")),l=parseFloat(a.getAttribute("lon")),h=$(a).find("time").text(),c=$(a).find("ele").text(),d=new Date(h).getTime(),p=parseFloat(c),u=i.geometry.coordinates,_=i.properties,k=_.time,f=i.properties.altitude;u.push([l,o]),k.push(d),f.push(p)}return i},formatDateHM:function(t){var i=t.getFullYear(),e=t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1,r=t.getDate()<10?"0"+t.getDate():t.getDate(),n=t.getHours()<10?"0"+t.getHours():t.getHours(),s=t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes(),a=i+"-"+e+"-"+r+" "+n+":"+s;return a},drag:function(i,e){var r,n,s=!1,a=$("#"+e),o=$("#"+i),l="drag_"+t.stamp(o);a.data("drag","drag"),a.data("panel",l),o.addClass(l),this.initDrag||(this.initDrag=!0,$(document).mousedown(function(i){if(o=null,a=null,a=$(i.target),a=a.data("drag")?a:a.parent(),a.data("drag")&&"drag"==a.data("drag")&&a.data("panel")&&(s=!0,o=a.closest("."+a.data("panel")),0!=o.length)){o=o[0],r=i.clientX,n=i.clientY;var e=t.DomUtil.getPosition(o);return e&&(r-=e.x,n-=e.y),!1}}),$(document).mousemove(function(i){if(s&&o){var i=i||window.event,e=i.clientX-r,a=i.clientY-n,l=t.point(e,a);return t.DomUtil.setPosition(o,l),!1}}),$(document).mouseup(function(){s=!1,r=null,n=null,a=null,o=null,l=null}))},getTooltipText:function(t){var i=[];return i.push("<table>"),i.push("<tr><td>批号:</td><td>"+t.ph+"</td></tr>"),i.push("<tr><td>经度:</td><td>"+t.lon+"</td></tr>"),i.push("<tr><td>纬度:</td><td>"+t.lat+"</td></tr>"),i.push("<tr><td>时间:</td><td>"+t.time+"</td></tr>"),i.push("<tr><td>航向:</td><td>"+t.dir+"</td></tr>"),i.push("<tr><td>航艏向:</td><td>"+t.heading+"</td></tr>"),i.push("<tr><td>航速:</td><td>"+t.speed+"</td></tr>"),i.push("</table>"),i=i.join("")},getTooltipOptions:function(){return{offset:[0,0],direction:"top"}},createPopup:function(i){var e={className:"ict_control_playback_popupinfo"},r=[];r.push("<table>"),r.push("<tr><td>批号:</td><td>"+i.ph+"</td></tr>"),r.push("<tr><td>经度:</td><td>"+i.lon+"</td></tr>"),r.push("<tr><td>纬度:</td><td>"+i.lat+"</td></tr>"),r.push("<tr><td>时间:</td><td>"+i.time+"</td></tr>"),r.push("<tr><td>航向:</td><td>"+i.dir+"</td></tr>"),r.push("<tr><td>航艏向:</td><td>"+i.heading+"</td></tr>"),r.push("<tr><td>航速:</td><td>"+i.speed+"</td></tr>"),r.push("</table>"),r=r.join("");var n=t.popup(e);return n.setContent(r),n}}}),t.Playback.MoveableMarker=t.Marker.extend({initialize:function(i,e,r){var n=e.marker||{};jQuery.isFunction(n)&&(n=n(r)),t.Marker.prototype.initialize.call(this,i,n),this.popupContent="",this.feature=r,n.getPopup&&(this.popupContent=n.getPopup(r)),e.popups&&this.bindPopup(this.getPopupContent()+i.toString()),e.labels&&(this.bindLabel?this.bindLabel(this.getPopupContent(),{noHide:!0}):console.log("Label binding requires leaflet-label (https://github.com/Leaflet/Leaflet.label)"))},getPopupContent:function(){return""!==this.popupContent?"<b>"+this.popupContent+"</b><br/>":""},move:function(i,e){t.DomUtil.TRANSITION&&(this._icon&&(this._icon.style[t.DomUtil.TRANSITION]="all "+e+"ms linear",this._popup&&this._popup._wrapper&&(this._popup._wrapper.style[t.DomUtil.TRANSITION]="all "+e+"ms linear")),this._shadow&&(this._shadow.style[t.DomUtil.TRANSITION]="all "+e+"ms linear")),this.setLatLng(i),this._popup&&this._popup.setContent(this.getPopupContent()+this._latlng.toString())},_old__setPos:t.Marker.prototype._setPos,_updateImg:function(i,e,r){e=t.point(r).divideBy(2)._subtract(t.point(e));var n="";n+=" rotate("+this.options.iconAngle+"deg)",i.style[t.DomUtil.TRANSFORM]+=n,i.style.transformOrigin="50% 50%"},setIconAngle:function(t){this.options.iconAngle=t,this._map&&this.update()},_setPos:function(i){if(this._icon&&(this._icon.style[t.DomUtil.TRANSFORM]=""),this._shadow&&(this._shadow.style[t.DomUtil.TRANSFORM]=""),this._old__setPos.apply(this,[i]),this.options.iconAngle){var e,r=this.options.icon.options.iconAnchor,n=this.options.icon.options.iconSize;this._icon&&(e=this._icon,this._updateImg(e,r,n)),this._shadow&&(n=this.options.icon.options.shadowSize,e=this._shadow,this._updateImg(e,r,n))}}}),t.Playback.Track=t.Class.extend({initialize:function(t,i,e){this._map=t,this.options=e||{};var r=e.tickLen||250;this._staleTime=e.staleTime||36e5,this._fadeMarkersWhenStale=e.fadeMarkersWhenStale||!1,this._geoJSON=i,this._tickLen=r,this._ticks=[],this._marker=null,this._orientations=[];var n=i.properties.time;this._orientIcon=e.orientIcons;var s,a,o,l=i.geometry.coordinates,h=l[0],c=l[1],d=n[0],p=d,u=n[1],_=p%r;if(this._initTrackInfo(),1===n.length)return 0!==_&&(p+=r-_),this._ticks[p]=l[0],this._orientations[p]=0,this._startTime=p,void(this._endTime=p);for(0!==_?(a=r-_,o=a/(u-d),p+=a,this._ticks[p]=this._interpolatePoint(h,c,o),this._orientations[p]=this._directionOfPoint(h,c),s=this._orientations[p]):(this._ticks[p]=h,this._orientations[p]=this._directionOfPoint(h,c),s=this._orientations[p]),this._startTime=p,p+=r;u>p;)o=(p-d)/(u-d),this._ticks[p]=this._interpolatePoint(h,c,o),this._orientations[p]=this._directionOfPoint(h,c),s=this._orientations[p],p+=r;for(var k=1,f=l.length;f>k;k++)for(h=l[k],c=l[k+1],p=d=n[k],u=n[k+1],_=p%r,0!==_&&u?(a=r-_,o=a/(u-d),p+=a,this._ticks[p]=this._interpolatePoint(h,c,o),c?(this._orientations[p]=this._directionOfPoint(h,c),s=this._orientations[p]):this._orientations[p]=s):(this._ticks[p]=h,c?(this._orientations[p]=this._directionOfPoint(h,c),s=this._orientations[p]):this._orientations[p]=s),p+=r;u>p;)o=(p-d)/(u-d),u-d>e.maxInterpolationTime?(this._ticks[p]=h,c?(this._orientations[p]=this._directionOfPoint(h,c),s=this._orientations[p]):this._orientations[p]=s):(this._ticks[p]=this._interpolatePoint(h,c,o),c?(this._orientations[p]=this._directionOfPoint(h,c),s=this._orientations[p]):this._orientations[p]=s),p+=r;this._endTime=p-r,this._lastTick=this._ticks[this._endTime]},_interpolatePoint:function(t,i,e){try{var r=[i[0]-t[0],i[1]-t[1]],n=[r[0]*e,r[1]*e];return[t[0]+n[0],t[1]+n[1]]}catch(s){console.log("err: cant interpolate a point"),console.log(["start",t]),console.log(["end",i]),console.log(["ratio",e])}},_directionOfPoint:function(t,i){return this._getBearing(t[1],t[0],i[1],i[0])},_getBearing:function(t,i,e,r){t=this._radians(t),i=this._radians(i),e=this._radians(e),r=this._radians(r);var n=r-i,s=Math.log(Math.tan(e/2+Math.PI/4)/Math.tan(t/2+Math.PI/4));return Math.abs(n)>Math.PI&&(n=n>0?-(2*Math.PI-n):2*Math.PI+n),(this._degrees(Math.atan2(n,s))+360)%360},_radians:function(t){return t*(Math.PI/180)},_degrees:function(t){return t*(180/Math.PI)},getFirstTick:function(){return this._ticks[this._startTime]},getLastTick:function(){return this._ticks[this._endTime]},getStartTime:function(){return this._startTime},getEndTime:function(){return this._endTime},getTickMultiPoint:function(){for(var t=this.getStartTime(),i=this.getEndTime(),e=[],r=[];i>=t;)r.push(t),e.push(this.tick(t)),t+=this._tickLen;return{type:"Feature",geometry:{type:"MultiPoint",coordinates:e},properties:{time:r}}},trackPresentAtTick:function(t){return t>=this._startTime},trackStaleAtTick:function(t){return this._endTime+this._staleTime<=t},tick:function(t){return t>this._endTime&&(t=this._endTime),t<this._startTime&&(t=this._startTime),this._ticks[t]},courseAtTime:function(t){return t>this._endTime&&(t=this._endTime),t<this._startTime&&(t=this._startTime),this._orientations[t]},setMarker:function(i,e){var r=null;if(r=i?this.tick(i):this.getFirstTick()){var n=new t.LatLng(r[1],r[0]);this._marker=new t.Playback.MoveableMarker(n,e,this._geoJSON),e.mouseOverCallback&&this._marker.on("mouseover",e.mouseOverCallback),e.clickCallback&&this._marker.on("click",e.clickCallback),this._fadeMarkersWhenStale&&!this.trackPresentAtTick(i)&&this._marker.setOpacity(0)}return this._marker},moveMarker:function(i,e,r){if(this._marker){this._fadeMarkersWhenStale&&(this._marker.setOpacity(this.trackPresentAtTick(r)?1:0),this.trackStaleAtTick(r)&&this._marker.setOpacity(.25)),this._orientIcon&&this._marker.setIconAngle(this.courseAtTime(r));var n=this._marker.getLatLng();if(0!==e){var s=[[n.lat,n.lng],[i.lat,i.lng]],a=new t.Polyline(s,this.options.trackLineOptions);this._trackLineFeatureGroup.addLayer(a);var o=this._getOriginPoint(r);if(null!==o){var l=t.circleMarker(o,this.options.OriginCircleOptions);this._trackPointFeatureGroup.addLayer(l);var h=this._geoJSON.properties.info[r];l.bindTooltip(t.Playback.Util.getTooltipText(h),t.Playback.Util.getTooltipOptions())}}else{this._trackLineFeatureGroup.clearLayers();var c=this._getHistoryTracks(r);if(c.length>1){var d=new t.Polyline(c,this.options.trackLineOptions);this._trackLineFeatureGroup.addLayer(d)}this._trackPointFeatureGroup.clearLayers();var p=this._getOriginPoints(r);if(p&&p.length>0)for(var u=0;u<p.length;u++){var _=p[u];this._trackPointFeatureGroup.addLayer(_)}}this._marker.move(i,e)}},_initTrackInfo:function(){this._trackLineFeatureGroup=t.featureGroup().addTo(this._map),this._trackPointFeatureGroup=t.featureGroup().addTo(this._map)},clearTrackInfo:function(){this._trackLineFeatureGroup.clearLayers(),this._trackPointFeatureGroup.clearLayers(),this._trackLineFeatureGroup=null,this._trackPointFeatureGroup=null},_getHistoryTracks:function(i){var e=[];for(var r in this._ticks)if(this._ticks.hasOwnProperty(r)&&i>=r){var n=this._ticks[r][0],s=this._ticks[r][1];e.push(t.latLng(s,n))}return e},_getOriginPoints:function(i){var e=[];for(var r in this._ticks)if(this._ticks.hasOwnProperty(r)&&i>=r&&-1!==this._geoJSON.properties.time.indexOf(parseInt(r))){var n=this._ticks[r][0],s=this._ticks[r][1],a=t.latLng(s,n),o=t.circleMarker(a,this.options.OriginCircleOptions),l=this._geoJSON.properties.info[r];o.bindTooltip(t.Playback.Util.getTooltipText(l),t.Playback.Util.getTooltipOptions()),e.push(o)}return e},_getOriginPoint:function(i){var e=this._geoJSON.properties.time.indexOf(i);if(-1===e)return null;var r=this._ticks[this._geoJSON.properties.time[e]][0],n=this._ticks[this._geoJSON.properties.time[e]][1];return t.latLng(n,r)},getMarker:function(){return this._marker}}),t.Playback.TrackController=t.Class.extend({initialize:function(t,i,e){this.options=e||{},this._map=t,this._tracks=[],this.setTracks(i)},clearTracks:function(){for(;this._tracks.length>0;){var t=this._tracks.pop(),i=t.getMarker();i&&this._map.removeLayer(i),t.clearTrackInfo()}},setTracks:function(t){this.clearTracks(),this.addTracks(t)},addTracks:function(t){if(t)if(t instanceof Array)for(var i=0,e=t.length;e>i;i++)this.addTrack(t[i]);else this.addTrack(t)},addTrack:function(t,i){if(t){var e=t.setMarker(i,this.options);e&&(e.addTo(this._map),this._map.panTo(e.getLatLng()),this._tracks.push(t))}},tock:function(i,e){for(var r=0,n=this._tracks.length;n>r;r++){var s=this._tracks[r].tick(i),a=new t.LatLng(s[1],s[0]);this._tracks[r].moveMarker(a,e,i)}},getStartTime:function(){var t=0;if(this._tracks.length>0){t=this._tracks[0].getStartTime();for(var i=1,e=this._tracks.length;e>i;i++){var r=this._tracks[i].getStartTime();t>r&&(t=r)}}return t},getEndTime:function(){var t=0;if(this._tracks.length>0){t=this._tracks[0].getEndTime();for(var i=1,e=this._tracks.length;e>i;i++){var r=this._tracks[i].getEndTime();r>t&&(t=r)}}return t},getTracks:function(){return this._tracks}}),t.Playback.Clock=t.Class.extend({initialize:function(i,e,r){this._trackController=i,this._callbacksArry=[],e&&this.addCallback(e),t.setOptions(this,r),this._speed=this.options.speed,this.max_speed=this.options.Max_Speed,this._tickLen=this.options.tickLen,this._cursor=i.getStartTime(),this._transitionTime=this._tickLen/this._speed},_tick:function(t){return t._cursor>t._trackController.getEndTime()?(clearInterval(t._intervalID),void(t._intervalID=null)):(t._trackController.tock(t._cursor,t._transitionTime),t._callbacks(t._cursor),void(t._cursor+=t._tickLen))},_callbacks:function(t){for(var i=this._callbacksArry,e=0,r=i.length;r>e;e++)i[e](t)},addCallback:function(t){this._callbacksArry.push(t)},start:function(){this._intervalID||(this._intervalID=window.setInterval(this._tick,this._transitionTime,this))},stop:function(){this._intervalID&&(clearInterval(this._intervalID),this._intervalID=null)},getSpeed:function(){return this._speed},isPlaying:function(){return this._intervalID?!0:!1},setSpeed:function(t){this._speed=t,this._transitionTime=this._tickLen/t,this._intervalID&&(this.stop(),this.start())},quickSpeed:function(){this._speed=this._speed/this.options.speed>=this.max_speed?this._speed:this._speed+this.options.speed,this._transitionTime=this._tickLen/this._speed,this._intervalID&&(this.stop(),this.start())},slowSpeed:function(){this._speed=this._speed/this.options.speed<=1?this._speed:this._speed-this.options.speed,this._transitionTime=this._tickLen/this._speed,this._intervalID&&(this.stop(),this.start())},rePlaying:function(){this.isPlaying&&this.stop(),this.setCursor(this.getStartTime()),this.start()},setCursor:function(t){var i=parseInt(t);if(i){var e=i%this._tickLen;0!==e&&(i+=this._tickLen-e),this._cursor=i,this._trackController.tock(this._cursor,0),this._callbacks(this._cursor)}},getTime:function(){return this._cursor},getStartTime:function(){return this._trackController.getStartTime()},getEndTime:function(){return this._trackController.getEndTime()},getTickLen:function(){return this._tickLen}}),t.Playback.TracksLayer=t.Class.extend({initialize:function(i,e){var r=e.layer||{};jQuery.isFunction(r)&&(r=r(feature)),r.pointToLayer||(r.pointToLayer=function(i,e){return new t.CircleMarker(e,{radius:5})}),this.layer=new t.GeoJSON(null,r);var n={"GPS Tracks":this.layer};t.control.layers(null,n,{collapsed:!1}).addTo(i)},clearLayer:function(){for(var t in this.layer._layers)this.layer.removeLayer(this.layer._layers[t])},addLayer:function(t){this.layer.addData(t)}}),t.Playback.DateControl=t.Control.extend({options:{position:"bottomleft",dateFormatFn:t.Playback.Util.DateStr,timeFormatFn:t.Playback.Util.TimeStr},initialize:function(i,e){t.setOptions(this,e),this.playback=i},onAdd:function(){this._container=t.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var i=this,e=this.playback,r=e.getTime(),n=t.DomUtil.create("div","datetimeControl",this._container);return this._date=t.DomUtil.create("p","",n),this._time=t.DomUtil.create("p","",n),this._date.innerHTML=this.options.dateFormatFn(r),this._time.innerHTML=this.options.timeFormatFn(r),e.addCallback(function(t){i._date.innerHTML=i.options.dateFormatFn(t),i._time.innerHTML=i.options.timeFormatFn(t)}),this._container}}),t.Playback.PlayControl=t.Control.extend({options:{position:"bottomright"},initialize:function(t){this.playback=t},onAdd:function(){function i(){r.isPlaying()?(r.stop(),e._button.innerHTML="Play"):(r.start(),e._button.innerHTML="Stop")}this._container=t.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var e=this,r=this.playback;r.setSpeed(this.playback.options.speed);var n=t.DomUtil.create("div","playControl",this._container);this._button=t.DomUtil.create("button","",n),this._button.innerHTML="Play";var s=t.DomEvent.stopPropagation;return t.DomEvent.on(this._button,"click",s).on(this._button,"mousedown",s).on(this._button,"dblclick",s).on(this._button,"click",t.DomEvent.preventDefault).on(this._button,"click",i,this),this._container}}),t.Playback.SliderControl=t.Control.extend({options:{position:"bottomleft"},initialize:function(t){this.playback=t},onAdd:function(i){function e(t){var i=Number(t.target.value);n.setCursor(i)}this._container=t.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var r=this,n=this.playback;this._slider=t.DomUtil.create("input","slider",this._container),this._slider.type="range",this._slider.min=n.getStartTime(),this._slider.max=n.getEndTime(),this._slider.value=n.getTime();var s=t.DomEvent.stopPropagation;return t.DomEvent.on(this._slider,"click",s).on(this._slider,"mousedown",s).on(this._slider,"dblclick",s).on(this._slider,"click",t.DomEvent.preventDefault).on(this._slider,"change",e,this).on(this._slider,"mousemove",e,this),n.addCallback(function(t){r._slider.value=t}),i.on("playback:add_tracks",function(){r._slider.min=n.getStartTime(),r._slider.max=n.getEndTime(),r._slider.value=n.getTime()}),this._container}}),t.Playback=t.Playback.Clock.extend({statics:{MoveableMarker:t.Playback.MoveableMarker,Track:t.Playback.Track,TrackController:t.Playback.TrackController,Clock:t.Playback.Clock,Util:t.Playback.Util,TracksLayer:t.Playback.TracksLayer,PlayControl:t.Playback.PlayControl,DateControl:t.Playback.DateControl,SliderControl:t.Playback.SliderControl},options:{tickLen:250,speed:1,maxInterpolationTime:3e5,tracksLayer:!0,playControl:!1,dateControl:!1,sliderControl:!1,layer:{},marker:{}},initialize:function(i,e,r,n){t.setOptions(this,n),this._map=i,this._trackController=new t.Playback.TrackController(i,null,this.options),t.Playback.Clock.prototype.initialize.call(this,this._trackController,r,this.options),this.options.tracksLayer&&(this._tracksLayer=new t.Playback.TracksLayer(i,n)),this.setData(e),this.options.playControl&&(this.playControl=new t.Playback.PlayControl(this),this.playControl.addTo(i)),this.options.sliderControl&&(this.sliderControl=new t.Playback.SliderControl(this),this.sliderControl.addTo(i)),this.options.dateControl&&(this.dateControl=new t.Playback.DateControl(this,n),this.dateControl.addTo(i))},clearData:function(){this._trackController.clearTracks(),this._tracksLayer&&this._tracksLayer.clearLayer()},setData:function(t){this.clearData(),this.addData(t,this.getTime()),this.setCursor(this.getStartTime())},addData:function(i,e){if(i){if(i instanceof Array)for(var r=0,n=i.length;n>r;r++)this._trackController.addTrack(new t.Playback.Track(i[r],this.options),e);else if("FeatureCollection"==i.type)for(var r=0,n=i.features.length;n>r;r++)this._trackController.addTrack(new t.Playback.Track(i.features[r],this.options),e);else this._trackController.addTrack(new t.Playback.Track(i,this.options),e);this._map.fire("playback:set:data"),this.options.tracksLayer&&this._tracksLayer.addLayer(i)}},destroy:function(){this.clearData(),this.playControl&&this._map.removeControl(this.playControl),this.sliderControl&&this._map.removeControl(this.sliderControl),this.dateControl&&this._map.removeControl(this.dateControl)}}),t.Map.addInitHook(function(){this.options.playback&&(this.playback=new t.Playback(this))}),t.playback=function(i,e,r,n){return new t.Playback(i,e,r,n)},t.Playback});