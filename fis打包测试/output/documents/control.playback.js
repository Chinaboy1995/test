define("control/playback",["leaflet","jquery","leaflet/playback","plugins/rangeSlider"],function(t){t.ICT.Control=t.ICT.Control||{},t.ICT.Control.PlayBack=t.Class.extend({statics:{MoveableMarker:t.Playback.MoveableMarker,Track:t.Playback.Track,TrackController:t.Playback.TrackController,Clock:t.Playback.Clock,Util:t.Playback.Util,LAT_LON_TRANSFORM:6e5},options:{position:"topright",tickLen:1e3,speed:5e3,Max_Speed:10,maxInterpolationTime:864e5,orientIcons:!0,labels:!1,popups:!1,fadeMarkersWhenStale:!1,trackLineOptions:{weight:2,color:"#ef0300"},OriginCircleOptions:{stroke:!1,color:"#ef0300",fillColor:"#ef0300",fillOpacity:1,radius:4},layer:{},marker:{icon:t.icon({iconUrl:"themes/images/model/stateplayback/ship.png",iconSize:[12,25],iconAnchor:[5,12]})}},templateHtml:'<div class="playback-operation"><ul><li class="item item-start play" data-info="2" title="播放"><img src="themes/images/model/stateplayback/ico_play.png"></li><li class="item item-restart" data-info="3" title="重播"><img src="themes/images/model/stateplayback/ico_restart.png"></li><li class="item item-slow" data-info="4" title="减速"><img src="themes/images/model/stateplayback/ico_pre.png"></li><li class="item item-quick" data-info="5" title="加速"><img src="themes/images/model/stateplayback/ico_next.png"></li><li class="item item-speed"><span>X1</span></li><li class="item item-close" data-info="6" title="关闭"><img src="themes/images/model/stateplayback/ico_close.png"></li></ul></div><div class="playback-scrollbar"><ul><li class="item item-time"><span class="startTime"></span><span class="endTime"></span></li><li class="item item-scroll"><input type="range" class="range"></li><li class="item item-curtime"><span class="curTime"></span></li></ul></div>',initialize:function(e,a,i,l){t.setOptions(this,l),this._data=e,this._clockCallback=a,this._closeCallback=i},show:function(t){return t?(this._map=t,this.onAdd(t),this):void 0},close:function(){return t.DomUtil.remove(this._container),this.onRemove&&this.onRemove(this._map),this},onAdd:function(e){this._map=e,this._initUi(),this._initStyle(),this._trackController=new t.Playback.TrackController(e,null,this.options),this._playbackClock=new t.Playback.Clock(this._trackController,this._clockCallback,this.options);var a=this._dataTogeoJSON(this._data);return this.setData(a),this.setTime(),this._initEvts(),this._container},onRemove:function(){this.clearData(),"function"==typeof this._closeCallback&&this._closeCallback.call(this,this)},_initUi:function(){{var e="ict-control-playback",a=this._container=t.DomUtil.create("div",e);this.options}a.innerHTML=this.templateHtml,$("body").append($(a));var i="ict-control-playback"+t.stamp({}),l="playback-operation"+t.stamp({});$(a).attr("id",i),$(a).find(".playback-operation").attr("id",l),t.Playback.Util.drag(i,l)},_initStyle:function(){$(this._container)},_initEvts:function(){var e=this,a=$(e._container).find(".playback-operation>ul>li"),i=$(e._container).find(".playback-scrollbar input")[0];a.each(function(){t.DomEvent.on(this,"mousedown dbclick",t.DomEvent.stopPropagation).on(this,"click",t.DomEvent.stop).on(this,"click",e._btnClick,e)}),i.min=e.getStartTime(),i.max=e.getEndTime(),i.value=e.getTime(),t.DomEvent.on(i,"click mousedown dbclick",t.DomEvent.stopPropagation).on(i,"click",t.DomEvent.preventDefault).on(i,"change",e._onRangeChange,e).on(i,"mousemove",e._onRangeChange,e),e.addCallback(function(t){i.value=t;var e=parseInt((t-i.min)/(i.max-i.min)*100);$(i).css("background-size",e+"% 100%")})},_btnClick:function(t){var e=$(t.currentTarget),a=$(t.currentTarget).data("info");switch(a){case 1:break;case 2:e.hasClass("play")?(e.removeClass("play"),e.find("img").attr("src","themes/images/model/stateplayback/ico_push.png"),e.attr("title","暂停"),this.start()):(e.addClass("play"),e.find("img").attr("src","themes/images/model/stateplayback/ico_play.png"),e.attr("title","播放"),this.stop());break;case 3:this.rePlaying();break;case 4:this.slowSpeed();break;case 5:this.quickSpeed();break;case 6:this.close()}},_onRangeChange:function(t){var e=Number(t.target.value);this.setCursor(e)},setTime:function(){var e=$(this._container),a=t.Playback.Util.formatDateHM(new Date(this.getStartTime())),i=t.Playback.Util.formatDateHM(new Date(this.getEndTime())),l=t.Playback.Util.formatDateHM(new Date(this.getTime()));e.find(".playback-scrollbar .startTime").text(a),e.find(".playback-scrollbar .endTime").text(i),e.find(".playback-scrollbar .curTime").text(l);var o=this;this.addCallback(function(){l=t.Playback.Util.formatDateHM(new Date(o.getTime())),e.find(".playback-scrollbar .curTime").text(l)})},setData:function(t){this.clearData(),this.addData(t,this.getTime()),this.setCursor(this.getStartTime())},addData:function(e,a){var i=this._map;if(e){if(e instanceof Array)for(var l=0,o=e.length;o>l;l++)this._trackController.addTrack(new t.Playback.Track(i,e[l],this.options),a);else this._trackController.addTrack(new t.Playback.Track(i,e,this.options),a);this._map.fire("playback:set:data")}},clearData:function(){this._trackController.clearTracks()},addCallback:function(t){this._playbackClock.addCallback(t)},start:function(){this._playbackClock.start()},stop:function(){this._playbackClock.stop()},quickSpeed:function(){this._playbackClock.quickSpeed();var t=this._playbackClock.getSpeed();$(this._container).find(".playback-operation .item-speed span").text("X"+parseInt(t/this.options.speed))},slowSpeed:function(){this._playbackClock.slowSpeed();var t=this._playbackClock.getSpeed();$(this._container).find(".playback-operation .item-speed span").text("X"+parseInt(t/this.options.speed))},rePlaying:function(){this._playbackClock.rePlaying()},getSpeed:function(){return this._playbackClock.getSpeed()},isPlaying:function(){return this._playbackClock.isPlaying()},setSpeed:function(t){this._playbackClock.setSpeed(t)},setCursor:function(t){this._playbackClock.setCursor(t)},getTime:function(){return this._playbackClock.getTime()},getStartTime:function(){return this._playbackClock.getStartTime()},getEndTime:function(){return this._playbackClock.getEndTime()},getTickLen:function(){return this._playbackClock.getTickLen()},_dataTogeoJSON:function(e){if(e.length<=0)return void console.log("error:dataToGeoJSON error!");for(var a=[],i=0,l=e.length;l>i;i++){var o=e[i].num,s={};s.type="Feature",s.geometry={},s.properties={},s.geometry.type="MultiPoint",s.geometry.coordinates=[],s.properties.title="title"+i,s.properties.time=[],s.properties.speed=[],s.properties.info={};for(var n=0,c=e[i].posList.length;c>n;n++){var r=e[i].posList[n],p=r.lo/t.ICT.Control.PlayBack.LAT_LON_TRANSFORM,k=r.la/t.ICT.Control.PlayBack.LAT_LON_TRANSFORM,m=t.ict.app.util.tool.latlngTodfmStr(p,"lng"),h=t.ict.app.util.tool.latlngTodfmStr(k,"lat"),d=t.ict.app.util.dateTime.getTimeStrFromUnix(r.ti);s.properties.info[1e3*r.ti]={lat:h,lon:m,time:d,ph:o,dir:(r.co/10).toFixed(1)+"°",heading:r.he+"°",speed:r.sp/10+"节"},s.geometry.coordinates.push([p,k]),s.properties.time.push(1e3*r.ti),s.properties.speed.push(1e3)}a.push(s)}return a}})});